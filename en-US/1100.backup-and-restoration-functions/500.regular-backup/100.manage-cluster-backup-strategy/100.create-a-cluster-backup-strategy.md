# Create a cluster-level backup strategy

A cluster-level backup strategy takes effect only for tenants that do not have a tenant-level backup strategy. You can configure a cluster-level backup strategy for the unified management of those tenants.

## Prerequisites

If the OceanBase Database version of the cluster is V4.0.0 or later, ensure that the following requirements are met before you configure second backup:

* To enable second backup, which is disabled by default, change the value of the `ocp.backup.advanced-secondary-backup.enable` parameter to `true` in **System Parameters**.
* The storage media for both regular backup and second backup is Alibaba Cloud Object Storage Service (OSS).
* The retention period of second backup files is shorter than that of regular backup files.
* If the backup scheduling cycle is weekly, the retention period of second backup files must be longer than or equal to 7 days. If the backup scheduling cycle is monthly, the retention period of second backup files must be longer than or equal to 30 days.
* Regular backup files and second backup files cannot be stored in the same bucket. In addition, you cannot specify a custom storage path for second backup files.
* The AccessKey pair of a regular backup job must have the permissions for cross-region replication. Otherwise, the job cannot be scheduled. If the job fails to be executed, you can retry the job after you configure the permissions.
* The bucket for regular backup cannot be configured with cross-region replication rules. Otherwise, the job cannot be scheduled. If the job fails to be executed, you can retry the job after you delete these rules.
* If the destination of a second backup job is an independently deployed OSS bucket, you must configure the `cloudName` and `cloudLocation` fields of the OSS bucket in **System Parameters**. The corresponding parameters are `ocp.backup.advanced-secondary-backup.target-cloud-name` and `ocp.backup.advanced-secondary-backup.target-cloud-location`.

## Procedure

You can create a cluster-level backup strategy by using the following three methods:

* **Method 1:**

    Log on to the OceanBase Cloud Platform (OCP) console. In the left-side navigation pane, choose **Backup & Recovery** > **Backups**. In the upper-right corner of the page that appears, click **Create Backup Strategy** and select **Create Cluster-level Backup Strategy** from the drop-down list.

* **Method 2:**

    Log on to the OCP console and go to the **Overview** page of a cluster. In the left-side navigation pane, click **Backup & Recovery**. Then, click **Create Cluster-level Backup Strategy**.

* **Method 3:**

    Log on to the OCP console and go to the **Overview** page of a tenant. In the left-side navigation pane, click **Backup & Recovery**. Then, click **Create Cluster-level Backup Strategy**.

<main id="notice" type='explain'>
<h4>Note</h4>
<p>You can use <b>Method 3</b> only if the tenant and the cluster do not have a backup strategy. </p>
</main>

The procedure of **Method 1** is described as follows:

1. In the left-side navigation pane, choose **Backup and Recovery** **\>** **Backups**.

2. On the **Backups** page, move the pointer over **New Backup Strategy** and select **Create Cluster-level Backup Strategy**.

3. Select the cluster to back up from the drop-down list.

   * For a cluster of a version earlier than OceanBase Database V2.2.60, **logical backup** is used.

   * For a cluster of OceanBase Database V2.2.60 and later, **physical backup** is used.

4. Specify the following storage configuration parameters and click **Test**.

   * For logical backup, select the storage configuration configured during service installation. For more information, see [Install a service](../../1000.manage-backup-and-recovery-service/200.installation-services.md).

     If no backup service is installed, you must first install the backup service. For more information, see [Install a service](../../1000.manage-backup-and-recovery-service/200.installation-services.md).

   * For physical backup, you can configure a custom configuration or select an existing configuration. If you choose to configure a custom configuration, configure the parameters based on the following tables. If you choose to select an existing configuration, click **Select Existing Configuration**. Then, the system automatically populates the following parameters.

      <main id="notice" type='notice'>
      <h4>Notice</h4>
      <p>If the native Alibaba Cloud OSS or Cloud Object Storage (COS) storage type is available, we recommend that you select the OSS or COS storage type. </p>
      </main>

      * **File**: your local file storage system. Generally, Network File System (NFS) is used.

         | Parameter | Description |
         |--------|-------|
         |  Storage Directory  | The directory in which the backup files are stored on the storage service.  |
         |  Alert Threshold for Backup Storage Capacity  | The threshold for backup storage capacity alerts. Default value: `80%`.  |

      * **OSS**: Alibaba Cloud OSS, which is supported only in OceanBase Database V2.2.76 and later.

         | Parameter | Description |
         |--------|-------|
         |  Storage Directory  | The directory in which the backup files are stored on the storage service.  |
         |  Domain  | The domain name for accessing the files stored in Alibaba Cloud OSS, such as `oss-cn-hangzhou.aliyuncs.com`.  |
         |  User  | The user for accessing the files stored in Alibaba Cloud OSS.  |
         |  AccessKey Pair  | The AccessKey pair for accessing the files stored in Alibaba Cloud OSS.  |

      * **COS**: Tencent Cloud COS, which is supported only in OceanBase Database V2.2.76 and later but earlier than V4.0, and in OceanBase Database V4.2.1 and later.

         | Parameter | Description |
         |--------|-------|
         |  Storage Directory  | The directory in which the backup files are stored on the storage service.  |
         |  Domain  | The domain name for accessing the files stored in the COS bucket, such as `cos.ap-beijing.myqcloud.com`.  |
         |  Resource Identity (APPID)  | The unique resource identifier at the user dimension when you access the COS bucket as a developer. You can obtain the APPID on the API key management page of COS.  |
         |  Project ID  | The ID of the developer. You can obtain the ID on the API key management page of COS.  |
         |  Project Key  | The key of the developer. You can obtain the key on the API key management page of COS.  |

      * **OBS**: Huawei Cloud Object Storage Service (OBS), which is supported only in OceanBase Database V3.2.3.2-105000062022090916 and later but earlier than V4.0.0.0.

         | Parameter | Description |
         |--------|-------|
         |  Storage Directory  | The directory in which the backup files are stored on the storage service.  |
         |  Domain  | The domain name for accessing the files stored in the Huawei Cloud OBS bucket, such as `obs.cn-north-4.myhuaweicloud.com`.  |

      * **S3**: object storage services that support the AWS Simple Storage Service (S3) protocol, such as the native Amazon Web Services (AWS) S3, Huawei Cloud OBS, Tianyi Cloud OBS, and Google Cloud Storage (GCS). These object storage services are supported only in OceanBase Database V4.2.1-BP7, V4.2.3-BP1, and later. For more information about Amazon S3-compatible object storage services, see [Amazon S3 protocol](../../../2100.appendix/900.s3-overview.md).

         | Parameter | Description |
         |--------|-------|
         |  Storage Directory  | The directory in which the backup files are stored on the storage service.  |
         |  Domain  | The domain name for accessing the files stored in the S3 bucket, such as `s3.us-west-2.amazonaws.com`.  |
         |  AK  | The AccessKey ID of the S3 bucket.  |
         |  SK  | The AccessKey secret of the S3 bucket.  |
         |  Region  | The region of the S3 bucket.  |

         <main id="notice" type='notice'>
         <h4>Notice</h4>
         <p>The <b>Region</b> parameter is required when Amazon S3 is used, and is not required when Huawei Cloud OBS, Tianyi Cloud OBS, or GCS is used. </p>
         </main>

5. Specify parameters in the **Scheduling Settings** section.

   * Scheduling Cycle: If you set the scheduling cycle to **Months**, you can select at most 10 days.

   * If you need to perform physical backup, log backup must be enabled.

   ![Image 37](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/422-en/create-cluster-backup-strategy-2.png)

6. Schedule the cleanup of expired backup files.

   ![Image 52](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/422-en/create-cluster-backup-strategy-3.png)

7. Specify alert thresholds. You can specify the timeout threshold for data backup jobs, alert threshold for log backup delays, and alert threshold for the number of days without successful data backup. After you set a threshold, an alert is triggered when the threshold is reached.

   ![Image 53](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/422-en/create-cluster-backup-strategy-4.png)

8. (Optional) Configure second backup settings.

   To back up the data backup files and log backup files to another directory, turn on **Second Backup**.

   1. Configure storage settings for second backup.

   2. Configure scheduling settings for second backup.

9. Click **Submit**.
