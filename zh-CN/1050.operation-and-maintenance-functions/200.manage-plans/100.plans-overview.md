# 预案管理概述

预案管理是指对 OceanBase 数据库可能发生的突发事件、危机制定并实施一系列应急预案的过程。预案管理旨在提前建立故障应对方案，用户可以更好地应对突发事件、危机，减少损失并保障数据库稳定运行，以降低潜在风险对用户业务造成的影响，提高 OceanBase 数据库的整体应急能力。

当前预案管理模块包含 2 个模块：

1. **预案模板**

    本模块提供 10+ 预案，包括自动拉起 OBServer、扩容租户 CPU/内存以及刷新单条 SQL 的 PlanCache 等。用户可以根据业务场景以及资源使用等情况进行模板定制化，如扩容方案以及是否启用预案模板等。

2. **预案执行模块**

    本模块提供预案执行信息、回滚方案或对应的 SQL 详情等，同时对关闭自动启用的模板，支持用户手工执行。预案管理可以帮助用户建立 OceanBase 数据库的应急管理机制和运维规范，为业务连续性、稳定性提供更智能化的保障。

## 预案模板

OCP 内置多种针对不同场景的预案模板，模板参数说明如下。

|  参数  |  取值  |  说明  |
|--------|---------|--------|
|  预案名称  |  预案的唯一标识  |   -  |
|  预案类型  |  <li>**在 OBServer 进程异常退出时重新拉起**</li><li>**在租户内存超限后对租户内存扩容**</li><li>**在租户 CPU 超限后对租户 CPU 扩容**</li><li>**OBProxy 连接数不足时自动扩充配置**</li><li>**刷新该 SQL 的 PlanCache**（内含 4 种预案模板，包括：**SQL 性能下降时刷新本 SQL 的 PlanCache**、**SQL 执行计划恶化时刷新本 SQL 的 PlanCache**、**SQL 执行计划恶化时刷新本 SQL 的 PlanCache** 和 **SQL性能下降时刷新本 SQL 的 PlanCache**）</li>在仲裁服务的 OBServer 进程异常退出时重新拉起</li><li>**重启 ocp-agent**（内含 2 种预案模板，包括 **主机心跳检测失败时尝试重启 ocp-agent** 和 **agent 服务不可用时尝试重启 ocp-agent**</li>  |  如下预案类型不支持查看回滚方案：<ul><li>**在 OBServer 进程异常退出时重新拉起**</li><li>**刷新该 SQL 的 PlanCache**</li><li>**在仲裁服务的 OBServer 进程异常退出时重新拉起**</li><li>**主机心跳检测失败时尝试重启 ocp-agent**</li></ul> |
|  对象类型  |  包括 **集群**、**OB 服务**、**OBProxy 集群**、**OBProxy 服务**、**仲裁服务**、**租户**、**主机** 6 种对象类型，对象类型与预案类型一一对应 | 对象类型与预案类型的具体对应关系如下：<ul><li>OB 服务：**在 OBServer 进程异常退出时重新拉起**</li><li>OBProxy 集群：**OBProxy 连接数不足时自动扩充配置**</li><li>仲裁服务：**在仲裁服务的 OBServer 进程异常退出时重新拉起**</li><li>租户：<ul><li>**在租户内存超限后对租户内容扩容**</li><li>**在租户 CPU 超限后对租户 CPU 扩容**</li><li>**刷新该 SQL 的 PlanCache**</li></ul></li><li>主机：**重启 ocp-agent**</li></ul>  |
|  对象  |  与对象类型一致的特定对象，支持选择全部对象以及排除对应对象  |  <li>OceanBase 集群：支持选择特定的集群和选择全部集群。若选择全部集群，则预案支持的对象范围为当前全部集群和未来新建集群</li><li>OceanBase 租户：支持选择特定的 OceanBase 集群中的特定租户和全部租户。若选择全部租户，则预案支持的对象范围为当前全部集群和未来新建集群内的所有租户。</li><li>OBProxy 集群：支持选择特定的 OBProxy 集群和全部 OBProxy 集群。若选择全部 OBProxy 集群，则预案支持的对象范围为当前全部集群和未来新建集群。</li><li>SQL 相关：支持选择特定的 OceanBase 集群中的特定租户和全部租户。若选择全部租户，则预案支持的对象范围为当前全部集群和未来新建集群内的所有租户。</li>  |
|  对象  |  预案操作的对象  |  支持过滤  |
|  触发规则  |  触发预案的规则  |  不同预案的触发规则如下：<li>**在 OBServer 进程异常退出时重新拉起**：`os_observer_not_exist`</li><li>**在租户内存超限后对租户内容扩容**：`tenant_memstore_percent_over_threshold`</li><li>**在租户 CPU 超限后对租户 CPU 扩容**：`ob_tenant_request_queue_over_threshold`</li><li>**OBProxy 连接数不足时自动扩充配置**：`obproxy_client_connections_usage_over_threshold`</li><li>**SQL 性能下降时刷新本 SQL 的 PlanCache**：`oas_anomaly_sql_from_anomaly_event_analysis_perf_degradation`</li><li>**SQL 执行计划恶化时刷新本 SQL 的 PlanCache**：`oas_anomaly_sql_from_anomaly_event_analysis_plan_changed`</li><li>**SQL 执行计划恶化时刷新本 SQL 的 PlanCache**：`oas_anomaly_sql_from_sql_inspection_perf_degradation`</li><li>**SQL 性能下降时刷新本 SQL 的 PlanCache**：`oas_anomaly_sql_from_sql_inspection_plan_changed`</li><li>**在仲裁服务的 OBServer 进程异常退出时重新拉起**：`arbitration_service_unavailable`</li><li>**agent 服务不可用时尝试重启 ocp-agent**：`obagent_dead`</li><li>**主机心跳检测失败时尝试重启 ocp-agent**：`host_unavailable`</li>  |
| 扩容比例  | 设置扩容比例（部分预案使用） |  支持扩容比例的预案类型，范围：10%~100%<li>租户 CPU 扩容：20%（默认）<li>租户内存扩容：20%（默认）<li>OBProxy 扩容：20%（默认）|
|  是否自动执行  |  默认关闭  |  预案类型： OBServer/仲裁服务 异常自动拉起 默认自动执行  |

## 预案执行列表

**预案执行列表** 页面主要展示了已经执行过的预案，您可在此页面查看预案的详细执行信息，包括 预案名称、对象、事件类型、事件名称、执行事件段 和 状态，并支持对已执行预案进行如下运维操作。

* 查看任务
* 查看回滚方案
* 查看 SQL

## 预案类型说明

