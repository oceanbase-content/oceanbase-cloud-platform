# 诊断事务

OCP 提供大事务的基本信息和关联的 SQL，您可通过事务诊断功能对大事务进行识别和分析。

## 前提条件

仅 OceanBase V3.2.x 以上版本支持对 **单个参与者已生成日志量** 字段进行展示。

## 操作步骤

您可通过以下两个入口对事务进行诊断：

* 入口一：

    1. 登录 OCP。
    2. 在左侧导航栏单击 **自治服务**，选择需要查看的集群，进入集群 **实时诊断** 页面。
    3. 单击 **事务诊断** 页签。

* 入口二：

    1. 登录 OCP。
    2. 进入租户 **概览** 页面，在左侧导航栏单击 **事务诊断**。

以下步骤以 **入口一** 为例。

1. 登录 OCP。

2. 在左侧导航栏中，单击 **自治服务**。

3. 在 **集群详情** 区域，单击需要查看的集群名称。

4. 进入 **实时诊断** 的 **事务诊断**页签中，对事务进行筛选。

      * 系统默认展示 **已执行时间大于 500ms** 或 **单个参与者已生成日志量大于超过 0.5MB** 的事务列表，您可以选择其他范围的执行时间和日志生成量对事务进行查询。

      * 打开 **自动刷新** 开关，页面将按照刷新频率刷新事务列表。可以选择的刷新频率为 5 秒、10 秒、30 秒，默认为每 10 秒刷新一次。

    ![Image 56](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E4%BA%8B%E5%8A%A1%E8%AF%8A%E6%96%AD.png)
  
* 查看事务列表。

  您可通过事务状态分类来查看不同的事务列表，事务状态包括长事务、悬挂事务和其他事务。事务列表中展示当前运行中的大事务，展示列包括事务 Hash 、会话 ID 、事务类型、已影响行数、已执行时间、单个参与者已生成日志量的最大值。展示列说明如下表所示。
  
  |    展示列    |                                   说明                                    |
  |-----------|-------------------------------------------------------------------------|
  | 事务 Hash   | 事务的唯一标识。                                                                |
  | 会话 ID     | 会话的唯一，您可在 [管理租户会话](../300.manage-session/100.manage-tenant-sessions.md) 中查看该会话。 |
  | 事务类型      | 事务的类型，包括 XA 事务、分布式事务和普通事务。<blockquote>**说明**</br>当 OceanBase 为 V4.0 及以上版本时，暂不支持 XA 事务类型。</blockquote>                                                |
  | 已影响行数     | 该事务中所有SQL执行过程中的affected_row                                             |
  | 已执行时间（ms） | 事务已经执行的时间。                                                              |

  ![Image 109](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E4%BA%8B%E5%8A%A1%E5%88%97%E8%A1%A8.png)
  
* 查看事务详情。

  单击具体事务 Hash，进入 **事务详情** 页面。可在此页面查看事务基本信息、执行信息和已执行 SQL 详情。
  * 单击右上角 **关闭事务** ，可关闭该事务会话。仅支持关闭 **长事务** 列表中的普通事务和分布式事务。

  * 单击 **耗时最长 SQL** 文本、 **影响行数最多 SQL** 文本或 **已执行 SQL 详情** 中的 SQL 文本，可查看该 SQL 详情。

  ![Image 108](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E4%BA%8B%E5%8A%A1%E8%AF%A6%E6%83%85.png)
  
* 关闭事务。

  在 **事务列表** 页面，选择需要关闭的事务，单击操作栏的 **关闭事务** 按钮；或勾选多个事务，单击 **批量关闭事务** 。在对话框中单击 **确定** ，即可结束所选中事务的会话。结束会话会导致事务回滚，会话连接也会终止。
  
   <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>仅支持 <strong>长事务</strong> 列表中的普通事务和分布式事务。</p>
   </main>
