# 事务概览

数据库中的大事务会长时间执有某些资源不释放、或者占用过多的系统资源，从而导致系统处于一种不稳定的状态，影响系统正常提供高效服务。在日常工作中，您需要重点关注这些事务，特别是长事务和悬挂事务。

您可通过以下两个入口查看事务相关信息：

* **入口一**：登录 OCP，在左侧导航栏单击 **自治服务**，选择需要查看的集群，进入集群 **实时诊断** 页面，单击 **事务诊断** 页签。

* **入口二**：登录 OCP，进入租户 **概览** 页面，在左侧导航栏单击 **事务诊断**。

<main id="notice" type='notice'>
<h4>功能适用性</h4>
<p>社区版暂不支持自治服务，该功能需要通过 <b>入口二</b> 访问查看。</p>
</main>

## 概述

OCP 会以定期采样的方式获取 OceanBase 集群上活跃事务的状态，并基于采样的数据来判断是否存在大事务。对于大事务的定义，满足下列条件之一，则可判断为大事务：

* 单个参与者的日志产生量大于 0.5MB，事务参与者为数据库中 partition 的 leader。

* 事务已执行时间大于 500ms。

## 事务分类

在 OCP 中，事务划分如下：

* 按照事务类型，大事务可分为普通事务、分布式事务和 XA 事务。

  * 普通事务：即单机事务。

  * 分布式事务：即多机事务。

  * XA 事务：XA（eXtended Architecture）是指由 X/Open 组织提出的分布式交易处理的规范，分布式事务也称为 XA 事务。在 OCP 中, XA 事务特指跨数据库集群的分布式事务。
  
   <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>当 OceanBase 为 V4.0 及以上版本时，暂不支持 XA 事务类型。</p>
   </main>

* 按照事务的状态，大事务可分为长事务、悬挂事务和其他事务。

  * 长事务：事务开始后，执行时间超过 60s 不提交的事务称为长事务。OCP 中长事务的告警阈值为 30s 。

  * 悬挂事务：事务已经进入提交阶段，但是由于某种原因，导致事务无法提交成功，称为悬挂事务。OCP 中悬挂事务的告警阈值为 10min 。

  * 其他事务：除长事务及悬挂事务之外的为其他事务。

## 前提条件

* 当通过 **入口一** 查看事务相关信息时，请确保当前登录 OCP 的用户具备如下权限：

  * **集群只读** 或 **租户只读** 资源权限。
  * 自治服务 **实时诊断** 菜单权限。

* 当通过 **入口二** 查看事务相关信息时，请确保当前登录 OCP 的用户具备如下权限：

  * **集群只读** 或 **租户只读** 资源权限。
  * 租户 **事务诊断** 菜单权限。

## 查看事务诊断列表

可在事务诊断页面查看当前运行中的大事务列表，列表信息包括 **事务 Hash 、会话 ID 、事务类型（普通事务/ XA 事务/分布式事务）、已影响行数、已执行时间** 和 **单个参与者已生成日志量的最大值** 。

![Image 107](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6410999461/p430416.png)

## 关闭事务

OCP 支持对运行中的大事务进行关闭。结束事务的会话后，事务会回滚，会话连接会终止。

## 查看事务详情

支持查看大事务详情信息，包括 **基本信息** 、 **执行信息** 和 **已执行 SQL 详情** 。基于事务详情，您可以获得事务的模型，判断事务中耗时或者耗资源的具体原因，从而帮助您来解决问题、提升系统服务效率。

单击已执行 SQL 详情的 SQL 文本，可跳转至 SQL 详情页查看该 SQL 详情。

![Image 108](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/6410999461/p430417.png)
