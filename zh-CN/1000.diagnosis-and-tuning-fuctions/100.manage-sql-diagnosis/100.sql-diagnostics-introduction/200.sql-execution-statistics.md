# SQL 执行统计信息

SQL 诊断提供多方面的指标统计信息，可通过自定义列筛选所需的 SQL 执行信息。

自定义列中的指标可分为四种：时间模型指标、常用指标、基础信息指标和执行计划指标。

## 时间模型

OBServer 在收到用户的 SQL 请求后，会通过打点的方式来记录 SQL 在 OceanBase 内部各个阶段运转时所消耗的时间，一个本地执行单 SQL 语句运行时时间模型图如下：

![image.png](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/410/sql%E8%AF%8A%E6%96%AD%E6%B5%81%E7%A8%8B%E5%9B%BE.png)

如上图所示：

* 网络传输时间：SQL 从客户端发出到 OBServer 接收到之间的时间消耗，主要指网络上的时间消耗。
* 网络入队时间:  OBServer 接收到请求到 SQL 进入OBServer 处理队列之间的时间消耗，主要指 OBServer 网络架构层的时间消耗。
* 队列时间：SQL 进入处理队列到 SQL 出队之间的时间消耗， 是 SQL 执行的排队时间消耗，当 OBServer 处理资源不够的时候，SQL 就会在队列中进行等待，直到有足够的处理资源。
* 解析时间：SQL 出队后开始处理到物理执行计划开始执行之间的时间消耗，主要指 OceanBase SQL 引擎生成执行计划或者获取执行计划的时间消耗。
* 执行时间：SQL 执行计划开始执行到执行结束的时间消耗。其中执行时间可以分为 CPU 时间和等待时间，等待时间按照等待类型分为应用等待、并发等待、IO 等待和调度等待 4 类。

OCP 提供的 SQL 执行时间模型如下：

| **指标** | **描述** |
| --- | --- |
| 总响应时间 | 指定时间段内 SQL 的总响应 时间（ms） |
| 最大响应时间 | 指定时间段内 SQL 的最大响应时间（ms） |
| 最大 CPU 时间 | 指定时间段内 SQL 最大占用 CPU 时间（ms） |
| 网络传输时间 | 指定时间段内 SQL 的平均网络传输时间（ms） |
| 网络入队时间 | 指定时间段内 SQL 的平均网络入队时间（ms） |
| 排队时间 | 指定时间段内 SQL 的平均排队时间（ms） |
| 解析时间 | 指定时间段内 SQL 的平均语法解析时间（ms） |
| 等待时间 | 指定时间段内 SQL 平均等待时间（ms） |
| 总等待时间 | 指定时间段内 SQL 的总等待时间（ms） |
| 应用等待时间 | 指定时间段内 Application 事件的平均等待时间（ms） |
| 并发等待时间 | 指定时间段内执行计划的 Concurrency 事件的平均等待时间（ms） |
| IO 等待时间 | 指定时间段内 UserIO 事件的平均等待时间（ms） |
| 调度等待时间 | 指定时间段内 Schedule 事件的平均等待时间（ms） |

## 常用指标

| **指标** | **描述** |
| --- | --- |
| 最长等待事件 | 指定时间段内累计耗时最长的等待事件 |
| 执行次数 | 指定时间段内 SQL 的总执行次数 |
| 每秒执行次数 | 指定时间段内 SQL 的平均每秒执行次数 |
| 平均响应时间 | 指定时间段内 SQL 的平均响应时间（ms），响应时间指客户端从发送 SQL 请求，到获取 SQL 结果的总时间。 |
| 报错次数 | 指定时间段内 SQL 执行出错次数 |
| 平均 CPU 时间 | 指定时间段内 SQL 平均占用 CPU 时间（ms） |
| 计划生成时间 | 指定时间段内 SQL 计划生成的平均时间（ms） |
| 执行时间 | 指定时间段内 SQL 计划执行的平均时间（ms） |
| 未命中计划 | 指定时间段内 SQL 计划未命中率 |

## 基础信息

| **指标** | **描述** |
| --- | --- |
| SQL 文本 | SQL 文本 |
| SQL ID | SQL 模版 |
| 服务器 | OceanBase 服务器的地址 |
| 数据库 | SQL 访问的数据库 |
| 用户 | 执行 SQL 的用户 |
| SQL 类型 | SQL 类型，包括：SELECT、INSERT、UPDATE、DELETE 等 |
| 内部 SQL | 由 OceanBase 发起的 SQL 为内部 SQL |

## 执行计划

| **指标** | **描述** |
| --- | --- |
| 更新行数 | 指定时间段内 SQL 平均更新表记录行数 |
| 返回行数 | 指定时间段内 SQL 的平均返回行数 |
| 访问分区数 | 指定时间段内 SQL 平均访问的分区数 |
| 错误占比 | 指定时间段内 SQL 的错误占比（%） |
| 超时错误 | 指定时间段内 SQL 发生超时错误（4012）的总次数 |
| 内存不足错误 | 指定时间段内 SQL 发生内存不足错误（4013）的总次数 |
| 语法错误 | 指定时间段内 SQL 发生语法解析错误（5001）的总次数 |
| 键值冲突错误 | 指定时间段内 SQL 发生键值冲突错误（5024）的总次数 |
| 数据超长错误 | 指定时间段内 SQL 发生数据超长错误（5167）的总次数 |
| 未知列错误 | 指定时间段内 SQL 发生未知列错误（5217）的总次数 |
| 事务回滚错误 | 指定时间段内 SQL 发生事务回滚错误（6002）的总次数 |
| 等待次数 | 指定时间段内 SQL 的平均等待次数 |
| RPC次数 | 指定时间段内 SQL 平均发送 RPC 次数 |
| 本地计划占比 | 指定时间段内 SQL 的本地计划占比（%） |
| 远程计划占比 | 指定时间段内 SQL 的远程计划占比（%） |
| 分布式计划占比 | 指定时间段内 SQL 的分布式计划占比（%） |
| RPC 请求 | 指定时间段内 SQL 的平均执行RPC请求次数 |
| Row Cache Hit | 指定时间段内 SQL 执行过程中 Row Cache 命中次数总数 |
| Bloom filter Cache Hit | 指定时间段内 SQL 执行过程中 Bloom filter Cache 命中次数总数 |
| Block Cache Hit | 指定时间段内 SQL 执行过程中 Block Cache 命中次数总数 |
| Block Index Cache Hit | 指定时间段内 SQL 执行过程中 Block Index Cache 命中次数总数 |
| 物理读 | 指定时间段内 SQL 的平均物理读次数 |
| 重试次数 | 指定时间段内 SQL 的总重试次数 |
| 表扫描 | 指定时间段内 SQL 的平均表扫描次数 |
| 强一致性事务占比 | 指定时间段内 SQL 强一致性事务占比（%） |
| 弱一致性事务占比 | 指定时间段内 SQL 的弱一致性事务占比（%） |
| 内存读行数 | 指定时间段内 SQL 平均 Memstore 读行数 |
| 物理读行数 | 指定时间段内 SQL 平均读 Ssstore 行数 |
