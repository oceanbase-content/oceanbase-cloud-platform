ob_tenant_large_trans_exist OB 租户存在大事务
===========================================================

告警描述
-------------------------

在 OCP 中，大事务的定义包括以下2个条件，满足任意一个条件即为大事务：

1. 单个参与者的日志量超过 0.5MB（OceanBase V3.2 及以上版本支持）。

2. 事务执行时长超过 500ms。

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>该告警仅限于日志量超过 0.5MB 的告警，事务执行时长按慢 SQL 来告警。</p>
  </main>

告警原理
-------------------------

下表列出了该告警监控逻辑中涉及的关键参数。

|  参数   |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      值                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|-------|----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 监控指标  | trans_max_log_size_mb                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 数据来源  | <li> OceanBase 版本为 V3.2 及以上时，采集 SQL： ```select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) QUERY_TIMEOUT(%d)*/ a.tenant_id, b.tenant_id as tenant_id_xa, a.trans_id, `partition`, floor(ctx_create_time) as ctx_create_time, session_id, participants, trans_type, part_trans_action, sql_no, log_size_byte from (select tenant_id, svr_ip, trans_id, `partition`, unix_timestamp(ctx_create_time) *1000000 as ctx_create_time, session_id, participants, (pending_log_size + flushed_log_size) as log_size_byte, trans_type, part_trans_action, sql_no from __all_virtual_trans_stat where svr_ip = ? and svr_port = ? and is_exiting != 1) a left join __all_virtual_global_transaction b on a.tenant_id = b.tenant_id and a.trans_id = b.trans_id ```   </li><li> 事务日志量： ```select max(log_size_byte)/1024/1024 as trans_max_log_size_mb from ob_hist_trans_stat``` </li>   |
| 采集指标  | log_size_byte                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 监控表达式 | max(log_size_byte)/1024/1024                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 采集周期  | 60 秒                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>系统参数 <code>ocp.alarm.datasource.trans-min-log-size-mb</code> 决定事务日志量大于多少 MB 的事务会产生告警，故告警阈值需不低于该系统参数的设定值，默认为 0.5MB。</p>
  </main>

规则信息
-------------------------

|         监控指标          | 默认阈值（单位：MB） | 监控指标来源 | 检测周期 | 消除周期 |
|-----------------------|-------------|--------|------|------|
| trans_max_log_size_mb | 0.5         | 租户指标   | 60 秒 | 5 分钟 |

告警信息
-------------------------

|   告警触发方式   | 告警等级 | 范围 |
|------------|------|----|
| 基于监控指标的表达式 | 严重   | 租户 |

告警模板
-------------------------

* 告警概述

  * 模板：\${alarm_target} \${alarm_name}

  * 样例：ob_cluster=obcluster-1:tenant_name=orac2:trans_hash={hash:10801753558860391353, inc:59202486, addr:"xxx.xxx.xxx.xxx:2882", t:1646993121179509} OB 租户存在大事务

* 告警详情

  * 模板：集群：\${ob_cluster_name}，租户：\${tenant_name} 存在大事务。会话 ID：\${session_id}，事务 ID 为：\${trans_hash}，事务最大日志量：\${trans_max_log_size_mb} MB，事务类型：\${trans_type}，事务创建时间：\${trans_create_time}

  * 样例：集群：obcluster-1，租户：orac2 存在长事务。会话 ID：3221635048，事务 ID：{hash:10801753558860391353, inc:59202486, addr:"xxx.xxx.xxx.xxx:2882", t:1646993121179509}，事务最大日志量：0.7MB，事务类型：distribute，事务创建时间：2022-03-11T18:05:21.184+08:00

对系统的影响
---------------------------

大事务可能导致系统内存问题。比如备机上回放是乱序的，当内存不足需要发生转储时，需要将后提交但先回放的事务搬迁走。搬迁需要内存，事务回放到转储点也需要内存，而此时两者都不能完成，从而造成内存爆；同理 leader 上执行事务的时候也可能遇到类似问题。

可能原因
-------------------------

单个事务中提交了过多数据。

处理办法
-------------------------

1. 使用 OCP 租户管理中的事务诊断功能，判断大事务发生的原因，并做响应处理。

2. 若是业务预期的大事务，需要确认是否可以对业务进行拆分，尽量避免大事务或将告警阈值调高。
