# 跨 OCP 集群创建主备租户

OCP 支持在不同的集群中创建关联的主备租户，当主机房发生故障并进行 OCP 集群切换时，您可将备租户容灾切换为主租户，组成租户级的物理备库高可用解决方案，对外提供数据库服务。

在 OCP 中，被其他 OCP 集群管理的租户被称为 **远程租户**，当远程租户在当前 OCP 集群的页面上进行展示时，会被打上 **远程** 标签。

<main id="notice" type='notice'>
<h4>功能适用性</h4>
<p>该内容仅适用于 OCP 企业版，OCP 社区版不提供此功能。</p>
</main>

## 前提条件

* 请确保当前登录 OCP 的用户具备如下权限：

  * **集群维护** 或 **租户维护** 资源权限。
  * 租户 **概览** 菜单权限。

* 仅支持 OceanBase V4.2 及以上版本配置租户级主备库。

* 待创建备租户的集群状态为运行中。

* 多集群模式的主备 OCP 集群已创建。

* 当前登录用户具备系统管理员角色、OCP 租户管理员角色或其他拥有管理该集群权限的角色。

* （可选）已参考 [租户参数模板管理](../../700.tenant-functions/1500.manage-tenant-parameter-templates.md) 创建好参数模板。

  需要创建多个参数配置相同的租户时，可提前建好参数模板，这样可避免重复配置相同的一批参数。
  
* 在选择为租户开启仲裁服务前，您需要确认以下信息：

  * 租户所属集群已添加仲裁服务且仲裁服务处于 **RUNNING** 状态。

  * 待开启仲裁服务的租户的 Locality 为 2F（F：即全功能副本） 或 4F。

  * 仲裁服务所在主机的剩余资源满足资源要求。

    该资源要求可在系统参数中根据实际情况进行修改，需修改的参数如下，操作详情可参见 [修改系统参数](../../700.tenant-functions/1600.manage-tenant-parameters/200.modify-a-tenant-parameter.md)。

    * `ocp.arbitration.min.remain.disk.size`：开启租户仲裁时，仲裁服务主机 CLOG 盘剩余最小值，单位为 MB。数据格式 (a,b) 表示租户副本分别为 2F、4F 时的值，默认为 [12,24]。
    * `ocp.arbitration.max.cpu.used.percentage`：开启租户仲裁时，仲裁服务主机最大 CPU 使用率，单位为 %，默认值为 90。
    * `ocp.arbitration.max.memory.used.percentage`：开启租户仲裁时，仲裁服务主机最大内存使用率，单位为 %，默认值为 90。

## 操作步骤

您可参考如下步骤，在当前 OCP 中为其他 OCP 管理的租户创建备租户。

1. 登录 OCP。

2. 单击左侧导航栏的 **租户** ，进入 **租户** 页面。

3. 在页面右上角单击 **新建租户** 。

   ![16310527](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E6%96%B0%E5%BB%BA%E7%A7%9F%E6%88%B7.png)

4. 填写 **基础信息** 。

   需要完成的基本设置及其相关说明如下表所示。

   |    **配置**     | **描述** |
   |---------------|---|
   | **租户类型**        | 选择 **备租户**。 |
   | **主租户所属 OCP**        | 选择其它 OCP 集群。 |
   | **主租户所属集群**        | 选择远程主租户的所属集群。 |
   | **主租户**        | 选择备租户所属的主租户。 |
   | **备租户所属集群**      | 选择备租户的所属本地集群。 |
   | **备租户名称**       | 备租户名称，支持英文大小写字母、数字和下划线，长度为 2\~64 个字符。 |
   | **主备同步方式**   | 支持 **基于网络** 和 **基于归档** 两种同步方式。 <ul><li> **基于网络** 是通过 OBServer 之间的 RPC 网络同步日志，备租户可直接通过 `ip + port` 读取主租户的日志。系统默认选择 **基于网络** 方式作为主备租户同步方式。   </li><li> **基于归档** 是通过共享存储同步日志，主租户将日志写到网络磁盘或者 OSS 存储中，备租户从共享存储中读取数据。**基于归档** 方式需保证当前租户已开启归档，否则将无法基于归档同步数据。关于 OCP 开启归档的相关信息，可参考 [立即进行租户备份](../../1100.backup-and-restoration-functions/400.backup-now/200.back-up-tenant-now.md)。   </li></ul><main id="notice" type='explain'><h4>说明</h4><p>当已存在主备关系（级联、一对多），默认选择已使用的主备同步方式且不支持修改。</p></main> |

   ![10](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E6%96%B0%E5%BB%BA%E5%A4%87%E7%A7%9F%E6%88%B7.png)

5. 填写 **恢复备租户设置**，设置备份集信息。您可根据不同的使用场景，选择是否为备租户设置独立的存储目录。

   <main id="notice" type='explain'><h4>说明</h4><p>当 <b>主备同步方式</b> 为 <b>基于网络</b> 且主租户 Redo 日志完整时，无需额外配置 <b>恢复备租户设置</b>。同时，您也可单击 <b>使用备份集恢复</b> 配置备份集信息，选择通过备份集来恢复备租户。</p></main>

   * **设置独立的存储目录**

      适用场景：当您未使用 OCP 的租户备份功能且已黑屏备份了租户，或您已将主租户的外部备份文件复制到一个共享存储中、想通过该备份文件恢复一个备租户。

      |    **配置**     | **描述** |
      |---------------|---|
      | **备份集存储类型**        | 选择备份文件存储介质，取值范围：<ul><li> File：本地文件存储，一般为 NFS。   </li><li> OSS：阿里云 OSS 对象存储，仅 OceanBase V2.2.76 及以上版本支持。 </li><li>COS：腾讯云 COS 对象存储，仅 OceanBase V2.2.76 及以上、V4.0.0 以下版本或者 OceanBase V4.2.1 及以上版本支持。</li></ul> |
      | **数据备份目录**        | 填写备份文件在当前介质上的数据存储目录。 |
      | **日志备份目录**      | 填写备份文件在当前介质上的日志存储目录。 |
      | **访问域名**       | 填写备份集云存储端的域名。<ul><li>当 **备份集存储类型** 为 **OSS** 时，填写备份文件阿里云存储端的域名。支持在域名后添加端口号，如：`oss.ap-shanghai.myqcloud.com:8080`。</li><li>当 **备份集存储类型** 选择 **COS** 时展示，填写访问腾讯云 COS 存储桶中对象的域名。如：`cos.ap-beijing.myqcloud.com`。</li></ul> |
      | **访问用户**       | 当 **备份集存储类型** 为 **OSS** 时展示，填写访问阿里云存储端的用户。|
      | **资源标识（APPID）**       | 当 **备份集存储类型** 为 **COS** 时展示，开发者访问 COS 服务时拥有的用户维度唯一资源标识，可在对应产品的 API 密钥管理页面获取。 |
      | **项目身份识别 ID**       | 当 **备份集存储类型** 为 **COS** 时展示，填写开发者拥有的项目身份识别 ID，可在对应产品的 API 密钥管理页面获取。 |
      | **访问密钥**       | 当 **备份集存储类型** 为 **OSS** 或 **COS** 时展示，填写访问阿里云或腾讯云存储端的用户密钥。 |

   * **不设置独立存储目录**

      适用场景：已在 OCP 中通过备份恢复功能对租户进行了备份。当您选择不设置独立存储目录时，系统会自动填写存储目录的相关配置信息，且不支持修改。

      |    **配置**     | **描述** |
      |---------------|---|
      | **备份目录**        | 当 **备份集存储类型** 为 **File** 或 **COS** 时展示，填写备份文件在当前介质上的备份存储目录。 |
      | **存储目录**       | 当 **备份集存储类型** 为 **OSS** 时展示，填写备份文件在当前介质上的存储目录。 |
      | **访问域名**       | 填写备份集云存储端的域名。<ul><li>当 **备份集存储类型** 为 **OSS** 时，填写备份文件阿里云存储端的域名。支持在域名后添加端口号，如：`oss.ap-shanghai.myqcloud.com:8080`。</li><li>当 **备份集存储类型** 选择 **COS** 时，填写访问腾讯云 COS 存储桶中对象的域名。如：`cos.ap-beijing.myqcloud.com`。</li></ul> |

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E6%81%A2%E5%A4%8D%E5%A4%87%E7%A7%9F%E6%88%B7%E8%AE%BE%E7%BD%AE.png)

   单击 **备份集校验**，系统将对当前的备份集的目录备租户所在集群是否可访问、以及当前的备份集的最大可恢复时间与当前主租户的时间是否存在日志缺失进行检查。若检查不通过，您可通过提示信息进行排查和处理。

6. 填写 **备租户副本设置** 。

   <main id="notice" type='explain'>
   <h4>说明</h4>
   <p>备租户的副本规格建议与主租户保持一致。</p>
   </main>

   默认系统会根据所选集群的 Zone 信息显示可配置的 Zone 列表，对于无需做副本分布的 Zone，可以单击后面的删除按钮删除该 Zone 条目。需要配置的 Zone 信息及其相关说明如下表所示。

   |     **配置**     |  **描述**    |
   |----------------|------|
   | **副本类型**       | 有以下选项： <ul><li>全能型副本</li><li> 只读型副本   </li></ul>    请选择多个全功能副本类型，确保全功能副本类型占多数派。 <main id="notice" type='explain'><h4>说明</h4><p>当租户所属数据库为 **单机集中式** 时，副本类型仅支持 **全能型副本**。</p></main>  |
   | **Unit 规格**    | OCP 内置了一套 Unit 规格，请参考 [OCP 资源单元规格列表](../../700.tenant-functions/500.ocp-resource-unit-specifications.md) 进行选择，或者您也可以在列表下方单击 **新增规格** 按钮新增自定义规格。<main id="notice" type='notice'><h4>注意</h4><p><ul><li>建议为全能型副本设置相同的 Unit 规格与数量，否则可能造成性能或稳定性问题。</li><li>当租户所属集群为 V4.0.0 及以上版本时：<ul><li>CPU 不支持配置 1C 以下规格。</li><li>集群默认对内存规格的最小值进行限制，您可通过 <code>__min_full_resource_pool_memory</code> 参数来进行调整。以 V4.1.0 的集群为例，参数修改步骤可参考 <a href="https://www.oceanbase.com/docs/common-oceanbase-database-cn-10000000001697240">修改集群项配置</a>。</li></ul></li></ul></p></main>   |
   | **Unit 数量**    | 指定该 Zone下的 Unit 数量。Unit 数量不能超过该 Zone下 Server 个数。<ul><li>当所选集群为 V4.0 及以上版本时，不支持按 Zone 级别单独设置 Unit 数量，所有 Zone 的 Unit 数量需保持一致（默认为 1）。</li><li>当所选集群为 V4.0 以下版本时，多个 Zone 可以设置不同的 Unit 数量。</li><main id="notice" type='explain'><h4>说明</h4><p>当租户所属数据库为 **单机集中式** 时，Unit 数量默认为 **1**，不支持修改。</p></main>    |
   | **Zone 优先级排序** | 选择是否为租户指定 Zone 的优先级排序，该优先级顺序将影响 sys 租户的 Primary Zone 的优先级顺序。<ul><li>如不指定，则默认继承 sys 租户的 Zone 优先级。</li><li>若打开 “Zone 优先级排序” 后未配置任何 Zone 优先级，则为 random 优先级。</li> <li>若需配置 Zone 优先级，您可以在左侧列表框中选择一个或多个 Zone 添加到右侧的列表框中，左边的列表框中显示了当前集群的所有 Zone。默认先选择的 Zone 的优先级高于后选择的 Zone，一次选中的多个 Zone 的优先级相同。 移动到右侧的列表框中后，您也可以在右侧的列表框中通过拖拽调整顺序，列表框上方的 Zone 的优先级高于下方的 Zone。</li></ul><main id="notice" type='explain'><h4>说明</h4><p>当租户所属数据库为 **单机集中式** 时，Zone 优先级排序不展示，默认 Zone1 为第一优先级。</p></main> |
   | **开启仲裁服务** | 选择是否为租户开启仲裁服务，该功能默认关闭。|

   ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/420/%E5%A4%87%E7%A7%9F%E6%88%B7%E5%89%AF%E6%9C%AC%E8%AE%BE%E7%BD%AE.png)

7. 打开 **参数配置** 模块，并配置租户参数。

    * 您可通过如图 ① 处，逐个添加启动参数项并为其配置值。

    * 也可通过如图 ② 处，单击 **选择参数模板**，选择一个参数模板，系统会将模板中的参数连同配置自动填充到此处。

    <main id="notice" type='explain'>
    <h4>说明</h4>
    <ul>
    <li>如果您的租户模式为 MySQL，且选择的参数模板中包含仅支持 Oracle 定义的参数，那么您需在使用模板填充后，手动删除这些参数。</li>
    <li>在未创建租户参数模板的情况下，您可单击 <strong>新建租户模板</strong>，为租户创建参数模板，详情可参考 <a href="../../700.tenant-functions/1500.manage-tenant-parameter-templates.md">租户参数模板管理</a>。</li>
    </ul>
    </main>

   ![1201](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E7%A7%9F%E6%88%B7%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF1.png)

8. 单击 **提交** 。

    页面会提示 **新建租户任务提交成功**，您可在该页面查看任务的简要信息。

    * 若您想查看任务详情，可单击 **查看任务详情** 按钮，查看新建租户任务的详细执行进度。
    * 您也可单击 **返回租户列表** 按钮，返回租户列表页面。在租户列表页面，您可查看新建租户的创建状态和任务详情，并支持对创建失败的租户进行删除。

      ![1201](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E5%88%9B%E5%BB%BA%E7%A7%9F%E6%88%B7%E4%BB%BB%E5%8A%A1%E6%8F%90%E4%BA%A4%E6%88%90%E5%8A%9F.png)

    <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>当任务状态为 <strong>完成</strong> ，且集群 <strong>租户管理</strong> 页的 <strong>租户列表</strong> 中该新建租户的状态为 <strong>运行中</strong> 时，表示租户新建成功。</p>
    </main>
