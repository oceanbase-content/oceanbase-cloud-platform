多可用区概述
============================

本节将为您简单介绍 OCP 多可用区（Multi Available-Zone）模式的功能及架构。

<main id="notice" type='notice'>
<h4>功能适用性</h4>
<p>该内容仅适用于 OCP 企业版，OCP 社区版不提供此功能。</p>
</main>

多可用区说明
---------------------------

可用区（Available-Zone，Azone）指由承载 OceanBase 业务的一个或多个机房映射出的逻辑区域。

OCP 的多可用区（Multi Available-Zone）模式是指将同一个 OCP 集群分别部署到多个可用区中，并优先以可用区为边界，来限定 OCP、OceanBase 和 OBProxy 之间的访问服务链路。各可用区内承载的业务会优先由其本区域内的 OCP 管理。

功能介绍
-------------------------

为了提高 OCP 的高可用，一套 OCP 集群可以部署到多个可用区，每个可用区映射为一个或多个物理机房，并且提供单独的 API 访问入口。

跨机房部署的 OceanBase 集群（多副本集群）通常其各副本分布在不同的机房，当普通 OCP 集群管理一个多副本的 OceanBase 集群时，就会存在跨机房运维的情况，若机房是跨城市级的，在运维过程中会产生更多的带宽资源消耗和更多延时，这是 OCP 管理异地副本需要解决的问题。

多可用区功能可使这一问题得到解决，针对多副本的 OceanBase 集群，您可使用 OCP 的多可用区模式。多可用区模式下，每一个机房配置的有所属可用区，一个可用区可映射为 1 个或多个物理机房，您可为业务压力较大的可用区或者全部可用区分别分配一个 OCP，每个 OCP 管理本可用区内的 OceanBase 集群副本，每个可用区的 OCP 对外使用独立的访问地址，但所有可用区的 OCP 可查看与管理的内容相同。

您可参考 [部署 OCP](../../300.deployment-guide/100.deployment-overview/200.multi-node-deplpyment-overview.md) 部署多可用区模式的 OCP，在 OCP 界面您可：

  <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>开启 OCP 多可用区模式建议您通过部署实现，需要在 OCP 部署前规划好业务所涉及的机房及区域，从而确定 OCP 集群需要在哪些可用区上部署。</p>
  </main>

OCP 界面不提供开启多可用区的入口，如需改造已有 OCP 为多可用区模式，因涉及改造的内容较多，建议您联系技术支持人员协助。

* 查看当前全部可用区、各可用区所包含的机房、各可用区的 OCP 以及未关联可用区的机房。详情请参见 [查看多可用区](../400.ocp-multi-zone-mode/200.see-multi-az.md)。

* 修改多可用区的相关配置，参见 [管理多可用区参数](../400.ocp-multi-zone-mode/300.manage-multi-zone-parameters.md)。

多可用区模式的架构
------------------------------

OCP 多可用区主要应用于多副本 OceanBase 的运维，多副本的 OceanBase 集群其副本分布在不同的机房。OCP 普通模式下，若机房距离较远则 OCP 在运维时会消耗过多的带宽同时时延也会增大。多可用区模式下，机房与可用区关联并由属于该可用区的 OCP 负责运维，下面以两种常见架构来做简单的原理说明。

### 同城三机房（OCP 单集群，多可用区）

下图展示 OCP 单集群多可用区模式下同城三机房的架构图。

![09021539](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/3723980361/p319507.png)

3 副本的 OceanBase 集群，其 Zone 分别分布在同城的三个机房中，每个 Zone 的业务量相当。

使用普通模式的 OCP 管理该 OceanBase 集群，OCP 集群部署在三机房的其中一个，需跨机房管理和运维位于其他机房的 OBServer 节点。当 OceanBase 集群的业务量增大时，OCP 集群与跨机房的 OBServer 节点交互则会受到带宽的限制，同时距离也会导致交互时延增加。

使用多可用区模式的 OCP 管理该 OceanBase 集群，则机房、可用区和 OCP1 集群的关系如下所示：

* 可用区 1：机房 1 关联到该可用区，区内业务由 OCP1 集群中属于该可用区的 OCP 进行管理，外部通过 VIP1 访问该 OCP。

* 可用区 2：机房 2 关联到该可用区，区内业务由 OCP1 集群中属于该可用区的 OCP 进行管理，外部通过 VIP2 访问该 OCP。

* 可用区 3：机房 3 关联到该可用区，区内业务由 OCP1 集群中属于该可用区的 OCP 进行管理，外部通过 VIP3 访问该 OCP。

属于可用区的 OCP 装在属于该可用区的物理机房内，优先管理该可用区内的业务，业务增大时，OCP1 集群管理该集群就能够做到及时高效。

### 跨城三机房（OCP 多集群，多可用区）

下图展示 OCP 多可用区\&多集群模式下跨城三机房的架构图。

![09021927](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/3723980361/p319635.png)

3 副本的 OceanBase 集群，其两个 Zone 分别分布在北京的两个机房、另有 1 个在深圳，其主要业务在北京。

使用普通模式的 OCP 管理该 OceanBase 集群，OCP1 集群部署在北京的一个机房中，需跨机房管理和运维位于北京另一机房的 OBServer 节点甚至深圳机房的 OBServer 节点。当 OceanBase 集群的业务量增大时，OCP 集群与跨机房的 OBServer 节点交互则会受到带宽的限制，同时长距离也会导致交互时延增加。

使用多可用区模式的 OCP 管理该 OceanBase 集群，则机房、可用区和 OCP1 集群的关系如下所示：

* 可用区 1：机房 1 关联到该可用区，且机房 1 中装有 OCP1 集群的 OCP 来管理该可用区中的业务，外部通过 VIP1 访问该 OCP。

* 可用区 2：机房 2 关联到该可用区，且机房 2 中装有 OCP1 集群的 OCP 来管理该可用区中的业务，外部通过 VIP2 访问该 OCP。

* 可用区 3：机房 3 关联到该可用区，且机房 3 中装有 OCP1 集群的 OCP 来管理该可用区中的业务，外部通过 VIP3 访问该 OCP。

属于可用区的 OCP 装在属于该可用区的物理机房内，优先管理该可用区内的业务，业务增大时，OCP1 集群管理该集群就能够做到及时高效。外部访问虽通过独立的 VIP 来访问各可用区的 OCP，但其访问到的 OCP 内容一样，由上图可以看出，可用区的 OCP 读写的元数据库是一个三副本的数据库，三个副本分别供三个可用区的 OCP 快速读写，而这三个副本中的数据始终保持一致。
