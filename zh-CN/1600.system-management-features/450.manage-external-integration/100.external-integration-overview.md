# 外部集成概述

用户可以通过配置 OAuth2/OIDC 类型的外部账号服务，实现单点登录到 OCP 首页。

## 背景信息

单点登录（SSO）是一种身份验证方法，用户可通过该凭据安全地对 OCP 进行身份验证。

## 概念介绍

* OAuth（Open Authorization，开放授权）是一个开放标准的授权协议，允许用户授权第三方应用访问其存储在资源服务上受保护的信息，而不需要将用户名和密码提供给第三方应用，解耦了认证和授权。OAuth 作为一种国际标准，目前传播广泛并被持续采用。OAuth2.0 是 OAuth 协议的延续版本，更加安全，更易于实现，但不兼容 OAuth1.0，即完全废止了 OAuth1.0。 OAuth（Open Authorization，开放授权）是为用户资源的授权定义了一个安全、开放及简单的标准，第三方无需获知用户的账号和密码，即可获取到用户的授权信息。

  * OAuth2 用于REST/APIs 的代理授权框架（delegated authorization framework）。
  * OAuth2 是基于令牌 Token 的授权，在无需暴露用户密码的情况下，让应用获取对用户数据有限访问权限。
  * OAuth2 解耦认证和授权。

* OIDC（OpenID Connect）是一种安全认证机制，第三方应用连接到身份认证提供商（Identify Provider）获取用户信息，并把这些信息以可靠的方式返回给第三方应用。OIDC 对 OAuth2.0 协议进行了扩展，通过扩展的 ID Token 字段，提供用户基础身份信息，ID Token 使用 JWT（JSON Web Token）格式进行封装，提供自包含性、防篡改机制，可以安全的传递给第三方应用程序并容易被验证。

## 原理介绍

### OAuth2

OCP 适配标准 OAuth2 认证中心，目前仅支持授权码（authorization-code）模式，即应用程序使用授权码来向授权服务器申请访问令牌/刷新令牌。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/432/OAuth2.png)

如图所示，授权流程场景可以描述为如下几个步骤：

1. 用户登录应用系统，请求跳转到认证服务器，并 302 返回登录认证页面。
2. 用户输入认证信息进行认证，认证服务器认证通过返回 code 给应用系统。
3. 应用系统携带 code 向认证服务器换取访问令牌，认证服务器验证 Client ID，code 等信息，给应用系统发送访问令牌。
4. 应用系统携带访问令牌查询用户登录信息，认证服务器返回用户信息，如用户名。
5. 应用系统验证用户名正确，创建会话，并跳转到 redirect url。

上述图中的相关参数说明如下：

| **步骤** | **参数说明** |
|--------|---------|
| 步骤 1 | **Authorization Request**<li>response_type：必选。值固定为 `code`。</li><li>client_id：必选。第三方应用标识 ID。</li><li>state：推荐。Client 提供的一个字符串，服务器会原样返回给 client。</li><li>redirect_uri：必选。授权成功后的重定向地址。<main id="notice" type='explain'><h4>说明</h4><p>授权服务器回调 OCP 服务的地址，如果 SSO 有回调白名单，需要进行加白。</p></main></li><li>scope：可选。表示授权范围。</li> |
| 步骤 2 | 验证步骤 1 中传递的参数。显示登录页面，让用户认证。用户授权 client 可访问的资源。 |
| 步骤 3 | **Authorization Response** <br>跳转到步骤 1 中指定的 redirect_url，并返回：<li>code：授权码。</li><li>state：步骤 1 中客户端提供的 state 参数原样返回。</li>  |
| 步骤 4 | **Access Token Request**<li>grant_type：必选。固定值 `authorization_code`。 </li><li>code：必选。Authorization Response 中响应的 code。</li><li>redirect_uri：必选。必须和 Authorization Request 中提供的 redirect_uri 相同。</li><li>client_id：必选。必须和 Authorization Request 中提供的 client_id 相同。</li> |
| 步骤 5 | Access Token Response <li> access_token：访问令牌。</li><li>refresh_token：可选。刷新令牌。</li><li>expires_in：过期时间。</li> |

### OIDC

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/432/oidc.png)

1. 客户端发送认证请求给认证服务。
2. 用户在认证页面进行授权确认。
3. 认证服务对认证请求进行验证，并返回 code 给客户端。
4. 客户端向业务服务请求回调接口，请求中携带 code。
5. 业务服务请求认证服务颁发 Token，请求中携带 code、Client ID、Client Secret。
6. 认证服务验证合法性，并返回 ID Token。
7. 认证成功，业务服务返回 ID Token 给客户端。
8. 客户端向业务请求，请求中携带 ID Token。
9. 业务服务验证 ID Token 是否合法，然后返回业务应答。

## 登录场景

* 当用户启用 SSO 模式且开启启用本地登录模式时，支持用户账密登录和第三方登录。
* 当用户启用 SSO 模式且未启用本地登录模式，可直接使用第三方账密登录 OCP 系统（第一次登录时需要跳转到第三方授权登录界面，待第三方授权后，后续访问可直接登录）。
* 当用户未开启 SSO 模式，仅支持本地账密登录方式。

## 查看 SSO 列表

当前登录 OCP 的用户为 **ADMIN** 角色或 **ADMIN_VIEWER** 角色时，您可在 **SSO 列表** 中查看 OCP 中 SSO 集成的详细配置信息，包括配置名称、类型、创建时间、最新变更时间、创始人及是否启用本地登录模式。并支持进行常见运维操作，详情参见 [新建 SSO 集成](200.create-sso-integration.md)、[启用/停用 SSO 集成配置](300.enable-and-disenable-sso-integration.md)、[编辑 SSO 集成](400.edit-sso-integration.md)、[删除 SSO 集成](500.delete-sso-integration.md)。
