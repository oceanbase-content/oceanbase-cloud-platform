# 新建集群级备份策略

集群级备份策略仅对未配置租户级备份策略的租户生效，您可对此类租户配置集群级的备份策略，以便进行统一管理。

## 前提条件

当集群为 V4.0.0 及以上版本时，配置二次备份需满足以下条件：

* 二次备份功能默认关闭，如需开启，需在 **系统参数** 中修改 `ocp.backup.advanced-secondary-backup.enable` 的参数值为 `true`。
* 普通备份与二次备份的备份存储介质均为 OSS。
* 二次备份的保留天数需比普通备份的保留时长要短。
* 当备份的调度周期为周时，二次备份的保留天数必须大于等于 7 天；当备份的调度周期为月时，二次备份的保留天数必须大于等于 30 天。
* 普通备份、二次备份不可在同一个 Bucket，且二级备份不支持自定义存储路径。
* 普通备份的 AK 需具有跨区复制相关权限，否则无法进行任务调度（任务执行会失败，配置权限后可重试任务）。
* 普通备份的 Bucket 上无跨区复制规则，否则无法进行任务调度（任务执行会失败，删除规则后可重试任务）。
* 若二次备份的目的端为其他独立部署的 OSS，需在 **系统参数** 中配置目的 Bucket 所在 OSS 的 `cloudName`、`cloudLocation`，其配置项如下：`ocp.backup.advanced-secondary-backup.target-cloud-name`、`ocp.backup.advanced-secondary-backup.target-cloud-location`。

## 操作步骤

您可通过如下三个入口新建集群级备份策略：

* **入口一：**

    登录 OCP，进入 **备份恢复 > 备份** ，在页面右上方 **新建备份策略** 下拉列表中选择 **新建集群级备份策略** 。

* **入口二：**

    登录 OCP，进入集群 **概览** 页面，在左侧导航栏选择 **备份恢复**，单击 **新建集群级备份策略** 。

* **入口三：**

    登录 OCP，进入租户 **概览** 页面，在左侧导航栏选择 **备份恢复**，单击 **新建集群级备份策略** 。

<main id="notice" type='explain'>
<h4>说明</h4>
<p>仅当租户及所属集群均无备份策略时，才可使用 <b>入口三</b> 新建集群级备份策略。</p>
</main>

以下步骤以 **入口一** 为例。

1. 在左导航栏中单击 **备份恢复** **\>** **备份** 。

2. 在 **备份** 页面，将光标悬停于 **新建备份策略**，单击 **新建集群级备份策略** 。

3. 在下拉框中选择备份集群。

   * 当备份集群为 V2.2.60 以下版本时，备份方式为 **逻辑备份**。

   * 当备份集群为 V2.2.60 及以上版本时，备份方式为 **物理备份**。

4. 填写如下参数设置存储配置，并单击 **测试** 。

   * 逻辑备份时，选择 [安装服务](../../1000.manage-backup-and-recovery-service/200.installation-services.md) 中配置的存储配置。

     若未安装备份服务，需先安装备份服务，安装服务请参考 [安装服务](../../1000.manage-backup-and-recovery-service/200.installation-services.md)。

   * 物理备份时，您可自定义或选择已有的存储配置。自定义时，需参考下述参数配置；选择已有配置时，单击 **选择已有配置** 下述参数会自动填充。

      <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>当存在原生的 OSS、COS 存储类型时，建议优先使用 OSS、COS 方式进行配置。</p>
      </main>

      * **File**：本地文件存储，一般为 NFS。

         | 参数  |  说明  |
         |--------|-------|
         | 存储目录  |  备份文件在当前介质上的存储目录。  |
         | 备份存储容量报警阈值  |  设置备份存储容量的报警阈值，默认值为 80%。  |

      * **OSS**：阿里云 OSS 对象存储，仅 OceanBase V2.2.76 及以上版本支持。

         | 参数  |  说明  |
         |--------|-------|
         | 存储目录  |  备份文件在当前介质上的存储目录。  |
         | 访问域名  |  填写访问阿里云存储端的域名。如：`oss-cn-hangzhou.aliyuncs.com`。  |
         | 访问用户  |  填写访问阿里云存储端的用户。  |
         | 访问秘钥  |  填写访问阿里云存储端的用户秘钥。  |

      * **COS**：腾讯云 COS 对象存储，仅 OceanBase V2.2.76 及以上、V4.0 以下版本或者 V4.2.1 及以上版本支持。

         | 参数  |  说明  |
         |--------|-------|
         | 存储目录  |  备份文件在当前介质上的存储目录。  |
         | 访问域名  |  填写访问腾讯云 COS 存储桶中对象的域名。如：`cos.ap-beijing.myqcloud.com`。  |
         | 资源标志（APPID）  |  开发者访问 COS 服务时拥有的用户维度唯一资源标识，可在对应产品的 API 秘钥管理页面获取。  |
         | 项目身份识别 ID  |  开发者拥有的项目身份识别 ID，可在对应产品的 API 秘钥管理页面获取。  |
         | 项目身份秘钥  |  开发者拥有的项目身份秘钥，可在对应产品的 API 秘钥管理页面获取。  |

      * **OBS**：华为云 OBS 对象存储，仅 OceanBase V3.2.3.2-105000062022090916 以上，V4.0.0.0 以下版本支持。

         | 参数  |  说明  |
         |--------|-------|
         | 存储目录  |  备份文件在当前介质上的存储目录。  |
         | 访问域名  |  填写访问华为云 OBS 对象的域名。如：`obs.cn-north-4.myhuaweicloud.com`。  |

      * **S3**：支持兼容 AWS S3 协议的存储介质，包含原生 AWS S3、华为云 OBS、天翼云 OBS 以及 Google GCS 等，仅 OceanBase V4.2.1-BP7 和 4.2.3-BP1(含) 及以上版本支持。关于 AWS S3 协议的存储介质说明，可参见 [S3 协议说明](../../../2100.appendix/900.s3-overview.md)。

         | 参数  |  说明  |
         |--------|-------|
         | 存储目录  |  备份文件在当前介质上的存储目录。  |
         | 访问域名  |  填写访问 S3 存储空间（Bucket）中对象的域名，如：`s3.us-west-2.amazonaws.com`。  |
         | AK  |  填写 S3 存储空间的秘钥 ID。  |
         | SK  |  填写 S3 存储空间的访问秘钥。  |
         | 地域  |  填写 S3 存储空间的地域信息。  |

         <main id="notice" type='notice'>
         <h4>注意</h4>
         <p>当存储介质为 AWS S3 时，<b>地域</b> 信息为必填配置项，其余存储介质如华为云 OBS、天翼云 OBS 或 Google GCS 等则无需填写。</p>
         </main>

     ![Image 147](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/431/%E5%AD%98%E5%82%A8%E9%85%8D%E7%BD%AE.png)

5. 设置调度配置。

   * 调度周期：以周或月为周期，当调度周期为月时，最多只能选择 10 天。

   * 物理备份必须打开日志备份，且不可关闭。

   ![Image 37](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E9%9B%86%E7%BE%A4%E8%B0%83%E5%BA%A6%E9%85%8D%E7%BD%AE1.png)

6. 设置过期备份清理调度配置。

   ![Image 52](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1307669461/p428171.png)

7. 设置报警阈值配置，您可对数据备份超时报警阈值、日志备份延时报警阈值、无成功数据备份报警天数进行配置，配置成功后，当实际输出超过阈值，将会收到告警提示。

   ![Image 53](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/410/%E6%8A%A5%E8%AD%A6%E9%98%88%E5%80%BC%E9%85%8D%E7%BD%AE.png)

8. （可选）设置二次备份配置。

   您可选择将备份数据文件和日志文件备份至另一个目录，如需进行二次备份，请打开 **二次备份** 开关。

   1. 设置二次备份的存储配置。

      ![Image 54](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/1307669461/p428178.png)

   2. 设置二次备份的调度配置。

      ![09221429](https://help-static-aliyun-doc.aliyuncs.com/assets/img/zh-CN/2859542361/p328243.png)

9. 单击 **新建**，完成集群级备份策略创建。
