# 发起恢复

您可对已备份的集群发起恢复。

## 前提条件

* 对要恢复的内容，已执行了 [立即备份](400.backup-now/100.back-up-cluster-now.md) 。

* 已进行物理备份的 OceanBase 集群在发起备份恢复时，不支持从高版本恢复到低版本。

## 操作步骤

1. 登录 OCP。

2. 进入 **发起恢复** 页面。

   * 路径 1，在全局页面发起恢复。

     1. 在左导航栏单击 **备份恢复 > 恢复** 。

     2. 进入 **恢复** 页面，在右上方单击 **发起恢复** 。

   * 路径 2，在某集群运维页面对该集群发起恢复。

     1. 在左导航栏单击 **集群** ，进入 **集群概览** 页面。

     2. 在 **集群列表** 或 **资源水位** 中单击要恢复的集群名，进入该集群运维页面。

     3. 在左导航栏单击 **备份恢复** 。

     4. 在该集群的 **备份恢复** 页面单击 **发起恢复** 。

     <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>若有如下情况，则无法从路径 2 下对该集群发起恢复：<ul><li>该集群状态不为 “运行中”。</li><li>该集群没有备份策略。</li></ul></p>
     </main>

   * 路径 3，在某租户运维页面对该租户发起恢复。

      1. 在左导航栏单击 **租户** ，进入 **租户概览** 页面。

      2. 在 **租户列表** 中单击要恢复的租户名，进入该租户运维页面。

      3. 在左导航栏单击 **备份恢复** 。

      4. 在该租户的 **备份恢复** 页面单击 **发起恢复** 。

     <main id="notice" type='explain'>
     <h4>说明</h4>
     <p>若有如下情况，则无法从路径 3 下对该租户发起恢复：<ul><li>该租户状态不为 “运行中”。</li><li>该租户没有备份策略。</li></ul></p>
     </main>

3. （可选）在全局页面发起恢复时，需填写存储配置，您可自定义或选择已有的存储配置。自定义时，需参考下述参数配置；选择已有配置时，单击 **选择已有配置** 下述参数会自动填充。

   <main id="notice" type='notice'>
   <h4>注意</h4>
   <p>当存在原生的 OSS、COS 存储类型时，建议优先使用 OSS、COS 方式进行配置。</p>
   </main>

    * **File**：本地文件存储，一般为 NFS。

      | 参数  |  说明  |
      |--------|-------|
      | 存储目录  |  备份文件在当前介质上的存储目录。  |
      | 解析主机  |  选择可访问该目录的主机。如解析逻辑备份，请选择备份恢复服务所在的主机；如解析物理备份，请选择 V2.2.70 及以上版本的 OceanBase 集群所在的主机。单击 **解析** ，获取可恢复的集群列表。  |

    * **OSS**：阿里云 OSS 对象存储，仅 OceanBase V2.2.76 及以上版本支持。

      | 参数  |  说明  |
      |--------|-------|
      | 存储目录 | 选择备份文件所在的目录。   |
      | 访问域名 | 填写访问阿里云存储端的域名。如：`oss-cn-hangzhou.aliyuncs.com`。  |
      | 访问用户 | 填写访问阿里云存储端的用户。  |
      | 访问秘钥 | 填写访问阿里云存储端的用户秘钥。  |
      | 解析主机 | 选择可访问该目录的主机。如解析逻辑备份，请选择备份恢复服务所在的主机；如解析物理备份，请选择 V2.2.70 及以上版本的 OceanBase 集群所在的主机。单击 **解析** ，获取可恢复的集群列表。  |

    * **COS**：腾讯云 COS 对象存储，仅 OceanBase V2.2.76 及以上、V4.0 以下版本或者 V4.2.1 及以上版本支持。

      | 参数  |  说明  |
      |--------|-------|
      | 存储目录 | 选择备份文件所在的目录。  |
      | 访问域名 | 填写访问腾讯云 COS 存储桶中对象的域名。如：`cos.ap-beijing.myqcloud.com`。  |
      | 资源标志（APPID） | 开发者访问 COS 服务时拥有的用户维度唯一资源标识，可在对应产品的 API 秘钥管理页面获取。  |
      | 项目身份识别 ID | 开发者拥有的项目身份识别 ID，可在对应产品的 API 秘钥管理页面获取。  |
      | 项目身份秘钥 | 开发者拥有的项目身份秘钥，可在对应产品的 API 秘钥管理页面获取。  |
      | 解析主机 | 选择可访问该目录的主机。如解析逻辑备份，请选择备份恢复服务所在的主机；如解析物理备份，请选择 V2.2.70 及以上版本的 OceanBase 集群所在的主机。单击 **解析** ，获取可恢复的集群列表。  |

    * **OBS**：华为云 OBS 对象存储，仅 OceanBase V3.2.3.2-105000062022090916 以上，V4.0.0.0 以下版本支持。

      | 参数  |  说明  |
      |--------|-------|
      | 存储目录 | 选择备份文件所在的目录。  |
      | 访问域名 | 填写访问华为云 OBS 对象的域名。如：`obs.cn-north-4.myhuaweicloud.com`。  |
      | AK | OBS 存储空间的秘钥 ID。  |
      | SK | OBS 存储空间的访问秘钥。  |
      | 解析主机 | 选择可访问该目录的主机。如解析逻辑备份，请选择备份恢复服务所在的主机；如解析物理备份，请选择 V2.2.70 及以上版本的 OceanBase 集群所在的主机。单击 **解析** ，获取可恢复的集群列表。  |

    * **S3**：支持兼容 AWS S3 协议的存储介质，包含原生 AWS S3、华为云 OBS、天翼云 OBS 以及 Google GCS 等，仅 OceanBase V4.2.1-BP7 和 4.2.3-BP1(含) 及以上版本支持。关于 AWS S3 协议的存储介质说明，可参见 [S3 协议说明](../2100.appendix/900.s3-overview.md)。

      | 参数  |  说明  |
      |--------|-------|
      | 存储目录 | 备份文件在当前介质上的存储目录。  |
      | 访问域名 | 填写访问 S3 存储空间（Bucket）中对象的域名，如：`s3.us-west-2.amazonaws.com`。  |
      | AK | 填写 S3 存储空间的秘钥 ID。  |
      | SK | 填写 S3 存储空间的访问秘钥。  |
      | 地域 | 填写 S3 存储空间的地域信息。  |
      | 解析主机 | 选择可访问该目录的主机。如解析逻辑备份，请选择备份恢复服务所在的主机；如解析物理备份，请选择 V2.2.70 及以上版本的 OceanBase 集群所在的主机。单击 **解析** ，获取可恢复的集群列表。  |

      <main id="notice" type='notice'>
      <h4>注意</h4>
      <p>当存储介质为 AWS S3 时，<b>地域</b> 信息为必填配置项，其余存储介质如华为云 OBS、天翼云 OBS 或 Google GCS 等则无需填写。</p>
      </main>

   ![Image 9](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/431/%E5%8F%91%E8%B5%B7%E6%81%A2%E5%A4%8D.png)

4. 填写 **恢复源信息**。

   * 租户恢复

      |  参数   |              说明               |
      |-------|-------------------------------|
      | 源集群   | 集群运维页面对某集群发起恢复时，源集群已默认，不需要选择。 |
      | 源租户   | 请选择需恢复的租户。                    |
      | 恢复对象   | 请选择 **租户**。                    |
      | 恢复日期  | 需在提示的可恢复时间段内。                 |
      | 恢复时间点 | 在提示的时间段内选择要恢复的时间点。            |

      ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/%E6%81%A2%E5%A4%8D%E7%A7%9F%E6%88%B7.png)

   * 库恢复

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>仅 OceanBase 4.x 支持库恢复。</p>
      </main>

     通过 **租户概览** > **备份恢复** > **发起恢复**，打开租户级恢复时，可进行当前租户下的库恢复。

      |  参数   |              说明               |
      |-------|-------------------------------|
      | 源集群   | 默认当前租户所在集群。 |
      | 源租户   | 默认当前租户。                    |
      | 恢复对象   | 请选择 **库**。                    |
      | 恢复日期  | 需在提示的可恢复时间段内。                 |
      | 恢复时间点 | 在提示的时间段内选择要恢复的时间点。     |
      | 恢复库对象 | 从左侧 **可恢复对象** 中选择需要恢复的库，通过 **>** 添加到右侧 **已选对象** 中。需保持库名称唯一，OCP 支持对库进行重命名，如下图所示。  |

      ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/rename.png)

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>最多支持选择 200 个库对象。</p>
      </main>

   * 表恢复

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p><ul><li>仅支持恢复用户表，不支持单独恢复临时表、视图、物化视图、物化视图日志、索引等。</li><li>表数据恢复成功即表示表恢复成功，允许索引、约束或其他关联的 Schema 恢复失败。</li></ul></p>
      </main>

     通过 **租户概览** > **备份恢复** > **发起恢复**，打开租户级恢复时，可进行当前租户下的表恢复。

      |  参数   |              说明               |
      |-------|-------------------------------|
      | 源集群   | 默认当前租户所在集群。 |
      | 源租户   | 默认当前租户。                    |
      | 恢复对象   | 请选择 **表**。                    |
      | 恢复日期  | 需在提示的可恢复时间段内。                 |
      | 恢复时间点 | 在提示的时间段内选择要恢复的时间点。     |
      | 恢复表对象 | 从左侧 **可恢复对象** 中选择需要恢复的表，通过 **>** 添加到右侧 **已选对象** 中。需保持表名称唯一，OCP 支持对表进行重命名，如下图所示。  |

      ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/table-rename.png)

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>最多支持选择 200 个表对象。</p>
      </main>

5. 填写 **恢复目标信息**。

      <main id="notice" type='explain'>
      <h4>说明</h4>
      <p>库表恢复过程中需要在目标集群中创建辅助租户，建议辅助租户规格与源租户保持一致并确保目标集群中具有充足的 CPU/Memory/磁盘资源，资源不足可能造成恢复缓慢或者恢复失败。库表恢复完成后系统会默认删除辅助租户。</p>
      </main>

      |  参数   |              说明               |
      |-------|-------------------------------|
      | 目标集群   | 请选择目标集群。 |
      | 目标租户   | 请选择目标租户。                    |

   <main id="notice" type='explain'>
   <h4>说明</h4>
   <p>以下集群不能作为恢复目标：<ul><li>存在主备关系的集群。</li><li>状态为不可用的集群。</li><li>低于发起恢复集群版本的集群。</li></ul></p>
   </main>

6. 填写如下参数配置 Zone ，并对 Zone 进行优先级排序。

   |   参数    |说明   |
   |---------|---|
   | 副本类型    | 取值范围： <ul><li>全能型副本：目前支持的普通副本，拥有事务日志、MemTable 和 SSTable 等全部完整的数据和功能。它可以随时快速切换为 Leader 以对外提供服务。</li><li> 日志型副本：只包含日志的副本，没有 MemTable 和 SSTable。它参与日志投票并对外提供日志服务，可以参与其他副本的恢复，但自己不能变为主提供数据库服务。   </li><li> 只读型副本：包含完整的日志、MemTable 和 SSTable 等。建议在业务对读取数据的一致性要求不高时选择。 </li></ul>   |
   | Unit 规格 | 该副本所占用的资源规格。 <ul><li>可选择已有规格。</li><li> 也可根据实际需要新建规格后再选择。 </li></ul>  |
   | Unit 数量 | 该副本所占用的资源数量。<blockquote>**注意**</br>当所选恢复目标集群为 V4.0 及以上版本时，不支持配置单个 Zone 的 Unit 数量，您在此填写的 Unit 数量将适用于新建恢复租户下的所有 Zone。</blockquote>|

7. 单击 **发起恢复** 。
