# 概述

当诊断采集数据量过大时，会导致 Agent 内存超限并不断重启，此时只能通过黑屏修改配置文件参数并重新推送的方式进行解决。但这种非标准的操作方式可能会引来一些问题，比如配置不兼容导致 Agent 升级失败，或者配置被重置等。

因此，OCP 提供了白屏的参数配置管理方式，您可参考本节内容，在 **运维配置** 页面查看 OCP 相关的采集和运维参数，并对其进行统一管理。

## 参数列表说明

OCP 支持的采集和运维参数共分为四类，包括：**SQL 诊断采集**、**事务诊断采集**、**活跃会话历史采集** 和 **性能监控参数**，分别对应 OCP 的 SQL 诊断功能、事务诊断功能、活跃会话历史功能和性能监控功能。

### SQL 诊断采集

**SQL 诊断采集** 主要为租户和自治服务内的 SQL 诊断模块提供基础数据。

| 参数名 | 参数类型 | 默认值 | 取值范围 | 参数说明 |
|--------|----------|--------|--------|-----------|
| monagent.pipeline.sql.audit.status | String | active | - | sql_audit 诊断数据的采集开关，active 为开启，inactive 为关闭，关闭后将看不到 SQL 诊断的数据。|
| monagent.limit.memory.fuse.percent | Double | 0.8 | [0.1, 1.0] | 诊断采集内存熔断的阈值，计算方法是为 ocp_monagent 进程当前内存 / ocp_monagent 进程内存限额。超过阈值将不再采集诊断数据，当采集压力大时可适当提高阈值。|
| monagent.ob.sql.audit.collect.batch.size | Int | 4000 | [500, 20000] | sql_audit 单次查询内部视图的数量，采集压力大时提高该值可提升效率。|
| monagent.ob.slow.sql.threshold | String | 100ms | -| 慢 SQL 的上报阈值，超过该阈值的 SQL 会被当做慢 SQL 上报 MonitorDB，慢 SQL 过多时可调整阈值减少上报数量。|
| monagent.ob.sql.transaction.timeus.threshold | Int | 500000 | [10000, 300000000] | 大事务的时间阈值，单位为 us，低于该阈值的事务 SQL 不会上报。大事务过多时可调整阈值减少上报数量。 |
| monagent.ob.sql.transaction.log.size.byte | Int | 524288 | [1024, 1073741824] | 大事务的日志大小阈值，单位为 Byte，低于该阈值的事务 SQL 不会上报。大事务过多时可调整阈值减少上报数量。|
| monagent.pipeline.plan.monitor.status | String | active | - | 并行 SQL 采集开关，关闭后不再采集并行 SQL 相关信息。 |
| monagent.pipeline.slow.sql.status | String | active | - | 慢 SQL 采集开关，关闭后则不再采集慢 SQL 相关信息。 |
| monagent.ob.sql.diagnose.collect.query.timeout | String | 10s | - | 诊断采集查询 SQL 的超时时间，包括 sql_audit、sql_plan、sql_plan_monitor的查询 SQL。 |
| monagent.pipeline.sql.plan.status | String | active | - | 执行计划采集开关，关闭后则不再采集执行计划信息。 |
| monagent.ob.sql.plan.collect.batch.size | Int | 4000 | [500, 20000] | 执行计划采集单次查询内部视图的数量，采集压力大时提高该值可提升效率。 |
| monagent.ob.sql.plan.monitor.collect.batch.size | Int | 4000 | [500, 20000] | 并行 SQL 采集单次查询内部视图的数量，采集压力大时提高该值可提升效率。 |
| monagent.pipeline.monitor.user.collect | Bool | false | - | 是否采集 agent 自身用户查询 sys 租户的 SQL 信息。默认关闭，可在排查问题时打开。 |
| monagent.pipeline.empty.query.sql.collect | Bool | false | - | 是否采集 query_sql 为空的 sql_audit 记录。默认关闭，可在排查问题时打开。 |

### 事务诊断采集

**事务诊断采集** 主要为租户和自治服务内的事务诊断模块提供基础数据。

| 参数名 | 参数类型 | 默认值 | 取值范围 | 参数说明 |
|--------|----------|--------|--------|-----------|
| monagent.pipeline.transaction.status | String | active | - | 事务采集开关，关闭后则不再采集事务和大事务相关数据。 |
| monagent.ob.sql.transaction.collect.batch.size | Int | 4000 | [500, 20000] | 事务采集单次查询内部视图的数量。采集压力大时提高该值可提升效率。 |
| monagent.ob.sql.transaction.collect.join.global.transaction | Bool | true | - | 事务信息采集时，是否 JOIN 全局事务表，可用于采集 XA 事务等信息。 |
| monagent.ob.sql.transaction.collect.query.timeout | String | 5s | - | 事务采集查询 SQL 超时时间。 |

### 活跃会话历史采集

**活跃会话历史采集** 主要为租户和自治服务内的会话管理模块提供基础数据。

| 参数名 | 参数类型 | 默认值 | 取值范围 | 参数说明 |
|--------|----------|--------|--------|-----------|
| monagent.pipeline.session.status | String | active | - | 活跃会话采集开关，关闭后则不在采集活跃会话相关信息。 |
| monagent.ob.session.event.collect.batch.size | Int | 4000 | [500, 20000] | 活跃会话采集单次查询内部视图的数量，采集压力大时提高该值可提升效率。 |
| monagent.ob.session.event.collect.query.timeout | String | 10s | - | 活跃会话采集查询 SQL 超时时间。 |

### 性能监控

| 参数名 | 参数类型 | 默认值 | 取值范围 | 参数说明 |
|--------|----------|--------|--------|-----------|
| monagent.pipeline.ob.status | String | active | - | 性能监控采集开关，可选值为 active/inactive。 |
| monagent.pipeline.tenant.disk.collect.disabled | Bool | false | - | 是否采集租户及以下维度磁盘数据，出现 SQL 性能问题时建议关闭。 |
| monagent.collector.ob.extra.interval | String | 60s | - | 性能监控分钟级监控采集频率。 |
| monagent.second.metric.cache.update.interval | String | 5s | - | 性能监控秒级监控采集频率。 |

## 参数管理操作

您在 **运维配置** 页面可对集群进行如下基础管理操作：

* [管理参数](200.manage-o&m-configuration-parameters.md)：支持对运维配置参数进行开启/关闭、修改参数值、搜索、查看已修改参数。
* [查看参数修改历史](300.view-o&m-configuration-parameters-history.md)：查看当前集群发起的所有运维配置参数的历史修改记录。
