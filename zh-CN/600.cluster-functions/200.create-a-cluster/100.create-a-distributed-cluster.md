# 新建分布式集群

分布式集群是 OceanBase 的企业级原生分布式数据库架构，分布式集群具备金融级高可用以及平滑扩缩容能力，高度兼容 Oracle/MySQL 模式，适用于对数据安全要求较高的核心业务系统。

您可以根据业务需要新建待管理的分布式主集群。

<main id="notice" type='notice'>
<h4>功能适用性</h4>
<p>OCP 社区版仅支持新建主集群。</p>
</main>

## 背景信息

* 当集群 **部署模式** 为单 Zone 多主机时，仅会扩展 OceanBase 服务的计算能力，不具备多副本高可用能力，适用于开发测试环境。
* 当集群 **部署模式** 为偶数 Zone 时，将无法满足数据高可用的要求，存在数据安全风险。建议您调整配置，保持奇数的可用区配置或者为集群/租户开启仲裁服务。

## 前提条件

* 当前登录 OCP 的用户有 **Create Cluster** 的权限。

* 当您创建的 OceanBase 集群为 V4.0 及以上版本时，系统会默认开启 Cgroup，以实现更强的 CPU/IOPS 隔离性。若您的业务场景为单租户、小规格（<14C）以及需要更高的数据库性能时，建议您关闭 Cgroup（即 `enable_cgroup=false`）。同时，若主机上的操作系统内核版本低于 4.1.9，集群将无法创建租户，此时请务必关闭 Cgroup。

* （可选）如您创建的是多副本 OceanBase 集群，则需当前 OCP 中已存在可用的 OBProxy 集群，您可参考如下链接新增 OBProxy 集群。

  * [创建 OBProxy 集群](../../800.obproxy-functions/200.create-an-obproxy-cluster.md)

  * [接管 OBProxy](../../800.obproxy-functions/400.manage-a-obproxy-server/200.take-over-an-obproxy.md)

## 操作步骤

1. 登录 OCP 后，在左侧导航栏单击 **集群** ，进入 **集群** 总览页面。根据实际业务场景，找到新建集群的入口。

   1. 如果您没有可管理的集群，系统会在 **集群列表** 页签中提示您新建集群，直接在提示信息中单击 **创建集群** 。

   2. 如果您已经有可管理的集群，则在 **集群列表** 页签的右上角，单击 **创建集群** 。

2. 在 **创建集群** 页面，选择 **分布式集群** 模式。

3. 设置集群的基础信息。
  
      基础信息填写说明如下表所示。

     |配置  |   描述   |
     |-----|-------|
     | **集群类型**          | 选择 **主集群** 。  |
     | **集群名称**          | 自定义待管理的集群的名称。集群名称必须以英文字母开头，可支持大小写字母、数字和下划线，长度为 2\~48 字符。|
     | **root@sys 密码**    | 支持自定义或随机生成。 密码需要满足以下复杂度条件：<ul><li>长度为 8\~32 个字符</li><li>至少包含数字（0\~9）、大写字母（A\~Z）、小写字母（a\~z）和特殊字符四种类型中的三种，支持的特殊字符为 <code>~!@#%^&*_-+=\|(){}[]:;,.?/</code>。  </li></ul>   |
     | **OceanBase 版本**         | 可以从列表中选择已有的 OceanBase 集群版本，也可以在列表下方单击 **添加版本** ，上传一个 OceanBase 的版本。  |
     | **关联 OBProxy 集群** | 如您创建的是多副本的 OceanBase 集群，建议您打开关联 OBProxy 集群开关，为该 OceanBase 集群关联 OBProxy 集群。 关联后您的业务涉及的 SQL 请求将会被精准转发到相应的副本，使您对 OceanBase 数据库的访问效果能够媲美访问单机数据库。 </br>1. 默认使用 proxyro 用户关联，您无需填写用户名和密码。 </br>  2. 在下拉框中选择要关联的 OBProxy 集群。如下拉框中没有可关联的 OBProxy 集群，请参考本文 **前提条件** 中的描述添加 OBProxy 集群。</br>对于待关联的 OBProxy 集群，有以下限制条件：<ul><li>仅可选择与 OceanBase 集群网络一致且非空的 OBProxy 集群。</li><li>当 OceanBase 集群版本为 V4.0 及以上版本时，仅支持关联 V4.0.0 及以上版本的 OBProxy 集群。</li></ul>    |

     ![Image 175](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/420/%E5%88%9B%E5%BB%BA%E4%B8%BB%E9%9B%86%E7%BE%A4.png)

4. 设置集群的部署模式信息。

   默认添加 3 个 Zone 的信息，如果您希望部署的集群 Zone 的个数大于 3 个，您可以在下方单击 **新增** 按钮，增加 Zone 信息。如果部署的集群 Zone 的个数小于 3 个，您可以单击 Zone 后面的删除图标。

   ![10](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F1.png)

   每个 Zone 需要设置的信息及其说明如下表所示。

   |   配置   |  描述   |
   |-----|-------|
   | **Zone 名称**    | 可保持默认也可自定义。 Zone 名称必须以英文字母开头，支持大小写字母、数字和下划线，长度为 2\~48。 部署多 Zone 的 OceanBase 集群必须有一个 Zone 与主 Zone 的 Region 相同。  |
   | **机房**     | Zone 所在的机房，一个 Zone 只能存在于一个机房。  |
   | **机型**    | 可选项。如果选择了机型，后面主机列表会根据机型进行过滤。   |
   | **CPU 架构**    |  当选择的 **OceanBase 版本** 中存在多个不同架构的安装包时，需选择匹配此软件包的主机硬件架构。<blockquote>**注意**</br><ul><li>默认架构类型为第一个安装包的架构类型，支持切换。切换指定架构后，**主机** 列表中即展示该架构的主机。</li><li>若为不同的 Zone 设置不同的架构时，混合架构部署模式可能存在稳定性与性能问题，请谨慎操作。</li></blockquote> |
   | **主机**  | 您可以选择多个主机，或进行添加主机的操作。   |
   | **Root Service 位置**     | 您需选择一个 IP 作为 Root Service 所在的机器。多副本的 OceanBase 集群，其每个 Zone 都需指定一个 root Server。   |
   | **Zone 优先级排序**  **（创建备集群无需配置）**  | 选择是否为集群 sys 租户的主副本分布指定优先级。<ul><li>如指定，最高优先级的 Zone 会被视为 Primary Zone，且只能有一个。 排序方法如下：</br> 1. 勾选左侧列表框中的一个或多个 Zone。 左侧列表框中显示了当前集群中所有可选的 Zone。</br>   2. 单击中间的 \> 按钮。 此时勾选的 Zone 就会被移动到 **Zone 优先级排序** 列表中。同时勾选的多个 Zone 具有相同的优先级。 </br>  3. 重复 a、b 动作，添加低一优先级的 Zone。</br>   4. 如需调整优先级，可在 **Zone 优先级排序** 列表中拖拽以调整顺序。 列表中从上到下，优先级依次递减。</li><li>如不指定，则以第一个 Zone 为第一优先级。</li></ul>    |
   | **添加仲裁服务** |  选择是否为集群添加仲裁服务。您可在服务下拉列表中选择需要添加的服务，或单击 **添加服务** 为集群新创建仲裁服务，详情参见[添加仲裁服务](../400.manage-arbitration-services/800.add-arbitration-services.md)。  <blockquote>**说明**</br>仅支持为 V4.1.0 及以上版本的主集群添加仲裁服务。</blockquote>  |

5. 打开 **CPU 超卖设置** 模块，配置 CPU 超卖额度。您可通过滑动块或输入框配置超卖比例，默认值为 120，取值范围为 101~200。

   系统不同的租户负载可以有控制地交错运行，配置 CPU 资源时可以进行超卖设置来提升资源利用率。如果不同业务场景的负载出现交叠，OceanBase 集群在运行过程中可能会产生负载过载等情况，会出现不同租户间进行线程竞争 CPU 的现象，进而导致实际业务场景变慢。

   <main id="notice" type='explain'>
    <h4>说明</h4>
    仅 OceanBase 4.0 及其以上版本支持对 CPU 进行超卖分配，在合理配置下，您可以充分地利用硬件资源。
    </main>

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E8%B6%85%E5%8D%96%E8%AE%BE%E7%BD%AE.png)

6. 打开 **参数设置** 模块，并配置集群参数。

   如您对集群级别的 CPU、内存、数据盘以及日志盘的使用有定制化变更诉求，请设置参数：<code>cpu_count</code>（默认值：自动调整）、 <code>memory_limit_percentage</code>（默认值：80%）、<code>system_memory</code>（默认值：30GiB）、 <code>data_disk_usage_limit_percentage</code>（默认值：90%）、<code>datafile_size</code>、<code>clog_disk_usage_limit_percentage</code>（默认值：90%）、<code>log_disk_size</code>，具体参数说明请参考 OceanBase 官网 <a href="https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000640281">集群配置项总览</a>。

    * 您可通过如图 ① 处，逐个添加启动参数项并为其配置值。

    * 也可通过如图 ② 处，单击 **选择参数模板** ，然后选择一个参数模板，系统会将模板中的参数连同配置自动填充到此处。在未创建集群参数模板的情况下，您可单击 **新建集群模板**，为集群创建参数模板，详情可参考 [集群参数模板管理](../1200.cluster-parameters-template-management.md)。

    ![09161737](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E5%8F%82%E6%95%B0%E6%A8%A1%E6%9D%BF.png)

   系统提供如下 5 种内置模板，模板中包含了常用的参数设置，您可直接应用该模板进行集群的初始化设置。关于系统内置模板，具体说明如下。

   | 模板 | 参数配置 | 说明 |
   |------|------|-------|
   | HTAP 默认参数模板   |  `large_query_threshold:600s`  |  适用于混合 OLAP 和 OLTP 工作负载。通常用于从活动运营数据、欺诈检测和个性化建议中获取即时见解。<br>该模板适用于 OceanBase V4.3.0 及以上版本。 |
   | OLAP 默认参数模板   | `enable_record_trace_log:false` <br> `large_query_threshold:0ms` <br> `trance_log_slow_query_watermark:7d`  |  用于实时数据仓库分析场景。<br>该模板适用于 OceanBase V4.3.0 及以上版本。   |
   | COMPLEX_OLTP 默认参数模板   | `large_query_threshold:600s`  |  适用于银行、保险系统等工作负载。他们通常具有复杂的联接、复杂的相关子查询、用 PL 编写的批处理作业，以及长事务和大事务。有时对短时间运行的查询使用并行执行。<br>该模板适用于 OceanBase V4.3.0 及以上版本。   |
   | KV 默认参数模板   | `large_query_threshold:0ms`  |  用于键值工作负载和类似 hbase 的宽列工作负载，这些工作负载通常具有非常高的吞吐量并且对延迟敏感。<br>该模板适用于 OceanBase V4.3.0 及以上版本。   |
   | 2.2.77 默认参数模板   |  `clog_sync_time_warn_threshold:1s` <br> `enable_merge_by_turn:FALSE` <br> `enable_one_phase_commit:FALSE` <br> `freeze_trigger_percentage:50` <br> `max_kept_major_version_number:1` <br> `minor_freeze_times:150` <br> `resource_soft_limit:100`   |  OceanBase 集群 V2.2.77 版本推荐使用的参数设置，供生产环境使用。   |

7. 打开 **自定义设置**，支持您执行集群级别用户配置（如操作系统属主用户）、路径设置（如软件安装路径、数据盘路径、日志盘路径）以及端口设置（如 SQL 端口、RPC 端口）。

   * 配置操作系统所属主用户：

      该用户为配置安装、运行 OBServer 的操作系统用户，不支持编辑。您可通过调整 `ocp.operation.default.os.user` 参数的默认配置来修改此用户，该参数的修改仅在创建分布式集群、[创建 OBProxy 集群](../../800.obproxy-functions/200.create-an-obproxy-cluster.md) 和 [创建仲裁服务](../400.manage-arbitration-services/200.create-arbitration-services.md) 时产生影响，不影响已有集群的其他配置。

   * 配置相关路径：

      |   配置   |  描述   |
      |-----|-------|
      | **软件安装路径**   | <ul><li> 当 **操作系统所属主用户** 为 admin 时，**软件安装路径** 默认为 `/home/admin/oceanbase`，支持自定义路径。</li><li>当 **操作系统所属主用户** 为非 admin 时，**软件安装路径** 默认为 `/opt/oceanbase/oceanbase`，支持自定义路径。</li></ul>   |
      | **数据盘路径**       | 默认为 `/data/1`，支持自定义路径。  |
      | **日志盘路径**   | 默认为 `/data/log1`，支持自定义路径。生产环境下，OceanBase 数据库建议日志盘空间为主机内存空间的三倍以及以上；同时，为了避免出现性能问题，不建议数据目录和日志目录挂载在同一块磁盘上。<main id="notice" type='explain'><h4>说明</h4>从 OCP 4.3.0 BP1 开始，当创建如下版本的 OceanBase 集群时，slog 目录将置于日志盘中，不再与数据盘绑定。此时若配置 <code>log_disk_size=0</code>，会被视为 clog 独占，即默认 <code>log_disk_percentage</code> 为 90%。如果 slog 与 clog 所在磁盘的大小小于 40GiB，此时为 slog 预留的空间则不足 4GiB，可能会影响 slog 的写入。<ul><li>V4.2.4.0 ≤ OceanBase ＜ V4.3.0.0</li><li>OceanBase ≥ V4.3.1.0</li></ul>更多 slog 相关说明，请参见 <a href="https://www.oceanbase.com/docs/common-oceanbase-database-cn-1000000000819002">OBServer 节点安装目录结构</a>。</main>      |

      配置完成后，单击 **测试**，校验路径是否可用。若不可用，您可根据测试结果进行排查，或将路径修改为其它可用路径。

   * 配置端口：

      |   配置   |  描述   |
      |-----|-------|
      | **SQL 端口**        | 默认为 2881，支持自定义端口。  |
      | **RPC 端口**   | 默认为 2882，支持自定义端口。     |

      配置完成后，单击 **测试**，校验端口是否已被占用。若被占用，您需重新配置可用端口。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E8%87%AA%E5%AE%9A%E4%B9%89%E8%AE%BE%E7%BD%AE.png)

8. 测试成功后，单击 **提交** 。

9. 在弹出的 **确认提交信息** 对话框中，确认信息无误后，单击 **确定** 。

   您可在 **任务中心** 中查看该任务的执行进度。
