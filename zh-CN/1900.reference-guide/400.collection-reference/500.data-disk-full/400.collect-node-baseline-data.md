# 采集 major sstable 额外版本的数据大小

## 采集描述

查询 major sstable 包含的额外版本的数据量大小。

## 采集原理

OceanBase V4.0.0 之前版本：

```sql
SELECT  m1.svr_ip, m1.svr_port, sum(m1.size)/1024/1024/1024 data_size_gb 
FROM __all_virtual_table_mgr m1 
JOIN ( 
  SELECT svr_ip, svr_port, `tenant_id`, table_id, partition_id, index_id, max(multi_version_start) max_version, count(*) cnt  
  FROM __all_virtual_table_mgr
  WHERE table_type=1 
  GROUP BY svr_ip,svr_port,table_id,partition_id,index_id
  HAVING cnt>1 ) m2 
ON m1.svr_ip=m2.svr_ip AND m1.svr_port=m2.svr_port AND m1.tenant_id=m2.tenant_id AND m1.table_id=m2.table_id AND m1.partition_id=m2.partition_id AND m1.index_id=m2.index_id 
WHERE m1.table_type=1 AND m1.multi_version_start!=m2.max_version 
GROUP BY m1.svr_ip, m1.svr_port
```

OceanBase V4.0.0 及之后版本：

```sql
SELECT  m1.svr_ip, m1.svr_port, sum(m1.size)/1024/1024/1024 data_size_gb 
FROM __all_virtual_table_mgr m1 
JOIN ( 
  SELECT svr_ip, svr_port, `tenant_id`, ls_id, tablet_id, max(end_log_scn) max_version, count(*) cnt  
  FROM __all_virtual_table_mgr
  WHERE table_type=10
  GROUP BY svr_ip, svr_port, `tenant_id`, ls_id, tablet_id
  HAVING cnt>1 ) m2 
ON m1.svr_ip=m2.svr_ip AND m1.svr_port=m2.svr_port AND m1.tenant_id=m2.tenant_id AND m1.ls_id=m2.ls_id AND m1.tablet_id=m2.tablet_id
WHERE m1.table_type=1 AND m1.end_log_scn!=m2.max_version 
GROUP BY m1.svr_ip, m1.svr_port
```

## 可能的影响

详情可参考 [临时文件排查手册](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000685638?back=kb) 或 [OceanBase 数据库中怎么查看临时文件的磁盘空间占用](https://www.oceanbase.com/knowledge-base/oceanbase-database-1000000000209899)。
