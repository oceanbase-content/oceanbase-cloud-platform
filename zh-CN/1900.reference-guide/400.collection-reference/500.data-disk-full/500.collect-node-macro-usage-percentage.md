# 采集节点宏块利用率

## 采集描述

查询集群节点宏块利用率，用于判断是否利用率过低。

## 采集原理

OceanBase V4.0.0 之前版本：

```SQL
SELECT *, round(data_size_gb/required_size_gb*100,3) percentage 
FROM (
  SELECT svr_ip,svr_port, round(sum(occupy_size)/1024/1024/1024,5) data_size_gb , round(sum(used_size)/1024/1024/1024,5) required_size_gb
  FROM __all_virtual_storage_stat 
  WHERE store_type=1 
  GROUP BY svr_ip,svr_port
)
```

OceanBase V4.0.0 及之后版本：

```SQL
SELECT *, round(data_size_gb/required_size_gb*100,3) percentage
FROM (
  SELECT svr_ip,svr_port, round(sum(data_size)/1024/1024/1024,5) data_size_gb , round(sum(required_size)/1024/1024/1024,5) required_size_gb
  FROM __all_virtual_tablet_meta_table 
  GROUP BY svr_ip,svr_port
)
```

## 处理方法

查看未满的宏块空间是否较多、或空间利用率较低。一般解决方法是进行数据重整，待数据重整后磁盘空间即可释放，其操作步骤如下：

1. 修改参数 `alter table tablename set progressive_merge_num = 1`。
2. 执行 `alter system major freeze`。
3. 待合并结束后，设置 `progressive_merge_num = 0`。

<main id="notice" type='explain'>
<h4>说明</h4>
以上操作仅针对磁盘放大的几张索引所在的表。
</main>
