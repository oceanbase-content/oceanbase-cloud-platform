# 采集主机包含 “dump tenant info” 关键字日志

## 采集描述

日志查询 `observer.log` 中是否包含指定租户 “dump tenant info.tenant” 等关键字日志。

## 采集原理

查询 OBServer 日志目录（默认为 `/home/admin/oceanbase/log`）下的 `observer.log` 文件中是否存在包含 “dump tenant info.tenant={id:” 等关键字的 INFO 级别的日志。

执行如下命令进行采集，`ob_tenant_id` 替换为对应的租户 ID：

```shell
grep 'dump tenant info.tenant={id:${ob_tenant_id}' ${observer.log.path}/observer.log
```

若租户队列已满（以 500 租户为例），可以看到类似如下日志，包含租户的规格、线程、队列、请求统计等信息：

```shell
observer.log.20171129181406:[2017-11-29 18:13:54.020089] INFO  [SERVER.OMT] ob_multi_tenant.cpp:533 [116676][Y0-0000000000000000] [lt=42] dump tenant info(tenant={id:500, 			unit_min_cpu:"10.000000000000", unit_max_cpu:"10.000000000000", slice:"0.000000000000", slice_remain:"0.000000000000", token_cnt:40, ass_token_cnt:40, lq_tokens:12, used_lq_tokens:0, stopped:false, idle_us:0, recv_hp_rpc_cnt:380082895, recv_np_rpc_cnt:0, recv_lp_rpc_cnt:0, recv_mysql_cnt:0, recv_task_cnt:0, recv_large_req_cnt:0, tt_large_quries:0, actives:40, workers:40, lq waiting workers:0, req_queue:total_size=65537 queue[0]=65537 queue[1]=0 queue[2]=0 queue[3]=0 queue[4]=0 queue[5]=0 , large queued:0})
```

<main id="notice" type='explain'>
<h4>说明</h4>
<li>当 OceanBase 为 V4.x 版本时，此类型日志每 30s 打印一次。</li><li>当 OceanBase 为 V3.x 或 V2.x 版本时，此类型日志每 10s 打印一次。</li>
</main>

该日志通常用来判断租户队列是否积压，具体字段说明如下：

* id：租户 ID。
* unit_min_cpu：最小 CPU 核数，保证提供。
* unit_max_cpu：最大 CPU 核数，限制上限。
* slice：无意义。
* slice_remain：无意义。
* token_cnt：调度器分配的 token 数，一个 token 会转换为一个工作线程。
* ass_token_cnt：租户当前确认的 token 数（根据 token_cnt 确认，一般两者相等）。
* lq_tokens：Large Query token 个数，根据 token_cnt 乘以大请求比例设置。
* used_lq_tokens：当前持有 LQ Token 的 Worker 数。
* stopped：租户 unit 是否正在删除。
* idle_us：一轮（10s）中工作线程空闲的总时间和，所谓空闲实际只统计了等待队列的时间。
* recv_hp/np/lp_rpc_cnt：租户累计收到不同级别的 RPC 请求数，hp（High），np（Normal），lp（Low）。
* recv_mysql_cnt：租户累计收到的 MySQL 请求数。
* recv_task_cnt：租户累计收到的内部任务数。
* recv_large_req_cnt：租户累计预判的大请求数，只会递增，不会清零。实际是重试的时候递增。
* tt_large_quries：租户累计处理的大请求数，只会递增，不会清零。实际是打点 check 的时候递增。
* actives：处于活跃状态的工作线程数。
* workers：租户持有的工作线程数，实际就是 workers_ 这个 list 的 size。
* nesting workers：租户持有的嵌套请求专用线程数，共 7 个线程对应 7 个嵌套层级。
* lq waiting workers：处于等待调度的工作线程。
* req_queue：不同优先级的工作队列，数字越小优先级越高。字段表示各优先级排队请求数。
* large queued：当前预判出的大请求个数。
* multi_level_queue：存放嵌套请求的工作队列，1～7 对应 7 个嵌套层级（queue[0] 暂时不用）。字段表示各层级排队请求数。
