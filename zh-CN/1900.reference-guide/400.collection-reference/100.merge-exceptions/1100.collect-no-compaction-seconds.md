# 采集合并时间

## 采集描述

查询集群合并时间并与当前时间进行比较，单位为微秒。

## 采集原理

OceanBase V4.0.0 之前版本：

```sql
select zone, name, value, time_to_usec(now()) from __all_zone where name = 'merge_start_time';
```

OceanBase V4.0.0 及之后版本：

```sql
select tenant_id, time_to_usec(start_time) as start_time, time_to_usec(now()) as now from CDB_OB_MAJOR_COMPACTION;
```

## 处理方法

目前 OCP 已存在关于 OceanBase 集群是否长时间未触发合并相关的告警监测，当距离上一次合并时间超过阈值（默认为 108000s）时会触发告警。同时，OceanBase 集群的 Root Service 会定期发起冻结，长时间不发起冻结或合并会导致磁盘空间增大、磁盘爆满等问题，影响业务写入。

1. 检查是否开启了每日合并。

   查看路径：集群 **概览** > **合并管理** > **合并配置** 中的 **合并策略** 是否配置了 **每日合并时间** 。
  
   * 未配置，则不会自动冻结触发，需手动打开。
   * 已配置，则可能是其他原因，请继续执行下一步。

2. 检查是否进程异常导致 Root Service 服务异常。

   若 observer 进程异常，则会有 **ob_cluster_exists_inactive_server OB 集群存在不工作 OBServer 节点** 告警上报，可参考 [ob_cluster_exists_inactive_server OB 集群存在不工作 OBServer 节点](../../100.alarm-reference/200.ob-alert/400.ob_cluster_exists_inactive_server.md) 进行处理。处理后需进行观察，若 5min 后告警继续上报，则执行下一步。

3. 检查 Root Service 是否无主。

    使用 `sys` 租户执行如下语句查询 `__all_virtual_core_meta_table`，判断 Root Service 是否无主。

    ```sql
    SELECT svr_ip, zone, role, member_list FROM __all_virtual_core_meta_table;
    ```

    * 若连接正常，但是查询失败，说明 Root Service 处于无主状态。可通过重启 Root Service 所在的 OBServer 节点进行恢复，或重启 rootservice_list 中的所有的 OBServer 节点进行恢复。

       1. 通过如下方法找到对应 OBServer 节点的 IP。

          ```sql
          -- 连接 sys 租户查询

          -- 查询 Root Service 所在 OBServer 节点
          SELECT zone, svr_ip, svr_port
          FROM __all_server WHERE with_rootserver=1;

          -- 查询 rootservce list
          -- rootservice_list 的格式为 ';' 分隔的字符串，每个部分表示一台 OBServer 节点
          SELECT DISTINCT `value` AS rootservice_list
          FROM __all_virtual_sys_parameter_stat
          WHERE `name` = 'rootservice_list';
          ```

       2. 在集群 **总览** 页面的 **OBServer 列表** 中单击对应 OBServer 节点的 **重启** 按钮。

          <main id="notice" type='explain'>
          <h4>说明</h4>
          强制重启会以直接结束进程的方式重启，当不满足多数派时，需采用此方式重启。不满足多数派时重启 OBServer 节点会导致部分副本无主，重启后可能需要等待 15min 后 sys 租户才可以正常连接，同样业务租户也会有此类情况发生。
          </main>

          重启之后或强制重启等待 15min 之后仍未恢复，请重复执行步骤 **3**。

    * 如果有主，则可能是其他原因，请执行下一步。

4. 请收集 OBServer 节点上的日志信息，并联系 OCP 技术支持协助处理。
