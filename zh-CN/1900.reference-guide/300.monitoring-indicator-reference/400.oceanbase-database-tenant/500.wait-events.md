# 等待事件

本节为您介绍 OceanBase 租户的监控指标 **等待事件** 。等待事件指每秒发生等待事件的次数，OCP 根据等待事件类型提供如下 11 个细分指标来分别统计不同类型的等待事件每秒的发生的次数，分别为：all（每秒等待事件次数）、application_wait（每秒 application 等待事件次数）、configuration_lock_wait（每秒 configuration 事件次数）、administrative_wait（每秒 administrative 等待事件次数）、concurrency_wait（每秒 concurrency 等待事件次数）、commit_wait（每秒 commit 等待事件次数）、network_wait（每秒 network 等待事件次数）、user_io_wait（每秒 user_io 等待事件次数）、system_io_wait（每秒 system_io 等待事件次数）、cluster_wait（每秒 cluster 等待事件次数）、other_wait（每秒其他等待事件次数）。您可指定统计范围，查询租户在单个 Zone 或 OBServer 节点的 **等待事件** 数据。

## all

### 指标介绍

统计范围内，租户每秒发生的等待事件次数。

### 指标参数说明

| **指标项** |     **指标名称**     | **单位** |
|---------|------------------|--------|
| all     | wait_event_count | 次      |

### 计算表达式

sum(rate(ob_waitevent_wait_total{@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, sum(total_waits) as total_waits, sum(time_waited_micro) / 1000000 as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, sum(total_waits) as total_waits, sum(time_waited_micro) / 1000000 as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id
  ```

## application_wait

### 指标介绍

统计范围内，租户每秒发生的 application 等待事件次数。

### 指标参数说明

|    **指标项**    |             **指标名称**              | **单位** |
|---------------|-----------------------------------|--------|
| application_wait | system_event_application_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="CONFIGURATION",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## configuration_lock_wait

### 指标介绍

统计范围内，租户每秒发生的 configuration 事件次数。

### 指标参数说明

|    **指标项**    |             **指标名称**              | **单位** |
|---------------|-----------------------------------|--------|
| configuration_lock_wait | system_event_configuration_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="CONFIGURATION",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## administrative_wait

### 指标介绍

统计范围内，租户每秒发生的 administrative 等待事件次数。

### 指标参数说明

|    **指标项**    |             **指标名称**              | **单位** |
|---------------|-----------------------------------|--------|
| administrative_wait | system_event_administrative_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="ADMINISTRATIVE",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## concurrency_wait

### 指标介绍

统计范围内，租户每秒发生的 concurrency 等待事件次数。

### 指标参数说明

|    **指标项**    |             **指标名称**              | **单位** |
|---------------|-----------------------------------|--------|
| concurrency_wait | system_event_concurrency_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="CONCURRENCY",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## commit_wait

### 指标介绍

统计范围内，租户每秒发生的 commit 等待事件次数。

### 指标参数说明

|    **指标项**    |                **指标名称**                | **单位** |
|---------------|----------------------------------------|--------|
| commit_wait | system_event_commit_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="COMMIT",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## network_wait

### 指标介绍

统计范围内，租户每秒发生的 network 等待事件次数。

### 指标参数说明

| **指标项** |          **指标名称**           | **单位** |
|---------|-----------------------------|--------|
| network_wait | system_event_network_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="NETWORK",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## user_io_wait

### 指标介绍

统计范围内，租户每秒发生的 user_io 等待事件次数。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| user_io_wait | system_event_user_io_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="USER_IO",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## system_io_wait

### 指标介绍

统计范围内，租户每秒发生的 system_io 等待事件次数。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| system_io_wait | system_event_system_io_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="SYSTEM_IO",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## cluster_wait

### 指标介绍

统计范围内，租户每秒发生的 cluster 等待事件次数。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| cluster_wait | system_event_cluster_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="CLUSTER",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## other_wait

### 指标介绍

统计范围内，租户每秒发生的其他等待事件次数。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| other_wait | system_event_other_total_waits | 次      |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="OTHER",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```
