# 等待事件耗时

本节为您介绍 OceanBase 租户的监控指标 **等待事件耗时** 。该指标统计不同类型的等待事件耗时，包括：all（等待事件平均耗时）、application_wait（application 等待事件平均耗时）、configuration_wait（onfiguration 等待事件平均耗时）、administrative_wait（administrative 等待事件平均耗时）、concurrency_wait（concurrency 等待事件平均耗时）、commit_wait（commit 等待事件平均耗时）、network_wait（network 等待事件平均耗时）、user_io_wait（user_io 等待事件平均耗时）、system_io_wait（system_io 等待事件平均耗时）、cluster_wait（cluster 等待事件平均耗时）、other_wait（其他等待事件平均耗时）。您可指定统计范围，查询租户在单个 Zone 或 OBServer 节点的 **等待事件耗时** 数据。

## all

### 指标介绍

统计范围内，租户的等待事件平均等待耗时。

### 指标参数说明

| **指标项** |   **指标名称**    | **单位** |
|---------|---------------|--------|
| all     | wait_event_rt | μs    |

### 计算表达式

sum(rate(ob_waitevent_wait_seconds_total{@LABELS}[@INTERVAL])) by (@GBLABELS) / sum(rate(ob_waitevent_wait_total{@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, sum(total_waits) as total_waits, sum(time_waited_micro) / 1000000 as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, sum(total_waits) as total_waits, sum(time_waited_micro) / 1000000 as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id
  ```

## application_wait

### 指标介绍

统计范围内，租户的 application 等待事件的平均耗时。

### 指标参数说明

|    **指标项**    |             **指标名称**              | **单位** |
|---------------|-----------------------------------|--------|
| application_wait | system_event_application_time_waited | μs    |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="APPLICATION",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## configuration_wait

### 指标介绍

统计范围内，租户的 configuration 等待事件平均耗时。

### 指标参数说明

|    **指标项**    |             **指标名称**              | **单位** |
|---------------|-----------------------------------|--------|
| configuration_wait | system_event_configuration_time_waited | μs    |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="CONFIGURATION",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## administrative_wait

### 指标介绍

统计范围内，租户的 administrative 等待事件平均耗时。

### 指标参数说明

|    **指标项**    |                **指标名称**                | **单位** |
|---------------|----------------------------------------|--------|
| administrative_wait | system_event_administrative_time_waited | μs    |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="ADMINISTRATIVE",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## concurrency_wait

### 指标介绍

统计范围内，租户的 concurrency 等待事件平均耗时。

### 指标参数说明

| **指标项** |          **指标名称**           | **单位** |
|---------|-----------------------------|--------|
| concurrency_wait | system_event_concurrency_time_waited | μs    |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="CONCURRENCY",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## commit_wait

### 指标介绍

统计范围内，租户的 commit 等待事件平均耗时。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| commit_wait | system_event_commit_time_waited | μs     |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="COMMIT",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## network_wait

### 指标介绍

统计范围内，租户的 network 等待事件平均耗时。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| network_wait | system_event_network_time_waited | μs     |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="NETWORK",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## user_io_wait

### 指标介绍

统计范围内，租户的 user_io 等待事件平均耗时。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| user_io_wait | system_event_user_io_time_waited | μs     |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="USER_IO",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## system_io_wait

### 指标介绍

统计范围内，租户的 system_io 等待事件平均耗时。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| system_io_wait | system_event_system_io_time_waited | μs     |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="SYSTEM_IO",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## cluster_wait

### 指标介绍

统计范围内，租户的 cluster 等待事件平均耗时。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| cluster_wait | system_event_cluster_time_waited | μs     |

### 计算表达式

sum(rate(ob_system_event_time_waited{event_group="CLUSTER",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, wait_class as event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

## other_wait

### 指标介绍

统计范围内，其他等待事件的平均耗时。

### 指标参数说明

|  **指标项**   |            **指标名称**            | **单位** |
|------------|--------------------------------|--------|
| other_wait | system_event_other_time_waited | μs     |

### 计算表达式

sum(rate(ob_system_event_total_waits{event_group="OTHER",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, case when event_id = 10000 then 'INTERNAL' when event_id = 13000 then 'SYNC_RPC' when event_id = 14003 then 'ROW_LOCK_WAIT' when (event_id >= 10001 and event_id <= 11006) or (event_id >= 11008 and event_id <= 11011) then 'IO' when event like 'latch:%' then 'LATCH' else 'OTHER' END event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, case when event_id = 10000 then 'INTERNAL' when event_id = 13000 then 'SYNC_RPC' when event_id = 14003 then 'ROW_LOCK_WAIT' when (event_id >= 10001 and event_id <= 11006) or (event_id >= 11008 and event_id <= 11011) then 'IO' when event like 'latch:%' then 'LATCH' else 'OTHER' END event_group, sum(total_waits) as total_waits, sum(time_waited_micro / 1000000) as time_waited from v$system_event where v$system_event.wait_class <> 'IDLE' and (con_id > 1000 or con_id = 1) group by tenant_id, event_group
  ```
