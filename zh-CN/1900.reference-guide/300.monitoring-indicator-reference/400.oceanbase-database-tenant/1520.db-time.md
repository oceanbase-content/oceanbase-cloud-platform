# DB Time

本节为您介绍 OceanBase 租户的监控指标 DB Time。DB Time 指租户数据库时间维度指标监控，OCP 为您提供了 DB Time 更细分的指标，包括：db_cpu（数据库实例执行数据库命令消耗的 ON CPU 时间，不包含后台任务）、
non_idle_wait_time（数据库实例执行数据库命令消耗非空闲等待时间，不包含后台任务）、
background_db_cpu（数据库后台任务消耗的 ON CPU 时间）
）、background_non_idle_wait_time（数据库后台任务消耗的非空闲等待时间）。您可指定统计范围，查询租户在单个 Zone 或 OBServer 节点的 **DB Time** 数据。

## db_cpu

### 指标介绍

统计范围内，数据库实例执行数据库命令消耗的 ON CPU 时间，不包含后台任务。

### 指标参数说明

| **指标项** |     **指标名称**      | **单位** |
|---------|-------------------|--------|
| db_cpu     | db_cpu |   μs    |

### 计算表达式

sum(rate(ob_sysstat{stat_id="200002",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id as tenant_id, stat_id, value from v$sysstat where stat_id IN (30066, 50003, 50021, 50022, 50030, 50039, 50040, 60031, 60057, 80023, 80025, 80026, 120002, 120005, 120006, 200001, 200002) and (con_id > 1000 or con_id = 1) UNION ALL select con_id, stat_id, value from v$sysstat where stat_id IN (80025,80026,80023) and con_id > 1 and con_id < 1001 UNION ALL select con_id as tenant_id, stat_id, value from v$sysstat where NAME = "memstore write lock wait timeout count" and (con_id > 1000 or con_id = 1)
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ tenant_id, stat_id, value from v$sysstat, DBA_OB_TENANTS where stat_id IN (30066, 50003, 50021, 50022, 50030, 50039, 50040, 60031, 60057, 60083, 80023, 80025, 80026, 120002, 120005, 120006, 200001, 200002) and (con_id > 1000 or con_id = 1) and DBA_OB_TENANTS.tenant_id = v$sysstat.con_id and DBA_OB_TENANTS.tenant_type<>'META' UNION ALL select con_id as tenant_id, stat_id, value from v$sysstat where stat_id IN (80025,80026,80023) and con_id > 1 and con_id < 1001
  ```

## non_idle_wait_time

### 指标介绍

统计范围内，数据库实例执行数据库命令消耗非空闲等待时间，不包含后台任务。

### 指标参数说明

| **指标项** |         **指标名称**         | **单位** |
|---------|--------------------------|--------|
| non_idle_wait_time     | non_idle_wait_time |   μs    |

### 计算表达式

sum(rate(ob_sysstat{stat_id="200010",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, stat_id, value from v$sysstat where stat_id IN (200010) and (con_id > 1000 or con_id = 1)
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, stat_id, value from v$sysstat where stat_id IN (200010) and (con_id > 1000 or con_id = 1)
  ```

## background_db_cpu

### 指标介绍

统计范围内，数据库后台任务消耗的 ON CPU 时间。

### 指标参数说明

| **指标项** |          **指标名称**          | **单位** |
|---------|----------------------------|--------|
| background_db_cpu     | background_db_cpu |   μs    |

### 计算表达式

sum(rate(ob_sysstat{stat_id="200006",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, stat_id, value from v$sysstat where stat_id IN (200006) and (con_id > 1000 or con_id = 1)
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, stat_id, value from v$sysstat where stat_id IN (200006) and (con_id > 1000 or con_id = 1)
  ```

## background_non_idle_wait_time

### 指标介绍

统计范围内，数据库后台任务消耗的非空闲等待时间。

### 指标参数说明

| **指标项** |         **指标名称**          | **单位** |
|---------|---------------------------|--------|
| background_non_idle_wait_time     | background_non_idle_wait_time | μs      |

### 计算表达式

sum(rate(ob_sysstat{stat_id="200013",@LABELS}[@INTERVAL])) by (@GBLABELS)

### 采集 SQL

* OceanBase V4.0 以下版本：

  ```sql
  select /*+ MONITOR_AGENT READ_CONSISTENCY(WEAK) */ con_id tenant_id, stat_id, value from v$sysstat where stat_id IN (200013) and (con_id > 1000 or con_id = 1)
  ```

* OceanBase V4.0 及以上版本：

  ```sql
  select /* MONITOR_AGENT */ con_id tenant_id, stat_id, value from v$sysstat where stat_id IN (200013) and (con_id > 1000 or con_id = 1)
  ```
