# 日常切换

## 功能说明

该接口用于主备租户日常切换（Switchover）。

## 调用说明

### 接口约束

* 调用者需具备修改租户的权限。

   关于调用者的权限，详情可参见 [用户及权限概述](../../../1600.system-management-features/200.manage-users/50.user-management-overview.md)。

* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/tenants/{tenantId}/switchover`

### 请求参数

**Path 参数**

| 参数 | 类型    | 必选 | 示例值 | 描述           |
|------|---------|------|--------|-----------------|
| id   | Integer | 是   | 1      | 集群唯一标识符。 |
| tenantId |  Integer | 是   | 1001      | 租户的 ID。 |

**Body 参数**

|  参数  |  类型  |  必选  |  示例值  |  描述  |
|---------|---------|----------|---------|----------|
| tenantId  |  Long  |  是  |  1  | 主租户 ID。 |
| standbyTenantId | Long | 是 | 2 | 备租户 ID。 |

### 返回结果

|  参数  |  类型  |  说明  |
|-----------|----------|----------|
|  data  |  TaskInstance  | 异步任务信息，详情参见 [任务信息](../400.task-return-structure.md)。 |
|  successful  |  Boolean  |  请求是否成功。  |
|  timestamp  |  Datetime  |  服务端完成请求的时间戳。  |
|  duration  |  Integer  |  服务端处理请求的时间（毫秒）。  |
|  status  |  Integer  |  符合 HTTP Status 规范的编码。  |
|  traceId  |  String  |  请求的 Trace ID，用于排查问题。  |
|  server  |  String  |  响应请求的应用服务的地址。  |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/{id}/tenants/{tenantId}/switchover`

**Body：**

```json
{
  "tenantId": 1,
  "standbyTenantId": 2
}
```

### 返回示例

```json
{
    "data": {
        "clusterId": 3000009,
        "creator": "admin",
        "executor": "xxx.xxx.xxx.xxx",
        "id": 12022212,
        "name": "Switchover ob tenant for network mode",
        "operation": "EXECUTE",
        "prohibitRollback": false,
        "startTime": "2024-07-23T17:20:55.929+08:00",
        "status": "RUNNING",
        "subtasks": [
            {
                "description": "Wait all relation tenants accessible",
                "downstreams": [
                    13025741
                ],
                "id": 13025745,
                "name": "Wait all relation tenants accessible",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 0,
                "status": "PENDING",
                "timeout": 3600,
                "upstreams": [
                    13025747
                ]
            },
            {
                "description": "Switch primary tenant to standby",
                "downstreams": [
                    13025740
                ],
                "id": 13025741,
                "name": "Switch primary tenant to standby",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 1,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025745
                ]
            },
            {
                "description": "Create standby tenant read only user",
                "downstreams": [
                    13025745
                ],
                "id": 13025747,
                "name": "Create standby tenant read only user",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 5,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025743
                ]
            },
            {
                "description": "Switchover standby tenant to primary",
                "downstreams": [
                    13025742
                ],
                "id": 13025740,
                "name": "Switchover standby tenant to primary",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": true,
                "runTime": 1,
                "seriesId": 7,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025741
                ]
            },
            {
                "description": "Update log restore source",
                "downstreams": [
                    13025746
                ],
                "id": 13025744,
                "name": "Update log restore source",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 8,
                "status": "PENDING",
                "timeout": 900,
                "upstreams": [
                    13025742
                ]
            },
            {
                "description": "Reset switchover tenant info",
                "downstreams": [],
                "id": 13025748,
                "name": "Reset switchover tenant info",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 6,
                "status": "PENDING",
                "timeout": 120,
                "upstreams": [
                    13025739
                ]
            },
            {
                "description": "Restart tenant service name if started",
                "downstreams": [
                    13025739
                ],
                "id": 13025746,
                "name": "Restart tenant service name if started",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 9,
                "status": "PENDING",
                "timeout": 600,
                "upstreams": [
                    13025744
                ]
            },
            {
                "description": "Update tenant role in meta",
                "downstreams": [
                    13025748
                ],
                "id": 13025739,
                "name": "Update tenant role in meta",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 4,
                "status": "PENDING",
                "timeout": 120,
                "upstreams": [
                    13025746
                ]
            },
            {
                "description": "Reset log restore source",
                "downstreams": [
                    13025744
                ],
                "id": 13025742,
                "name": "Reset log restore source",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 2,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025740
                ]
            },
            {
                "description": "Prepare switchover tenant",
                "downstreams": [
                    13025747
                ],
                "id": 13025743,
                "name": "Prepare switchover tenant",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 3,
                "status": "READY",
                "timeout": 60,
                "upstreams": []
            }
        ],
        "taskDefinitionId": -1,
        "tenantId": 2000022,
        "type": "MANUAL"
    },
    "duration": 396,
    "server": "3af57a8e6b",
    "status": 200,
    "successful": true,
    "timestamp": "2024-07-23T17:20:55.98+08:00",
    "traceId": "94bc249dd98d432f"
}
```
