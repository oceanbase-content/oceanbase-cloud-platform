# 日常切换预检查

## 功能说明

该接口用于主备租户日常切换（Switchover）预检查。

## 调用说明

### 接口约束

* 调用者需具备修改租户的权限。

    关于调用者的权限，详情可参见 [用户及权限概述](../../../1600.system-management-features/200.manage-users/50.user-management-overview.md)。

* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/tenants/{tenantId}/switchoverPreCheck`

### 请求参数

**Path 参数**

| 参数 | 类型    | 必选 | 示例值 | 描述           |
|------|---------|------|--------|-----------------|
| id   | Integer | 是   | 1      | 集群唯一标识符。 |
| tenantId |  Integer | 是   | 1001      | 租户的 ID。 |

**Body 参数**

| 参数  |  类型  |  必选  | 示例值  |  描述  |
|-------|--------|---------|---------|---------|
| tenantId  |  Long  |  是  |  1  | 主租户 ID。 |
| standbyTenantId | Long | 是 | 2 | 备租户 ID。 |

### 返回结果

|  参数  |  类型  |  说明  |
|---------|---------|---------|
|  data        |  SwitchoverPreCheckResult  | 检查结果，详情参见 **SwitchoverPreCheckResult 数据结构**。 |
|  successful  |  Boolean  |  请求是否成功。  |
|  timestamp   |  Datetime  |  服务端完成请求的时间戳。  |
|  duration    |  Integer  |  服务端处理请求的时间（毫秒）。  |
|  status      |  Integer  |  符合 HTTP Status 规范的编码。  |
|  traceId     |  String  |  请求的 Trace ID，用于排查问题。  |
|  server      |  String  |  响应请求的应用服务的地址。  |

**SwitchoverPreCheckResult 数据结构**

|  参数     |  类型   |  说明  |
|-----------|---------|------------|
| valid               | Boolean | 预检查是否通过。 |
| tenantId            | Long    | 主租户 ID。 |
| name                | String  | 主租户名。 |
| clusterId           | Long    | 主租户的集群 ID。 |
| clusterName         | String  | 主租户的集群名。 |
| standbyCheckResults | ObTenantPreCheckResult    | 详情参见 **ObTenantPreCheckResult 数据结构**。 |

**ObTenantPreCheckResult 数据结构**

|  参数  |  类型  |  说明  |
|--------------------------|---------------------|-----------|
| valid                    | Boolean             | 备租户是否允许切换。 |
| tenantId                 | Long                | 备租户 ID。 |
| name                     | String              | 备租户名。 |
| clusterId                | Long                | 备租户的集群 ID。 |
| clusterName              | String              | 备租户的集群名。 |
| syncScn                  | Long                | 备租户同步延迟。 |
| primaryTenantServiceName | String              | 主租户服务名。 |
| checkResults             | PreCheckResult      | 失败信息列表，详情参见 **PreCheckResult 数据结构**。 |

**PreCheckResult 数据结构**

|  参数        |  类型   |  说明     |
|--------------|---------|-----------|
| warning      | Boolean | 是否为警告，值为 `true` 时表示警告，不影响切换流程；值为 `false` 时表示错误，影响切换。 |
| errorCode    | String  | 异常码。 |
| errorMessage | String  | 异常信息。 |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/{id:[\\d]+}/tenants/{tenantId:[\\d]+}/switchoverPreCheck`

**Body：**

```json
{
  "tenantId": 1,
  "standbyTenantId": 2
}
```

### 返回示例

```json
{
    "data": {
        "clusterId": 3000009,
        "clusterName": "OB42_B",
        "name": "ohayo_1",
        "standbyCheckResults": [
            {
                "checkResults": [
                    {
                        "errorCode": "OBE26009",
                        "errorMessage": "租户 ohayo_2 的日志同步延迟 14883430 ms 大于 10000 ms, 不允许该操作",
                        "warning": false
                    },
                    {
                        "errorCode": "OBE26107",
                        "errorMessage": "主备租户所属集群没有关联共同的ObProxy, 切主后无法实现自动路由",
                        "warning": true
                    }
                ],
                "clusterId": 3000010,
                "clusterName": "OB424_A",
                "name": "ohayo_2",
                "tenantId": 2000025,
                "valid": false
            }
        ],
        "tenantId": 2000022,
        "valid": false
    },
    "duration": 624,
    "server": "3af57a8e6b",
    "status": 200,
    "successful": true,
    "timestamp": "2024-07-23T17:15:57.809+08:00",
    "traceId": "ba76464b48326028"
}
```
