# 创建备租户

## 功能说明

该接口用于为指定 OceanBase 集群创建一个备租户。

## 调用说明

### 接口约束

* 调用者需具备集群的修改权限。

  关于调用者的权限，详情可参见 [用户及权限概述](../../../1600.system-management-features/200.manage-users/50.user-management-overview.md)。

* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/tenants/createStandbyTenant`

### 请求参数

**Path 参数**

| 参数 | 类型    | 必选 | 示例值 | 描述           |
|------|---------|------|--------|-----------------|
| id   | Integer | 是   | 1      | 集群唯一标识符。 |

**Body 参数**

| 参数              | 类型 | 必选 | 示例值 | 描述 |
|-------------------|---------|--------|--------|---------|
| name              | String                     | 是 | standbyA | 租户名。 |
| primaryZone       | String                     | 否 | zone1;zone2;zone3 | primaryZone 设置。 |
| primaryTenantId   | Integer                    | 是 | 1 | 主租户主键 ID。 |
| logTransportMode  | String                     | 是 | NETWORK | 包括基于网络（NETWORK）和基于日志备份（LOG_BACKUP）。|
| restoreTenant     | Boolean                    | 否 | false | 是否使用备份集恢复备租户，仅 `logTransportMode` 为 `NETWORK` 时有效，表示是否基于备份集创建网络备库。 |
| enableArbitration | Boolean                    | 否 | false | 是否开启仲裁。 |
| backupConfig      | BackupConfigParam          | 否 | - | 备份集信息。当直接创建网络备库或使用 OCP 已有的备份策略创建备库时不需要传该参数，详情参见 **BackupConfigParam 数据结构**。 |
| zones             | ZoneParam            | 是 | - | 副本 Zone 配置。 |
| parameters        | TenantParameterParam | 否 | - | 租户参数。 |
| description       | String                     | 否 | this is standby tenant | 描述。 |

**BackupConfigParam 数据结构**

| 参数              | 类型    | 必选   | 示例值   | 描述  |
|-------------------|---------|-------|----------|-------|
| backupStorageType | Enum    | 是    | BACKUP_STORAGE_FILE | <li>BACKUP_STORAGE_FILE：NFS 存储。<li></li>BACKUP_STORAGE_OSS: OSS 存储。<li></li> BACKUP_STORAGE_COS: COS 存储。<li></li>BACKUP_STORAGE_S3: S3 存储。</li> |
| dataBackupUrl     | String  | 是    | `/obbackup/clusterA/tenantA/data` | 数据备份目录。 |
| logBackupUrl      | String  | 是    | `/obbackup/clusterA/tenantA/clog` | 日志备份目录。 |
| ossSecretModel    | ObjectStorageSecretParam       | 否    | - | 对象存储密钥信息，仅存储模式为 OSS/COS/S3 时需要传该参数，详情参见 **ObjectStorageSecretParam 数据结构**。 |

**ObjectStorageSecretParam 数据结构**

| 参数 | 类型 | 必选 | 示例值 | 描述 |
|-----------------|--------|------|-------|--------|
| endpoint        | String | 是 | `oss.endpoint.sahnghai.com` | 对象存储域名。 |
| accessKeyId     | String | 是 | - | 对象存储 AK。 |
| accessKeySecret | String | 是 | - | 对象存储 SK。 |
| region          | String | 否 | - | 地域信息，允许为空。仅 AWS 原生 S3 存储介质需要输入地域信息。  |
| appId           | String | 否 | - | APP ID，仅 COS 存储需要传该参数。 |

### 返回结果

**基础数据结构**

| 参数 | 类型 | 说明 |
|---------|---------|---------|
| data | Object | 异步任务信息，详情参见 [任务信息](../400.task-return-structure.md)。 |
| successful | Boolean | 请求是否成功。 |
| timestamp | Datetime | 服务端完成请求的时间戳。 |
| duration | Integer | 服务端处理请求的时间（毫秒）。 |
| status | Integer | 符合 HTTP Status 规范的编码。 |
| traceId | String | 请求的 Trace ID，用于排查问题。 |
| server | String | 响应请求的应用服务的地址。 |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/{id}/tenants/createStandbyTenant`

**Body：**

```json
{
    "enableArbitration": false,
    "backupConfig": null,
    "zones": [
        {
            "name": "zone1",
            "replicaType": "FULL",
            "resourcePool": {
                "unitSpecName": "S1",
                "unitCount": 1
            }
        }
    ],
    "primaryTenantId": 2000022,
    "name": "ohayo_2",
    "logTransportMode": "NETWORK",
    "serviceName": "SERVICE_C",
    "parameters": [
        {
            "name": "connect_timeout",
            "value": "2000",
            "parameterType": "OB_SYSTEM_VARIABLE"
        }
    ]
}
```

### 返回示例

```json
{
    "data": {
        "clusterId": 3000010,
        "creator": "admin",
        "executor": "xxx.xxx.xxx.xxx",
        "id": 12022234,
        "name": "Create network standby tenant",
        "operation": "EXECUTE",
        "prohibitRollback": false,
        "startTime": "2024-07-23T17:55:37.066+08:00",
        "status": "RUNNING",
        "subtasks": [
            {
                "description": "Create tenant service name",
                "downstreams": [
                    13025800
                ],
                "id": 13025806,
                "name": "Create tenant service name",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 2,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025803
                ]
            },
            {
                "description": "Create standby tenant read only user",
                "downstreams": [
                    13025804
                ],
                "id": 13025808,
                "name": "Create standby tenant read only user",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 4,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025807
                ]
            },
            {
                "description": "Update tenant status",
                "downstreams": [],
                "id": 13025799,
                "name": "Update tenant status",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 5,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13025797
                ]
            },
            {
                "description": "Sync tenant information",
                "downstreams": [
                    13025797
                ],
                "id": 13025800,
                "name": "Sync tenant information",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 6,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13025806
                ]
            },
            {
                "description": "Create resource pool",
                "downstreams": [
                    13025808
                ],
                "id": 13025807,
                "name": "Create resource pool",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 3,
                "status": "PENDING",
                "timeout": 600,
                "upstreams": [
                    13025798
                ]
            },
            {
                "description": "Set ob tenant parameters",
                "downstreams": [
                    13025799
                ],
                "id": 13025797,
                "name": "Set ob tenant parameters",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 7,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13025800
                ]
            },
            {
                "description": "Check tenant log transport status ok",
                "downstreams": [
                    13025806
                ],
                "id": 13025803,
                "name": "Check tenant log transport status ok",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 10,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025801
                ]
            },
            {
                "description": "Wait all relation tenants accessible",
                "downstreams": [
                    13025805
                ],
                "id": 13025804,
                "name": "Wait all relation tenants accessible",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 0,
                "status": "PENDING",
                "timeout": 3600,
                "upstreams": [
                    13025808
                ]
            },
            {
                "description": "Wait ob tenant accessible",
                "downstreams": [
                    13025801
                ],
                "id": 13025802,
                "name": "Wait ob tenant accessible",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 9,
                "status": "PENDING",
                "timeout": 600,
                "upstreams": [
                    13025805
                ]
            },
            {
                "description": "Set standby tenant continuous recovery",
                "downstreams": [
                    13025803
                ],
                "id": 13025801,
                "name": "Set standby tenant continuous recovery",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 1,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13025802
                ]
            },
            {
                "description": "Create standby tenant",
                "downstreams": [
                    13025802
                ],
                "id": 13025805,
                "name": "Create standby tenant",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 11,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13025804
                ]
            },
            {
                "description": "Prepare create tenant",
                "downstreams": [
                    13025807
                ],
                "id": 13025798,
                "name": "Prepare create tenant",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "runTime": 1,
                "seriesId": 8,
                "status": "READY",
                "timeout": 30,
                "upstreams": []
            }
        ],
        "taskDefinitionId": -1,
        "tenantId": 2000026,
        "type": "MANUAL"
    },
    "duration": 197,
    "server": "3af57a8e6b",
    "status": 200,
    "successful": true,
    "timestamp": "2024-07-23T17:55:37.11+08:00",
    "traceId": "ee452617f4e04661"
}
```
