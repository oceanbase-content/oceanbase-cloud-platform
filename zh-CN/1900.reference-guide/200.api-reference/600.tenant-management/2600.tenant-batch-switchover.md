# 批量日常切换

## 功能说明

该接口用于对主备租户批量日常切换（Switchover）。

## 调用说明

### 接口约束

* 调用者需具备目标租户或所属 OceanBase 集群的维护权限。

    关于调用者的权限，详情可参见 [用户及权限概述](../../../1600.system-management-features/200.manage-users/50.user-management-overview.md)。

* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/tenants/switchover`

### 请求参数

**Path 参数**

| 参数 | 类型    | 必选 | 示例值 | 描述           |
|------|---------|------|--------|-----------------|
| id   | Integer | 是   | 1      | 集群唯一标识符。 |

**Body 参数**

| 参数 | 类型 | 必选 | 示例值 | 描述 |
|---------|----------|----------|----------|----------|
| tenantParamList | SwitchoverObTenantParam | 是 | - | 每一个 Item 是一个需要切换的主备租户，详情参见 **SwitchoverObTenantParam 数据结构**。 |

**SwitchoverObTenantParam 数据结构**

| 参数 | 类型 | 必选 | 示例值 | 描述 |
|----------|----------|----------|-----------|----------|
| tenantId | Long | 是 | 1 | 主租户 ID。 |
| standbyTenantId | Long | 是 | 2 | 备租户 ID。 |

### 返回结果

| 参数 | 类型 | 说明 |
|-----------|-----------|------------|
| data | TaskInstance | 多个异步任务信息，详情参见 [任务信息](../400.task-return-structure.md)。 |
| successful | Boolean | 请求是否成功。 |
| timestamp | Datetime | 服务端完成请求的时间戳。 |
| duration | Integer | 服务端处理请求的时间（毫秒）。 |
| status | Integer | 符合 HTTP Status 规范的编码。 |
| traceId | String | 请求的 Trace ID，用于排查问题。 |
| server | String | 响应请求的应用服务的地址。 |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/{id}/tenants/switchover`

**Body：**

```json
{
  "tenantParamList":[
    {
      "tenantId": 1,
      "standbyTenantId": 2,
    }
  ]
}
```

### 返回示例

```json
{
    "data": {
        "contents": [
            {
                "clusterId": 3000010,
                "creator": "admin",
                "executor": "xxx.xxx.xxx.xxx",
                "id": 12022221,
                "name": "Switchover ob tenant for network mode",
                "operation": "EXECUTE",
                "prohibitRollback": false,
                "startTime": "2024-07-23T17:38:33.977+08:00",
                "status": "RUNNING",
                "subtasks": [
                    {
                        "description": "Update log restore source",
                        "downstreams": [
                            13025765
                        ],
                        "id": 13025763,
                        "name": "Update log restore source",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": 0,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 7,
                        "status": "PENDING",
                        "timeout": 900,
                        "upstreams": [
                            13025759
                        ]
                    },
                    {
                        "description": "Switchover standby tenant to primary",
                        "downstreams": [
                            13025759
                        ],
                        "id": 13025760,
                        "name": "Switchover standby tenant to primary",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": true,
                        "runTime": 1,
                        "seriesId": 5,
                        "status": "PENDING",
                        "timeout": 1800,
                        "upstreams": [
                            13025758
                        ]
                    },
                    {
                        "description": "Reset log restore source",
                        "downstreams": [
                            13025763
                        ],
                        "id": 13025759,
                        "name": "Reset log restore source",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 2,
                        "status": "PENDING",
                        "timeout": 1800,
                        "upstreams": [
                            13025760
                        ]
                    },
                    {
                        "description": "Create standby tenant read only user",
                        "downstreams": [
                            13025757
                        ],
                        "id": 13025762,
                        "name": "Create standby tenant read only user",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 0,
                        "status": "PENDING",
                        "timeout": 1800,
                        "upstreams": [
                            13025761
                        ]
                    },
                    {
                        "description": "Reset switchover tenant info",
                        "downstreams": [],
                        "id": 13025764,
                        "name": "Reset switchover tenant info",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 3,
                        "status": "PENDING",
                        "timeout": 120,
                        "upstreams": [
                            13025766
                        ]
                    },
                    {
                        "description": "Wait all relation tenants accessible",
                        "downstreams": [
                            13025758
                        ],
                        "id": 13025757,
                        "name": "Wait all relation tenants accessible",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 8,
                        "status": "PENDING",
                        "timeout": 3600,
                        "upstreams": [
                            13025762
                        ]
                    },
                    {
                        "description": "Restart tenant service name if started",
                        "downstreams": [
                            13025766
                        ],
                        "id": 13025765,
                        "name": "Restart tenant service name if started",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 6,
                        "status": "PENDING",
                        "timeout": 600,
                        "upstreams": [
                            13025763
                        ]
                    },
                    {
                        "description": "Update tenant role in meta",
                        "downstreams": [
                            13025764
                        ],
                        "id": 13025766,
                        "name": "Update tenant role in meta",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 9,
                        "status": "PENDING",
                        "timeout": 120,
                        "upstreams": [
                            13025765
                        ]
                    },
                    {
                        "description": "Switch primary tenant to standby",
                        "downstreams": [
                            13025760
                        ],
                        "id": 13025758,
                        "name": "Switch primary tenant to standby",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 4,
                        "status": "PENDING",
                        "timeout": 1800,
                        "upstreams": [
                            13025757
                        ]
                    },
                    {
                        "description": "Prepare switchover tenant",
                        "downstreams": [
                            13025762
                        ],
                        "id": 13025761,
                        "name": "Prepare switchover tenant",
                        "nodeType": "JAVA_TASK",
                        "operation": "EXECUTE",
                        "parallelIdx": -1,
                        "prohibitRollback": false,
                        "runTime": 1,
                        "seriesId": 1,
                        "status": "READY",
                        "timeout": 60,
                        "upstreams": []
                    }
                ],
                "taskDefinitionId": -1,
                "tenantId": 2000025,
                "type": "MANUAL"
            }
        ]
    },
    "duration": 331,
    "server": "3af57a8e6b",
    "status": 200,
    "successful": true,
    "timestamp": "2024-07-23T17:38:34.021+08:00",
    "traceId": "1d576119daa4860a"
}
```
