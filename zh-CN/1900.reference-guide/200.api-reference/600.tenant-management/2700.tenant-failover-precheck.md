# 容灾切换预检查

## 功能说明

该接口用于基于网络的主备租户容灾切换（Failover）预检查。

## 调用说明

### 接口约束

* 调用者需具备目标租户或所属 OceanBase 集群的维护权限。

    关于调用者的权限，详情可参见 [用户及权限概述](../../../1600.system-management-features/200.manage-users/50.user-management-overview.md)。

* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/tenants/{tenantId}/failoverPreCheck`

### 请求参数

| 参数 | 类型 | 必选 | 示例值 | 描述 |
|----------|-----------|----------|----------|----------|
| id       | Integer | 是   | 1   | 集群唯一标识符。 |
| tenantId | Integer    | 是   | 1   | 备租户 ID。 |

### 返回结果

| 参数 | 类型 | 说明 |
|-----------|----------|------------|
| data | ObTenantPreCheckResult | 检查结果，详情参见 **ObTenantPreCheckResult 数据结构**。 |
| successful | Boolean | 请求是否成功。 |
| timestamp | Datetime | 服务端完成请求的时间戳。 |
| duration | Integer | 服务端处理请求的时间（毫秒）。 |
| status | Integer | 符合 HTTP Status 规范的编码。 |
| traceId | String | 请求的 Trace ID，用于排查问题。 |
| server | String | 响应请求的应用服务的地址。 |

**ObTenantPreCheckResult 数据结构**

| 参数 | 类型 | 说明 |
|------------|-----------|-----------|
| valid | Boolean | 备租户是否允许切换。 |
| tenantId | Long | 备租户 ID。 |
| name | String | 备租户名。 |
| clusterId | Long | 备租户的集群 ID。 |
| clusterName | String | 备租户的集群名。 |
| syncScn | Long | 备租户同步延迟。 |
| primaryTenantServiceName | String | 主租户服务名。 |
| checkResults | PreCheckResult | 失败信息列表，详情参见 **PreCheckResult 数据结构**。 |

**PreCheckResult 数据结构**

| 参数 | 类型 | 说明 |
|----------|----------|-----------|
| warning | Boolean | 是否为警告，值为 `true` 时表示警告，不影响切换流程；值为 `false` 时表示错误，影响切换。 |
| errorCode | String | 异常码。 |
| errorMessage | String | 异常信息。 |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/{id}/tenants/{tenantId}/failoverPreCheck`

### 返回示例

```json
{
  "data": {
    "checkResults": [
      {
        "errorCode": "OBE26107",
        "errorMessage": "主租户仍可连接, 不允许容灾切换",
        "warning": false
      }
    ],
    "clusterId": 3000010,
    "clusterName": "OB424_A",
    "name": "ohayo_2",
    "primaryTenantServiceName": "SERVICE_C",
    "tenantId": 2000025,
    "valid": false
  },
  "duration": 10165,
  "server": "3af57a8e6b",
  "status": 200,
  "successful": true,
  "timestamp": "2024-07-23T17:42:33.754+08:00",
  "traceId": "8a4d817ee7e5aed8"
}
```
