# 查询慢 SQL 列表

## 功能说明

该接口用于查询慢 SQL 列表。

## 调用说明

### 接口约束

调用者需具备指定租户的读权限。

### 请求路径

`GET /api/v2/ob/clusters/{clusterId}/tenants/{tenantId}/slowSql`

### 请求参数

|     名称   |   类型    | 必填 |    示例值    |    描述    |  
|------------|---------|----|--------|----|
| clusterId  | Integer  | 是  |  1  | 集群的 ID。      |
| tenantId   | Integer  | 是  |  10001  |  租户的 ID。      |
| startTime  | Datetime | 是  | 2023-04-12T04:38:38Z        | 查看慢 SQL 历史参数的起始时间。 该时间只支持 UTC 时间，格式为：YYYY-MM-DDThh:mm:ssZ。    |
| endTime    | Datetime | 是  | 2023-04-12T05:38:38Z        | 查看慢 SQL 历史参数的起始时间。 该时间只支持 UTC 时间，格式为：YYYY-MM-DDThh:mm:ssZ。   |
| serverId   | Integer  | 否  | 300        | 查询在指定 OceanBase 服务器上的计划的性能。不指定时，查询 SQL 在所有服务器上的计划的性能。 |
| inner      | boolean  | 否  |  是否为内部 SQL。  |
| sqlText    | String   | 否  |  hello      | SQL 包含的关键词，关键词不区分大小写。  |
| searchAttr | String   | 否  | executions     | 高级搜索的指标名。需要同时传入 searchOp 和 seachVal 才会生效。  |
| searchOp   | String   | 否  | GT  | 高级搜索的运算符。需要同时传入 searchAttr 和 searchVal 才会生效。取值范围： <li>EQ：等于  </li><li> NE：不等于  </li><li> GT：大于 </li><li> GE：大于或等于  </li><li>LT：小于 </li><li> LE：小于或等于 </li>   |
| searchVal  | String   | 否  | 1543       |  高级搜索的值。需要同时传入 searchAttr 和 searchOp 才会生效。   |
| filterExpression  |  String  | 否  |  -  |   自定义过滤表达式，多个过滤条件用 and 或 or 连接。  |
| limit      | Integer  | 否  |  3  |   返回 TOP 数目 |
| sqlTextLength   |  Integer  | 否  |  65535   |  返回 SQL 文本的最大长度。  |
| dynamicSql | Boolean  | 否  | false   |  是否为动态 SQL。<main id="notice" type='explain'><h4>说明</h4><p>表示传入的 SQL ID 是否为动态 SQL 的 ID。</p></main>   |
| mergeDynamicSql  |  Boolean   | 否  | true  |  返回结果时，是否合并动态 SQL。 <main id="notice" type='explain'><h4>说明</h4><p>表示输出结果时，是否聚合 in 查询的 SQL 的结果。</p></main>   |

### 返回结果

* 基础数据结构

  |     参数    |    类型  |          说明           |
  |-------------|----------|-------------------------|
  | data        | Object   | 请求的数据。                |
  | ├─ contents | Array    | SlowSQL 的数据列表，数据结构见下表。    |
  | successful  | Boolean  | 请求是否成功。               |
  | timestamp   | Datetime | 服务端完成请求的时间戳。          |
  | status      | Integer  | 符合 HTTP Status 规范的编码。 |
  | traceId     | String   | 请求的 Trace Id，用于排查问题。  |
  | server      | String   | 响应请求的应用服务的地址。         |

* SlowSQL 的数据结构

  |    名称  |       类型   |   描述        |
  |------|---------|--------|
  | data  | object    |  请求的返回结果。    |
  | avgAffectedRows |  Double  | 平均影响行数。 |
  | avgApplicationWaitTime  |   Double  |  平均应用等待时间（毫秒）。|
  | avgBlockCacheHit" |   Double  |  平均 Block Cache 命中数。  |
  | avgBlockIndexCacheHit" |  Double  |  平均 Block Index Cache 命中数。  |
  | avgBloomFilterCacheHit |  Double  |  平均 Bloom Filter Cache 命中数。  |
  | avgConcurrencyWaitTime  |  Double  |  平均应用等待时间（毫秒）。  |
  | avgCpuTime  |  Double  |  平均 CPU 时间（毫秒）。  |
  | avgDecodeTime |  Double  |  平均语法解析时间（毫秒）。  |
  | avgDiskReads  |  Double  |  平均磁盘读次数。  |
  | avgElapsedTime |  Double  |  平均响应时间（毫秒）。  |
  | avgExecuteTime   |  Double  |  SQL 平均执行时间（毫秒）。  |
  | avgExecutorRpcCount  |  Double  | SQL 远程执行次数，对应 `v$sl_audit.executor_rpc`。   |
  | avgGetPlanTime  |  Double  | 平均计划生成时间（毫秒）。  |
  | avgLogicalReads   |  Double  |  平均逻辑读数。  |
  | avgMemstoreReadRows   |  Double  |  平均 Memstore 读行数。  |
  | avgNetTime   |  Double  |  SQL 平均网络 IO 时间（毫秒）。  |
  | avgNetWaitTime   |  Double  |   平均网络时间（毫秒）。  |
  | avgPartitionCount   |  Double  |  平均访问分区数。  |
  | avgQueueTime   |  Double  |  平均排队时间（毫秒）。  |
  | avgReturnRows   |  Double  |  平均返回行数。  |
  | avgRowCacheHit   |  Double  |  平均 Row Cache 命中次数。  |
  | avgRpcCount   |  Double  |  SQL 平均 RPC 次数。  |
  | avgScheduleTime   |  Double  |  平均调度时间（毫秒）。  |
  | avgSsstoreReadRows   |  Double  |  平均 SSTable 读行数。  |
  | avgUserIoWaitTime   |  Double  |  平均用户 IO 时间（毫秒）。  |
  | avgWaitCount   |  Double  |  SQL 平均等待次数。  |
  | avgWaitTime   |  Double  | 平均等待时间（毫秒）。  |
  | dbName   |  String  | 数据库名。  |
  | distPlanPercentage   |  Double  |  SQLDistributed 计划比例。  |
  | dynamicSql   |  Boolean  | 是否为动态 SQL。  |
  | execPs   |  Double  |  期间的平均每秒执行次数。 |
  | executions   |  Double  |  期间的总执行次数。  |
  | failCount  |  Double  |  执行出错次数。   |
  | failPercentage  |  Double  | SQL 执行错误率。   |
  | inner  |  Boolean  | 是否为内部 SQL。   |
  | lastFailCode  |  Long    |  最后一次执行出错的错误码。  |
  | lastFailTimestamp  |  Datetime   |  最后一次执行出错的时间戳。  |
  | localPlanPercentage  |  Double  | SQL Local 计划比例。  |
  | maxAffectedRows  |  Double  | SQL 最大影响行数。  |
  | maxApplicationWaitTime  |  Double  | SQL 最大应用等待时间（毫秒）。  |
  | maxConcurrencyWaitTime  |  Double  | SQL 最大并发等待时间（毫秒）。  |
  | maxCpuTime  |  Double  | 最大 CPU 时间。  |
  | maxDiskReads  |  Double  | 最大磁盘读次数。  |
  | maxElapsedTime  |  Double  | SQL 最大响应时间。  |
  | maxReturnRows  |  Double  |  SQL 最大返回行数。  |
  | maxUserIoWaitTime  |  Double  |  SQL 最大 IO 等待时间（毫秒）。  |
  | missPlanPercentage  |  Double  |  SQL 未命中计划比例。  |
  | obDbId  |  Long   |  OceanBase 侧集群 ID。  |
  | obTenantId  | Long  |  OceanBase 侧租户 ID。  |
  | remotePlanPercentage  |  Double  |  SQL Remote 计划比例。  |
  | retCode4012Count  |  Long  |  错误码 4012 出现次数。  |
  | retCode4013Count  |  Long  |  错误码 4013 出现次数。  |
  | retCode5001Count  |  Long  |  错误码 5001 出现次数。  |
  | retCode5024Count  |  Long  |  错误码 5024 出现次数。  |
  | retCode5167Count  |  Long  |  错误码 5167 出现次数。  |
  | retCode5217Count  |  Long  |  错误码 5217 出现次数。  |
  | retCode6002Count  |  Long  |  错误码 6002 出现次数。  |
  | retryCount  |  Double  |  重试次数。  |
  | server  |  String  |  响应请求的应用服务的地址。  |
  | serverIp  |  String  |  所属 OBServer 节点 IP。  |
  | sqlId  |  String  |  SQL 的 ID。  |
  | sqlTextShort  |  String  | SQL 文本（前 100 字符）。  |
  | sqlType |  String  | SQL 类型。  |
  | strongConsistencyPercentage  |  Double  | SQL 强读比例。  |
  | sumCpuTimeMs  |  Double   |  总 CPU 时间（毫秒）。  |
  | sumElapsedTime  |  Double  | SQL 总响应时间（毫秒）。  |
  | sumLogicalReads  |  Double  |  总逻辑读数。   |
  | sumWaitTime   |  Double  |  SQL 最大等待事件的等待时间（毫秒）。   |
  | tableScanPercentage  |  Double  |  SQL 全表扫描比率。   |
  | tenantId  |  integer  |  租户 ID。  |
  | tenantName  |  String  |  租户名。  |
  | userName   |  String  |   用户名。  |
  | waitEvent  |  String  |   最长等待事件。  |
  | weakConsistencyPercentage   |  Double  |  SQL 弱读比例。   |

## 示例

### 请求示例

查询集群 ID 为 250 、租户 ID 为 1196 的 SlowSQL，时间范围为 2024-07-28T00:00:00+08:00 ～ 2024-07-29T00:00:00+08:00。

```javascript
GET /api/v2/ob/clusters/250/tenants/1196/slowSql?startTime=2024-07-28T00%3A00%3A00%2B08%3A00&endTime=2024-07-29T00%3A00%3A00%2B08%3A00
```

### 返回示例

```json
{
  "data": {
    "contents": [
      {
        "avgAffectedRows": 0,
        "avgApplicationWaitTime": 0,
        "avgBlockCacheHit": 0,
        "avgBlockIndexCacheHit": 0,
        "avgBloomFilterCacheHit": 0,
        "avgConcurrencyWaitTime": 0,
        "avgCpuTime": 108.49,
        "avgDecodeTime": 0,
        "avgDiskReads": 0,
        "avgElapsedTime": 108.49,
        "avgExecuteTime": 108.27,
        "avgExecutorRpcCount": 0,
        "avgGetPlanTime": 0.22,
        "avgLogicalReads": 0,
        "avgMemstoreReadRows": 0,
        "avgNetTime": 0,
        "avgNetWaitTime": 0,
        "avgPartitionCount": 0,
        "avgQueueTime": 0,
        "avgReturnRows": 0,
        "avgRowCacheHit": 0,
        "avgRpcCount": 0,
        "avgScheduleTime": 0,
        "avgSsstoreReadRows": 0,
        "avgUserIoWaitTime": 0,
        "avgWaitCount": 0,
        "avgWaitTime": 0,
        "dbName": "oceanbase",
        "distPlanPercentage": 0,
        "dynamicSql": false,
        "execPs": 0.02,
        "executions": 1,
        "failCount": 1,
        "failPercentage": 100,
        "inner": false,
        "lastFailCode": 0,
        "lastFailTimestamp": 0,
        "localPlanPercentage": 0,
        "maxAffectedRows": 0,
        "maxApplicationWaitTime": 0,
        "maxConcurrencyWaitTime": 0,
        "maxCpuTime": 108.49,
        "maxDiskReads": 0,
        "maxElapsedTime": 108.49,
        "maxReturnRows": 0,
        "maxUserIoWaitTime": 0,
        "missPlanPercentage": 100,
        "obDbId": 201001,
        "obTenantId": 1010,
        "remotePlanPercentage": 0,
        "retCode4012Count": 0,
        "retCode4013Count": 0,
        "retCode5001Count": 0,
        "retCode5024Count": 0,
        "retCode5167Count": 0,
        "retCode5217Count": 0,
        "retCode6002Count": 0,
        "retryCount": 0,
        "server": "xxx.xxx.xxx.xxx:2882",
        "serverIp": "xxx.xxx.xxx.xxx",
        "sqlId": "7FA0ED8C8C94A4F26548FCDDA2368C21",
        "sqlTextShort": "CALL DBMS_BALANCE.TRIGGER_PARTITION_BALANCE();",
        "sqlType": "OTHER",
        "strongConsistencyPercentage": 0,
        "sumCpuTimeMs": 108.49,
        "sumElapsedTime": 108.49,
        "sumLogicalReads": 0,
        "sumWaitTime": 0,
        "tableScanPercentage": 0,
        "tenantId": 1196,
        "tenantName": "ocp_admin_pr",
        "userName": "root",
        "waitEvent": "none",
        "weakConsistencyPercentage": 0
      },
      {
        "avgAffectedRows": 0,
        "avgApplicationWaitTime": 0,
        "avgBlockCacheHit": 0,
        "avgBlockIndexCacheHit": 0,
        "avgBloomFilterCacheHit": 0,
        "avgConcurrencyWaitTime": 0,
        "avgCpuTime": 105.02,
        "avgDecodeTime": 0,
        "avgDiskReads": 0,
        "avgElapsedTime": 105.02,
        "avgExecuteTime": 99.28,
        "avgExecutorRpcCount": 0,
        "avgGetPlanTime": 5.74,
        "avgLogicalReads": 0,
        "avgMemstoreReadRows": 0,
        "avgNetTime": 0,
        "avgNetWaitTime": 0,
        "avgPartitionCount": 2,
        "avgQueueTime": 0,
        "avgReturnRows": 1,
        "avgRowCacheHit": 0,
        "avgRpcCount": 0,
        "avgScheduleTime": 0,
        "avgSsstoreReadRows": 0,
        "avgUserIoWaitTime": 0,
        "avgWaitCount": 0,
        "avgWaitTime": 0,
        "dbName": "oceanbase",
        "distPlanPercentage": 0,
        "dynamicSql": false,
        "execPs": 0.02,
        "executions": 1,
        "failCount": 0,
        "failPercentage": 0,
        "inner": false,
        "lastFailCode": 0,
        "lastFailTimestamp": 0,
        "localPlanPercentage": 100,
        "maxAffectedRows": 0,
        "maxApplicationWaitTime": 0,
        "maxConcurrencyWaitTime": 0,
        "maxCpuTime": 105.02,
        "maxDiskReads": 0,
        "maxElapsedTime": 105.02,
        "maxReturnRows": 1,
        "maxUserIoWaitTime": 0,
        "missPlanPercentage": 100,
        "obDbId": 201001,
        "obTenantId": 1010,
        "remotePlanPercentage": 0,
        "retCode4012Count": 0,
        "retCode4013Count": 0,
        "retCode5001Count": 0,
        "retCode5024Count": 0,
        "retCode5167Count": 0,
        "retCode5217Count": 0,
        "retCode6002Count": 0,
        "retryCount": 0,
        "server": "xxx.xxx.xxx.xxx:2882",
        "serverIp": "xxx.xxx.xxx.xxx",
        "sqlId": "8B5B4B4CC550A9251AE501E633E90D95",
        "sqlTextShort": "SELECT /*+ workload_repository_snapshot query_time",
        "sqlType": "SELECT",
        "strongConsistencyPercentage": 100,
        "sumCpuTimeMs": 105.02,
        "sumElapsedTime": 105.02,
        "sumLogicalReads": 0,
        "sumWaitTime": 0,
        "tableScanPercentage": 100,
        "tenantId": 1196,
        "tenantName": "ocp_admin_pr",
        "userName": "root",
        "waitEvent": "none",
        "weakConsistencyPercentage": 0
      }
    ]
  },
  "duration": 14,
  "server": "f00e301d58",
  "status": 200,
  "successful": true,
  "timestamp": "2024-07-29T10:50:22.176+08:00",
  "traceId": "1ab38f7744b4a012"
}
```
