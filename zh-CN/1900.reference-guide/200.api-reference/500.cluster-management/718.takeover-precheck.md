# 接管 OceanBase 集群预检查

## 功能说明

该接口用于对一个非 OCP 方式创建的 OceanBase 集群进行预检查，确定其是否允许被纳入到 OCP 的管理之下。该操作为可选操作，您可以根据实际情况选择是否执行。

## 调用说明

### 接口约束

* 调用者需具备接管 OceanBase 集群的权限。

  关于调用者的权限，详情可参见 [角色概述](../../../1600.system-management-features/200.manage-users/200.manage-a-role/100.roles-overview.md) 和 [用户概述](../../../1600.system-management-features/200.manage-users/100.manage-a-user/100.users-overview.md)。
  
* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/takeOverPreCheck`

### 请求参数

**Body 参数：**

|     参数        |   类型  | 必选 |        示例值             |   描述    |
|-----------------|---------|-----|----------------------------|-----------|
| rootSysPassword | String  | 是  | ******                     | root@sys 密码。 |
| address         | String  | 是  | xxx.xxx.xxx.xxx            | 集群连接地址。 |
| port            | Integer | 是  | 2883                       | 集群连接端口。 |
| connectionMode  | String  | 否  | direct                     | 连接模式，可选值为 direct 或 proxy，默认为 direct。 |
| clusterName     | String  | 否  | ob01                       | 当连接模式为 proxy 时必填。 |
| obClusterId     | Integer | 否  | 1001                       | 当连接模式为 proxy 且被接管集群为备集群时必填。 |

### 返回结果

**基础数据结构**

|     参数     |    类型    |                                说明                                |
|------------|----------|------------------------------------------------------------------|
| data       | Object   | 异步任务信息，详情参见 [任务信息](../400.task-return-structure.md)。 |
| successful | Boolean  | 请求是否成功。                                                          |
| timestamp  | Datetime | 服务端完成请求的时间戳。                                                     |
| duration   | Integer  | 服务端处理请求的时间（毫秒）。                                                  |
| status     | Integer  | 符合 HTTP Status 规范的编码。                                            |
| traceId    | String   | 请求的 Trace Id，用于排查问题。                                             |
| server     | String   | 响应请求的应用服务的地址。                                                    |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/22/upgrade`

**body:**

```shell
{
  "rootSysPassword":"xxxxx",
  "address":"xxxxx",
  "port":2888
}
```

### 返回示例

```shell
{
    "data": {
        "clusterName": "ob4320",
        "clusterType": "PRIMARY",
        "configUrl": "http://xxx.xxx.xxx.xxx:10550/services?Action=ObRootServiceInfo&User_ID=alibaba&UID=ocpmaster&ObRegion=ob4320",
        "obClusterId": 1658110562,
        "obVersion": "4.3.2.0",
        "result": {
            "messages": [],
            "valid": true
        },
        "servers": [
            {
                "dataDir": "/home/admin/oceanbase/store/ob4320",
                "host": {
                    "alias": null,
                    "architecture": "x86_64",
                    "checkSystemInfoRiskyCount": 0,
                    "checkSystemInfoStatus": null,
                    "checkSystemInfoTaskId": null,
                    "createTime": "2024-09-12T19:06:21+08:00",
                    "description": null,
                    "hostAgentId": 3000010,
                    "hostAgentStatus": "AVAILABLE",
                    "hostAgentVersion": "4.3.2-20240906151652",
                    "hostTags": null,
                    "id": 4000015,
                    "idcDescription": null,
                    "idcId": 1,
                    "idcName": "BJ",
                    "innerIpAddress": "xxx.xxx.xxx.xxx",
                    "ioPerformance": [],
                    "kind": "DEDICATED_PHYSICAL_MACHINE",
                    "name": "sqaob011124009057.sa128",
                    "operatingSystem": "4.9.151-015.ali3000.alios7.x86_64",
                    "operatingSystemRelease": "alios7",
                    "operatingTaskInstanceId": null,
                    "publishPorts": null,
                    "regionDescription": null,
                    "regionId": 1,
                    "regionName": "OCP_META_REGION",
                    "serialNumber": null,
                    "services": [
                        {
                            "name": "obproxy4310",
                            "softwarePackageId": 3000021,
                            "type": "OB_PROXY",
                            "version": "4.3.1.0-402024062810"
                        }
                    ],
                    "sshPort": 22,
                    "status": "ONLINE",
                    "statusAnalysis": null,
                    "tags": null,
                    "typeDescription": null,
                    "typeId": 1,
                    "typeName": "test",
                    "updateTime": "2024-09-20T11:13:05+08:00",
                    "vpcId": 1,
                    "vpcName": "system-default"
                },
                "ip": "11.124.9.57",
                "pid": 8408,
                "port": 2882,
                "result": {
                    "messages": [],
                    "valid": true
                },
                "sqlPort": 2881,
                "status": "ACTIVE",
                "withRootserver": true,
                "zone": {
                    "idcName": "BJ",
                    "regionName": "OCP_META_REGION",
                    "zoneName": "zone1"
                }
            }
        ],
        "vpcId": 1
    },
    "duration": 402,
    "server": "74f95ea2f4",
    "status": 200,
    "successful": true,
    "timestamp": "2024-10-10T17:14:26.45+08:00",
    "traceId": "7025326d03a3ce88"
}
```
