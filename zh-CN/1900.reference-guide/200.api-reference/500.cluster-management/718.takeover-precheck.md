# 接管 OceanBase 集群预检查

## 功能说明

该接口用于对一个非 OCP 方式创建的 OceanBase 集群进行预检查，确定其是否允许被纳入到 OCP 的管理之下。该操作为可选操作，您可以根据实际情况选择是否执行。

## 调用说明

### 接口约束

* 调用者需具备接管 OceanBase 集群的权限。

  关于调用者的权限，详情可参见 [角色概述](../../../1600.system-management-features/200.manage-users/200.manage-a-role/100.roles-overview.md) 和 [用户概述](../../../1600.system-management-features/200.manage-users/100.manage-a-user/100.users-overview.md)。
  
* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/takeOverPreCheck`

### 请求参数

**Body 参数：**

|     参数        |   类型  | 必选 |        示例值             |   描述    |
|-----------------|---------|-----|----------------------------|-----------|
| rootSysPassword | String  | 是  | ******                     | root@sys 密码。 |
| address         | String  | 是  | xxx.xxx.xxx.xxx            | 集群连接地址。 |
| port            | Integer | 是  | 2883                       | 集群连接端口。 |
| connectionMode  | String  | 否  | direct                     | 连接模式，可选值为 direct 或 proxy，默认为 direct。 |
| clusterName     | String  | 否  | ob01                       | 当连接模式为 proxy 时必填。 |
| obClusterId     | Integer | 否  | 1001                       | 当连接模式为 proxy 且被接管集群为备集群时必填。 |

### 返回结果

**基础数据结构**

|     参数    |    类型  |                                说明                                |
|-------------|----------|------------------------------------------------------------------|
| data        | Object   | 详情参见 **接管预检查结果**。|
| successful  | Boolean  | 请求是否成功。                                                        |
| timestamp   | Datetime | 服务端完成请求的时间戳。                                               |
| duration    | Integer  | 服务端处理请求的时间（毫秒）。                                       |
| status      | Integer  | 符合 HTTP Status 规范的编码。                                          |
| traceId     | String   | 请求的 Trace Id，用于排查问题。                                         |
| server      | String   | 响应请求的应用服务的地址。                                              |

**接管预检查结果**

|     参数    |    类型   |                                说明                                |
|--------------|----------|------------------------------------------------------------------|
| clusterName  | String   | 集群名。   |
| clusterType  | String   | 集群类型，包括：<li>PRIMARY：主集群。</li><li>STANDBY：备集群。</li>。 |
| configUrl    | String   | Config URL 地址。                                                        |
| obClusterId  | Long     | 集群 ID。                                               |
| obVersion    | String   | 集群版本。                                       |
| result       | Object   | 详情参见 **检查结果详情**。                                          |
| servers      | Object   | 详情参见 **OBServer 信息**。                                         |
| vpcId        | Long     | 集群所属 VPC 的 ID。    |

**检查结果详情**

|     参数    |    类型  |                                说明                                |
|-------------|-----------|------------------------------------------------------------------|
| valid       | Boolean   | 是否检查通过。   |
| messages    | String    | 错误信息列表。  |

**OBServer 信息**

|     参数       |        类型    |                                说明                                |
|----------------|----------------|------------------------------------------------------------------|
| dataDir        | String         | OBServer 存储 SSTable 等数据的目录。                           |
| host           | Object         | OBServer 所属主机信息，详情参见 **Host 信息**。                  |
| valid          | Boolean        | 是否检查通过。                                                |
| ip             | String         | OBServer 的 IP 地址。                                             |
| pid            | Integer        | observer 进程的 PID。                                               |
| port           | Integer        | OBServer 的 RPC 端口。                                               |
| result         | Object         | 预检查结果。                                                      |
| |—— valid      | Boolean        | 是否检查通过。                                                  |
| |—— messages   | String         | 错误信息列表。                                                    |
| sqlPort        | Integer        | OBServer 的 SQL 端口。                                                |
| status         | String         | OBServer 状态。                                                    |
| withRootserver | Boolean        | OBServer 上是否存在 root service。                                |
| zone           | Object         | OBServer 所属 Zone 信息，详情参见 **Zone 信息**。              |

**Host 信息**

|     参数    |    类型  |                                说明                                |
|-------------|----------|------------------------------------------------------------------|
| alias                     | String    | 主机别名。   |
| architecture              | String    | 硬件架构。 |
| checkSystemInfoRiskyCount | Integer   | 装机检查任务风险项数量。                                                        |
| checkSystemInfoStatus     | String    | 装机检查状态。                                               |
| checkSystemInfoTaskId     | Long      | 装机检查任务 ID。                                       |
| createTime                | String    | 主机创建时间。                                          |
| description               | String    | 主机描述信息。                                         |
| hostAgentId               | Long      | OCP Agent ID 信息。                                              |
| hostAgentStatus           | String    | OCP agent 状态信息。   |
| hostAgentVersion          | String    | OCP agent 版本信息。   |
| hostTags                  | String    | 主机标签。   |
| id                        | Long      | 主机 ID。   |
| idcDescription            | String    | 机房描述信息。   |
| idcId                     | Long      | 机房 ID。  |
| idcName                   | String    | 机房名称。   |
| innerIpAddress            | String    | 主机 IP 地址。  |
| ioPerformance             | String    | 主机 IO 性能。   |
| kind                      | String    | 主机类型。包括如下两种类型：<li> DEDICATED_PHYSICAL_MACHINE：物理机。</li><li> DEDICATED_CONTAINER：容器。</li>  |
| name                      | String    | 主机名。   |
| operatingSystem           | String    | 操作系统。  |
| operatingSystemRelease    | String    | 操作系统发行版名称。  |
| operatingTaskInstanceId   | Long      | 运维中的任务 ID。   |
| publishPorts              | String    | 端口映射。   |
| regionDescription         | String    | 区域描述信息。   |
| regionId                  | Long      | 区域 ID。   |
| regionName                | String    | 区域名称。  |
| serialNumber              | String    | 序列号。  |
| services                  | Object    | ServiceSummary 数组，部署服务汇总信息。  |
| |—— name                  | String    | 服务名称。   |
| |—— softwarePackageId     | Long      | 软件包 ID。  |
| |—— type                  | String    | 服务类型。   |
| |—— version               | String    | 服务版本。   |
| sshPort                   | Integer   | SSH 端口。   |
| status                    | String    | 主机状态。   |
| statusAnalysis            | String    | 异常状态原因分析。  |
| tags                      | String    | 主机标签。   |
| typeDescription           | String    | 机型描述信息。  |
| typeId                    | Long      | 机型 ID。  |
| typeName                  | String    | 机型名称。  |
| updateTime                | String    | 主机修改时间。   |
| vpcId                     | Long      | 所属 VPC 的 ID。  |
| vpcName                   | String    | 所属 VPC 名称。  |

**Zone 信息**

|     参数    |    类型  |                                说明                                |
|-------------|----------|------------------------------------------------------------------|
| idcName     | String   | 所属机房的名称。                   |
| regionName  | String   |  所属区域的名称。                     |
| zoneName    | Boolean  | 主机所属 Zone 的名称。                                                        |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/takeOverPreCheck`

**body:**

```shell
{
  "rootSysPassword":"xxxxx",
  "address":"xxxxx",
  "port":2888
}
```

### 返回示例

```shell
{
    "data": {
        "clusterName": "ob4320",
        "clusterType": "PRIMARY",
        "configUrl": "http://xxx.xxx.xxx.xxx:10550/services?Action=ObRootServiceInfo&User_ID=alibaba&UID=ocpmaster&ObRegion=ob4320",
        "obClusterId": 1658110562,
        "obVersion": "4.3.2.0",
        "result": {
            "messages": [],
            "valid": true
        },
        "servers": [
            {
                "dataDir": "/home/admin/oceanbase/store/ob4320",
                "host": {
                    "alias": null,
                    "architecture": "x86_64",
                    "checkSystemInfoRiskyCount": 0,
                    "checkSystemInfoStatus": null,
                    "checkSystemInfoTaskId": null,
                    "createTime": "2024-09-12T19:06:21+08:00",
                    "description": null,
                    "hostAgentId": 3000010,
                    "hostAgentStatus": "AVAILABLE",
                    "hostAgentVersion": "4.3.2-20240906151652",
                    "hostTags": null,
                    "id": 4000015,
                    "idcDescription": null,
                    "idcId": 1,
                    "idcName": "BJ",
                    "innerIpAddress": "xxx.xxx.xxx.xxx",
                    "ioPerformance": [],
                    "kind": "DEDICATED_PHYSICAL_MACHINE",
                    "name": "sqaob011124009057.sa128",
                    "operatingSystem": "4.9.151-015.ali3000.alios7.x86_64",
                    "operatingSystemRelease": "alios7",
                    "operatingTaskInstanceId": null,
                    "publishPorts": null,
                    "regionDescription": null,
                    "regionId": 1,
                    "regionName": "OCP_META_REGION",
                    "serialNumber": null,
                    "services": [
                        {
                            "name": "obproxy4310",
                            "softwarePackageId": 3000021,
                            "type": "OB_PROXY",
                            "version": "4.3.1.0-402024062810"
                        }
                    ],
                    "sshPort": 22,
                    "status": "ONLINE",
                    "statusAnalysis": null,
                    "tags": null,
                    "typeDescription": null,
                    "typeId": 1,
                    "typeName": "test",
                    "updateTime": "2024-09-20T11:13:05+08:00",
                    "vpcId": 1,
                    "vpcName": "system-default"
                },
                "ip": "11.124.9.57",
                "pid": 8408,
                "port": 2882,
                "result": {
                    "messages": [],
                    "valid": true
                },
                "sqlPort": 2881,
                "status": "ACTIVE",
                "withRootserver": true,
                "zone": {
                    "idcName": "BJ",
                    "regionName": "OCP_META_REGION",
                    "zoneName": "zone1"
                }
            }
        ],
        "vpcId": 1
    },
    "duration": 402,
    "server": "74f95ea2f4",
    "status": 200,
    "successful": true,
    "timestamp": "2024-10-10T17:14:26.45+08:00",
    "traceId": "7025326d03a3ce88"
}
```
