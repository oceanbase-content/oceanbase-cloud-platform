# 接管 OceanBase 集群

## 功能说明

该接口用于接管 OceanBase 集群。在接管 OceanBase 集群前，您可参考 [接管 OceanBase 集群预检查](718.takeover-precheck.md) 对集群执行预检查操作。

## 调用说明

### 接口约束

* 调用者需具备接管 OceanBase 集群的权限。

  关于调用者的权限，详情可参见 [角色概述](../../../1600.system-management-features/200.manage-users/200.manage-a-role/100.roles-overview.md) 和 [用户概述](../../../1600.system-management-features/200.manage-users/100.manage-a-user/100.users-overview.md)。
  
* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/takeOver`

### 请求参数

**Body 参数：**

|     参数        |   类型  | 必选 |        示例值             |   描述    |
|-----------------|---------|-----|----------------------------|-----------|
| rootSysPassword | String  | 是  | ******                     | root@sys 密码。 |
| address         | String  | 是  | xxx.xxx.xxx.xxx            | 集群连接地址。 |
| port            | Integer | 是  | 2883                       | 集群连接端口。 |
| saveToCredential| Boolean | 否  | true                       | 是否要保存到密码箱，默认为 true。 |
| connectionMode  | String  | 否  | direct                     | 连接模式，可选值为 direct 或 proxy，默认为 direct。 |
| clusterName     | String  | 否  | ob01                       | 当连接模式为 proxy 时必填。 |
| obClusterId     | Integer | 否  | 1001                       | 当连接模式为 proxy 且被接管集群为备集群时必填。 |
| switchConfigUrl | Boolean | 否  | true                       | 是否将目标集群的 config url 切到本 OCP，默认为 true。 |
| hostInfo        | Object  | 否  | -                          | 如果集群下所有主机均已提前接管到了 OCP 中，则无需传入此项；如果集群下存在未接管到 OCP 的主机，则必须传入未接管主机的如下属性。 |
| ├─ kind         | String  | 否  | DEDICATED_PHYSICAL_MACHINE | 主机类型，物理机或容器。可选值为 DEDICATED_PHYSICAL_MACHINE 或 DEDICATED_CONTAINER，默认为 DEDICATED_PHYSICAL_MACHINE。 |
| ├─ publishPorts | String  | 否  | 22                         | 容器端口映射。kind 为 DEDICATED_CONTAINER 时有效。 |
| ├─ hostTypeId   | Integer | 是  | 281                        | 主机机型 ID。 |
| ├─ credentialId | Integer | 是  | 32765                      | 主机凭据 ID。 |

### 返回结果

**基础数据结构**

|     参数     |    类型    |                                说明                                |
|------------|----------|------------------------------------------------------------------|
| data       | Object   | 异步任务信息，详情参见 [任务信息](../400.task-return-structure.md)。 |
| successful | Boolean  | 请求是否成功。                                                          |
| timestamp  | Datetime | 服务端完成请求的时间戳。                                                     |
| duration   | Integer  | 服务端处理请求的时间（毫秒）。                                                  |
| status     | Integer  | 符合 HTTP Status 规范的编码。                                            |
| traceId    | String   | 请求的 Trace Id，用于排查问题。                                             |
| server     | String   | 响应请求的应用服务的地址。                                                    |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/22/upgrade`

**body:**

```shell
{
  "rootSysPassword":"xxxxx",
  "address":"xxxxx",
  "port":2888
}
```

### 返回示例

```shell
{
    "data": {
        "clusterId": 5000034,
        "creator": "admin",
        "executor": "xxx.xxx.xxx.xxx",
        "id": 13089035,
        "name": "Take over primary OB cluster",
        "operation": "EXECUTE",
        "prohibitRollback": false,
        "startTime": "2024-10-10T17:15:17.816+08:00",
        "status": "RUNNING",
        "subtasks": [
            {
                "description": "Mc lock ob clusters",
                "downstreams": [
                    13104470
                ],
                "id": 13104477,
                "name": "Mc lock ob clusters",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 25,
                "status": "READY",
                "timeout": 60,
                "upstreams": []
            },
            {
                "description": "Create default user",
                "downstreams": [
                    13104480
                ],
                "id": 13104481,
                "name": "Create default user",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 0,
                "status": "PENDING",
                "timeout": 180,
                "upstreams": [
                    13104476
                ]
            },
            {
                "description": "Update observer status",
                "downstreams": [
                    13104471
                ],
                "id": 13104469,
                "name": "Update observer status",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 16,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13104468
                ]
            },
            {
                "description": "Update OB cluster status",
                "downstreams": [
                    13104463
                ],
                "id": 13104465,
                "name": "Update OB cluster status",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 12,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104484
                ]
            },
            {
                "description": "Active agent modules",
                 "downstreams": [
                    13104485
                ],
                "id": 13104482,
                "name": "Active agent modules",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 6,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104461
                ]
            },
            {
                "description": "Wait node",
                "downstreams": [
                    13104482
                ],
                "id": 13104461,
                "name": "Wait node",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 3,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104475
                ]
            },
            {
                "description": "Sync cluster info",
                "downstreams": [
                    13104473
                ],
                "id": 13104466,
                "name": "Sync cluster info",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 5,
                "status": "PENDING",
                "timeout": 60,
                "upstreams": [
                    13104485
                ]
            },
            {
                "description": "Sync all tenant information",
                "downstreams": [
                    13104468
                ],
                "id": 13104473,
                "name": "Sync all tenant information",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 15,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13104466
                ]
            },
            {
                "description": "Mc unlock ob clusters",
                "downstreams": [],
                "id": 13104478,
                "name": "Mc unlock ob clusters",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 23,
                "status": "PENDING",
                "timeout": 60,
                "upstreams": [
                    13104463
                ]
            },
            {
                "description": "Prepare take over cluster",
                "downstreams": [
                    13104476
                ],
                "id": 13104470,
                "name": "Prepare take over cluster",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 13,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104477
                ]
            },
            {
                "description": "Wait node",
                "downstreams": [
                    13104483
                ],
                "id": 13104464,
                "name": "Wait node",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 7,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104472
                ]
            },
            {
                "description": "Register config url",
                "downstreams": [
                    13104472
                ],
                "id": 13104480,
                "name": "Register config url",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 20,
                "status": "PENDING",
                "timeout": 60,
                "upstreams": [
                    13104481
                ]
            },
            {
                "description": "Set proxyro password to sys tenant",
                "downstreams": [
                    13104469
                ],
                "id": 13104468,
                "name": "Set proxyro password to sys tenant",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 4,
                "status": "PENDING",
                "timeout": 600,
                "upstreams": [
                    13104473
                ]
            },
            {
                "description": "Run io calibration",
                "downstreams": [
                    13104464
                ],
                "id": 13104472,
                "name": "Run io calibration",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 14,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104480
                ]
            },
            {
                "description": "Wait cluster accessible",
                "downstreams": [
                    13104474
                ],
                "id": 13104462,
                "name": "Wait cluster accessible",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 8,
                "status": "PENDING",
                "timeout": 1200,
                "upstreams": [
                    13104483
                ]
            },
            {
                "description": "Update server process info",
                "downstreams": [
                    13104479
                ],
                "id": 13104474,
                "name": "Update server process info",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 1,
                "status": "PENDING",
                "timeout": 5000,
                "upstreams": [
                    13104462
                ]
            },
            {
                "description": "Refresh ocp agent config",
                "downstreams": [
                    13104461
                ],
                "id": 13104475,
                "name": "Refresh ocp agent config",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 21,
                "status": "PENDING",
                "timeout": 3600,
                "upstreams": [
                    13104467
                ]
            },
            {
                "description": "Reserve host",
                "downstreams": [
                    13104481
                ],
                "id": 13104476,
                "name": "Reserve host",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 2,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104470
                ]
            },
            {
                "description": "Wait node",
                "downstreams": [
                    13104467
                ],
                "id": 13104479,
                "name": "Wait node",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 10,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104474
                ]
            },
            {
                "description": "Record root service list",
                "downstreams": [
                    13104462
                ],
                "id": 13104483,
                "name": "Record root service list",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 9,
                "status": "PENDING",
                "timeout": 60,
                "upstreams": [
                    13104464
                ]
            },
            {
                "description": "Create resource manager for default user",
                "downstreams": [
                    13104478
                ],
                "id": 13104463,
                "name": "Create resource manager for default user",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 11,
                "status": "PENDING",
                "timeout": 180,
                "upstreams": [
                    13104465
                ]
            },
            {
                "description": "Update zone status",
                "downstreams": [
                    13104484
                ],
                "id": 13104460,
                "name": "Update zone status",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 19,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104471
                ]
            },
            {
                "description": "Wait node",
                "downstreams": [
                    13104466
                ],
                "id": 13104485,
                "name": "Wait node",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 24,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104482
                ]
            },
            {
                "description": "Wait node",
                "downstreams": [
                    13104460
                ],
                "id": 13104471,
                "name": "Wait node",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 17,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104469
                ]
            },
            {
                "description": "Wait node",
                "downstreams": [
                    13104465
                ],
                "id": 13104484,
                "name": "Wait node",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 22,
                "status": "PENDING",
                "timeout": 30,
                "upstreams": [
                    13104460
                ]
            },
            {
                "description": "Attach cluster attributes",
                "downstreams": [
                    13104475
                ],
                "id": 13104467,
                "name": "Attach cluster attributes",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 18,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104479
                ]
            }
        ],
        "taskDefinitionId": -1,
        "type": "MANUAL"
    },
    "duration": 493,
    "server": "74f95ea2f4",
    "status": 200,
    "successful": true,
    "timestamp": "2024-10-10T17:15:17.896+08:00",
    "traceId": "a555fda01af052c1"
}
```
