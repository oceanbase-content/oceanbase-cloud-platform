# 迁出 OceanBase 集群

## 功能说明

该接口用于迁出 OceanBase 集群。直接调用该接口会导致集群凭据丢失，建议先导出集群凭据文件后，再迁出 OceanBase 集群。

## 调用说明

### 接口约束

* 调用者需具备迁出 OceanBase 集群的权限。

  关于调用者的权限，详情可参见 [角色概述](../../../1600.system-management-features/200.manage-users/200.manage-a-role/100.roles-overview.md) 和 [用户概述](../../../1600.system-management-features/200.manage-users/100.manage-a-user/100.users-overview.md)。
  
* 调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/moveOut`

### 请求参数

**Path 参数：**

|     参数        |   类型  | 必选 |       示例值     |   描述    |
|-----------------|---------|-----|-------------------|-----------|
| id              | Long    | 是  |    1              | 待迁出的 OceanBase 集群 ID。 |

**Body 参数：**

|     参数        |   类型  | 必选 |        示例值             |   描述    |
|-----------------|---------|-----|----------------------------|-----------|
| deleteHost      | Boolean | 否  | true                       | 迁出集群时是否同时删除集群下的所有主机。 |
| targetConfigAddress         | String  | 否  | http://xxx.xxx.xxx.xxx:xxx            | 迁出集群时为该集群指定新的 config server 地址，格式为 `http://xxx.xxx.xxx.xxx:xxx`。 |

### 返回结果

**基础数据结构**

|     参数     |    类型    |                                说明                                |
|------------|----------|------------------------------------------------------------------|
| data       | Object   | 异步任务信息，详情参见 [任务信息](../400.task-return-structure.md)。 |
| successful | Boolean  | 请求是否成功。                                                          |
| timestamp  | Datetime | 服务端完成请求的时间戳。                                                     |
| duration   | Integer  | 服务端处理请求的时间（毫秒）。                                                  |
| status     | Integer  | 符合 HTTP Status 规范的编码。                                            |
| traceId    | String   | 请求的 Trace Id，用于排查问题。                                             |
| server     | String   | 响应请求的应用服务的地址。                                                    |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/{id}/moveOut`

```shell
{
  "deleteHost": true,
  "targetConfigAddress": "http://xxx.xxx.xxx.xxx:xxx"
}
```

### 返回示例

```shell
{
    "data": {
        "clusterId": 5000033,
        "creator": "admin",
        "executor": "xxx.xxx.xxx.xxx",
        "id": 13089033,
        "name": "Move out primary OB cluster",
        "operation": "EXECUTE",
        "prohibitRollback": false,
        "startTime": "2024-10-10T17:13:19.269+08:00",
        "status": "RUNNING",
        "subtasks": [
            {
                "description": "Delete cluster related info",
                "downstreams": [
                    13104453
                ],
                "id": 13104455,
                "name": "Delete cluster related info",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 1,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104454
                ]
            },
            {
                "description": "Prepare move out cluster",
                "downstreams": [
                    13104454
                ],
                "id": 13104458,
                "name": "Prepare move out cluster",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 2,
                "status": "PENDING",
                "timeout": 300,
                "upstreams": [
                    13104456
                ]
            },
            {
                "description": "Inactive agent modules",
                "downstreams": [
                    13104455
                ],
                "id": 13104454,
                "name": "Inactive agent modules",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": 0,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 3,
                "status": "PENDING",
                "timeout": 3600,
                "upstreams": [
                    13104458
                ]
            },
            {
                "description": "Unreserve host",
                "downstreams": [
                    13104450
                ],
                "id": 13104451,
                "name": "Unreserve host",
                "nodeType": "JAVA_TASK",
                "operation": "EXECUTE",
                "parallelIdx": -1,
                "prohibitRollback": false,
                "prohibitSkip": false,
                "runTime": 1,
                "seriesId": 7,
                "status": "PENDING",
                "timeout": 1800,
                "upstreams": [
                    13104453
                ]
            },
            {
```
