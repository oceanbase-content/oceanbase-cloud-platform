# 发起租户数据备份

## 功能说明

该接口用于发起租户数据备份。

## 调用说明

### 接口约束

调用者需要通过 OCP 应用服务鉴权。

### 请求路径

`POST /api/v2/ob/clusters/{id}/tenants/{tenantId}/backup/backupNow`

### 请求参数

**Path 参数**

|     参数   |  类型     |  必选  |  示例值  |  描述      |
|------------|-----------|--------|---------|-------------|
|  id        |  Integer  |  是    |  1002   |  集群 ID。  |
|  tenantId  |  Integer  |  是    |  108    |  租户 ID。  |

**Body 参数**

|  参数  |  类型  |  必选  |  示例值  |  描述  |
|--------|--------|--------|----------|---------|
|  obBackupObject  |  Obbackupobject  |  否  |  NA  |  备份对象，会自动填充。  |
|  backupMode  |  String  |  是  |   LOGICAL_BACKUP |  备份模式，包括：<li>LOGICAL_BACKUP：逻辑备份。</li> <li>PHYSICAL_BACKUP：物理备份。</li>    |
|  dataBackupMode  |  String  |  是  | FULL_BACKUP    | 数据备份模式，包括：<li>FULL_BACKUP：全量备份。</li> <li> INCREMENTAL_BACKUP：增量备份。</li>  |
|  obBackupServiceStorageConfig  |  Obbackupservicestorageconfig  |  是  | NA    | 备份存储配置，详情参见 **`obBackupServiceStorageConfig` 的数据结构** 。|

**`obBackupServiceStorageConfig` 的数据结构**

|     参数  |   类型   | 必选 |   说明     |
|-----------|----------|-------|---------------|
| configName                                 | String | 是  | 存储配置名。    |
| obBackupStorageBaseInfo                    | Object | 是  | 存储配置基本参数。   |
| \|--backupStorageType                      | String | 是  | 存储类型，目前支持 `BACKUP_STORAGE_FILE`、`BACKUP_STORAGE_OSS`、`BACKUP_STORAGE_COS`、`BACKUP_STORAGE_S3` 四种类型。   |
| \|--storageUrl                             | String | 是  | 存储目录。请配置为不带协议的目录，如 `/obbackup/` 或 `osstest/backup`。    |
| \|--ossAccessKey                           | Object | 否  | OSS 信息，仅在 `backupStorageType=BACKUP_STORAGE_OSS` 时有效。    |
| \|--endpoint                               | String | 是  | 访问域名。     |
| \|--accessKeyId                            | String | 是  | 访问用户。      |
| \|--accessKeySecret                        | String | 是  | 访问秘钥。      |
| \|--cosAccessKey                           | Object | 否  | COS 信息，仅在 `backupStorageType=BACKUP_STORAGE_COS` 时有效。      |
| \|--endpoint                               | String | 是  | 访问域名。       |
| \|--accessKeyId                            | String | 是  | 访问用户。        |
| \|--accessKeySecret                        | String | 是  | 访问秘钥。      |
| \|--appId                                  | String | 是  | 应用 ID。        |
| \|--s3AccessKey                            | Object | 否  | S3 信息，仅在 `backupStorageType=BACKUP_STORAGE_S3` 时有效。      |
| \|--endpoint                               | String | 是  | 访问域名。       |
| \|--accessKeyId                            | String | 是  | 访问用户。        |
| \|--accessKeySecret                        | String | 是  | 访问秘钥。      |
| \|--region                                 | String | 是  | 地域。  |
| \|--alarmStoragePercentageThreshold        | Long   | 是  | 备份存储容量报警阈值，请配置为百分比。       |
| storageId                                  | Long   | 否  | 存储配置 ID。       |
| serviceType                                | String | 否  | 服务类型，包括：<li>BACKUP_RESTORE_SERVICE：备份恢复服务（逻辑备份恢复）。</li><li>OB_CLUSTER：OceanBase 集群（物理备份恢复）。</li><li>OTHERS：其它。</li>   |
| serviceId  | Long   | 否  | 服务 ID。 <li>当服务类型是 **BACKUP_RESTORE_SERVICE** 时，代表备份恢复服务 ID。  </li><li>当服务类型是 **OB_CLUSTER** 时，代表集群 ID。 </li>   |
| serviceName                                | String | 否  | 服务名。 <li>当服务类型是 **BACKUP_RESTORE_SERVICE** 时，代表备份恢复服务名。</li>  <li>当服务类型是 **OB_CLUSTER** 时，代表集群名。</li>    |
| hostIdList                                 | Array  | 否  | 主机 ID 列表，用于全局恢复的解析主机列表。<li> 当服务类型是 **BACKUP_RESTORE_SERVICE** 时，代表备份恢复服务的主机 ID 列表。 </li><li>当服务类型是 **OB_CLUSTER** 时，代表集群的主机 ID 列表。</li>    |

### 返回结果

**基础数据结构**

|  参数  |  类型  | 说明                               |
|--------|---------|----------------------------------|
|  data  |  Object  | BackupCommonResponse 的信息，详情参见下表。 |
|  successful  |  Boolean | 请求是否成功。                          |
|  timestamp |  Datetime  | 服务端完成请求的时间戳。                     |
|  duration |  Integer  | 服务端处理请求的时间（毫秒）。                  |
|  status |  Integer  | 符合 HTTP Status 规范的编码。            |
|  traceId |  String  | 请求的 Trace ID，用于排查问题。             |
|  server  |  String  | 响应请求的应用服务的地址。                    |

**`BackupCommonResponse` 的数据结构**

|            参数             |   类型    |                       说明                        |
|---------------------------|---------|-------------------------------------------------|
| obBackupTaskType          | String  | 备份操作类型，如 "CREATE_BACKUP_STRATEGY"。              |
| backupObjectOpsResultList | Array   | 备份对象操作结果集。                                      |
| \|--obBackupObjectList    | Array   | 备份对象列表。                                         |
| \|--clusterId             | Long    | 集群 ID。                                          |
| \|--tenantId              | Long    | 租户 ID。                                          |
| \|--backupDimension       | String  | 备份维度，如 CLUSTER 代表集群备份，TENANT 代表租户备份。 |
| \|--beSuccessful          | Boolean | 操作是否成功。                                         |
| \|--taskIdList            | Array   | 任务编号列表，在有异步任务下返回。                               |
| \|--errorCode             | Object  | 错误码。                                            |
| \|--hint                  | String  | 提示信息。                                           |

## 示例

### 请求示例

`POST /api/v2/ob/clusters/1000005/tenants/1000012/backup/backupNow`

```JSON
{
    "obBackupObject": {
        "clusterId": 1000005,
        "tenantId": 1000012,
        "backupDimension": "TENANT"
    },
    "dataBackupMode": "FULL_BACKUP",
    "backupMode": "PHYSICAL_BACKUP",
    "obBackupServiceStorageConfig": {
        "alarmStoragePercentageThreshold": 95,
        "configName": "ycnfs223_0915",
        "obBackupStorageBaseInfo": {
            "backupStorageType": "BACKUP_STORAGE_FILE",
            "storageUrl": "/obbackup/"
        },
        "serviceName": "ycfor223",
        "storageId": 26
    }
}
```

### 返回示例

```JSON
{
    "data": {
        "backupObjectOpsResultList": [
            {
                "beSuccessful": true,
                "obBackupObjectList": [
                    {
                        "backupDimension": "TENANT",
                        "clusterId": 1000005,
                        "tenantId": 1000012
                    }
                ],
                "taskIdList": [
                    3000041
                ]
            }
        ],
        "obBackupTaskType": "DATA_BACKUP_NOW"
    },
    "duration": 51,
    "server": "a83ad33525",
    "status": 200,
    "successful": true,
    "timestamp": "2024-08-07T14:51:41.135+08:00",
    "traceId": "5962f337662d4043"
}
```
