# S3 协议说明

OCP 支持兼容 AWS S3 协议的存储介质，包含原生 AWS S3、华为云 OBS、天翼云 OBS 以及 Google GCS 等。

## AWS S3

与 OSS/COS 一样，AWS S3 也支持通过 delete_mode 参数来配置备份文件的清理模式，配置方法与 OSS/COS 一样。

使用 S3 作为备份介质的配置示例如下：

* 使用 S3 作为备份介质时，系统租户为指定租户 `mysql_tenant` 设置备份目的端并配置为 delete 清理模式。

    ```sql
    obclient> ALTER SYSTEM SET DATA_BACKUP_DEST='s3://oceanbase-test-bucket/backup/data?
    host=s3.<region>.amazonaws.com
    &access_id=****
    &access_key=****
    &s3_region=****
    &delete_mode=delete' TENANT = mysql_tenant;
    ```

* 使用 S3 作为备份介质时，用户租户为本租户设置备份目的端并配置为 delete 清理模式。

    ```sql
    obclient> ALTER SYSTEM SET DATA_BACKUP_DEST='s3://oceanbase-test-bucket/backup/data?
    host=s3.<region>.amazonaws.com
    &access_id=****
    &access_key=****
    &s3_region=****
    &delete_mode=delete';
    ```

示例中，`s3://` 表示使用 S3 作为备份目的端介质类型，存储桶名为 `oceanbase-test-bucket`，在存储桶中的路径是 `/backup/data`，同时使用 `?` 来分隔路径的其他参数。`host` 用于设置 Amazon S3 服务的域名，`access_id` 和 `access_key` 用于设置 AWS 服务的访问秘钥，`s3_region` 在使用 S3 作为备份介质时为必选参数，表示 S3 的存储桶所在的地域，清理模式设置为 `delete`。

## 兼容 S3 协议的对象存储

由于大多数对象存储兼容了 S3 协议，对于兼容 S3 协议并满足 OceanBase 数据库要求（对象存储需要兼容实现了 OceanBase 系统调用的几个 S3 API 的行为）的对象存储均可以作为 OceanBase 数据库的备份介质，并通过访问 S3 的方式来访问兼容的对象存储，如 OBS 和 GCS 等都是通过 S3 协议访问。

**使用 OBS 作为备份介质的配置示例如下:**

* 使用 OBS 作为备份介质时，系统租户为指定租户 `mysql_tenant` 设置备份目的端。

    ```sql
    obclient> ALTER SYSTEM SET DATA_BACKUP_DEST='s3://oceanbase-test-bucket/backup/data?
    host=obs.****.myhuaweicloud.com
    &access_id=****
    &access_key=****' TENANT = mysql_tenant;
    ```

* 使用 OBS 作为备份介质时，用户租户为本租户设置备份目的端。

    ```sql
    obclient> ALTER SYSTEM SET DATA_BACKUP_DEST='s3://oceanbase-test-bucket/backup/data?
    host=obs.****.myhuaweicloud.com
    &access_id=****
    &access_key=****';
    ```

上述示例中，`s3://` 表示使用兼容 S3 协议的对象存储作为备份目的端介质类型，存储桶名为 `oceanbase-test-bucket`，在存储桶中的路径是 `/backup/data`，同时使用 `?` 来分隔路径的其他参数。`host` 用于设置 OBS 服务的域名，`access_id` 和 `access_key` 用于设置 OBS 服务的访问秘钥。

**使用 GCS 作为备份介质的配置示例如下：**

* 使用 GCS 作为备份介质时，系统租户为指定租户 `mysql_tenant` 设置备份目的端。

    ```sql
    obclient> ALTER SYSTEM SET DATA_BACKUP_DEST='s3://oceanbase-test-bucket/backup/data?
    host=https://storage.googleapis.com
    &access_id=****
    &access_key=****' TENANT = mysql_tenant;
    ```

* 使用 GCS 作为备份介质时，用户租户为本租户设置备份目的端。

    ```sql
    obclient> ALTER SYSTEM SET DATA_BACKUP_DEST='s3://oceanbase-test-bucket/backup/data?
    host=https://storage.googleapis.com
    &access_id=****
    &access_key=****';
    ```

上述示例中，`s3://` 表示使用兼容 S3 协议的对象存储作为备份目的端介质类型，存储桶名为 `oceanbase-test-bucket`，在存储桶中的路径是 `/backup/data`，同时使用 `?` 来分隔路径的其他参数。`host` 用于设置 GCS 服务的域名，`access_id` 和 `access_key` 用于设置 GCS 服务的访问秘钥。
