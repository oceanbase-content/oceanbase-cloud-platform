# 使用 OCP 巡检发现 OceanBase 集群潜在风险

本节为您介绍如何通过 OCP 巡检发现 OceanBase 集群潜在风险。

## 应用场景

在 OceanBase 运行的过程中，OCP 提供了实时的监控服务来监控集群以及周边组件的健康状况。如果集群健康有明显的下降（例如 OBServer 宕机），监控系统则会立刻给出相应的告警，这类状况往往具有确定性、突发性、紧急性等特性，若未及时处理往往可能造成严重的后果。当然，除紧急状态外，OceanBase 也会处于亚健康的状态，此类状况往往不会立刻造成什么严重的后果，而是需要一些特定的场景或者时间的积累后，才可能造成相应地影响。结合此类状况往往比较隐匿，发现或者诊断需要一定的查询时间，因此无需实时地、高频率地去监控此类状况。

巡检即是 OCP 专门针对于发现集群潜在风险（亚健康状态）提供的功能。巡检功能最短可以设置一天的周期（或随时手动触发立即巡检），对 Oceanbase 集群、OBProxy 等做潜在风险的挖掘，并最终生成巡检报告。

由于巡检这种非实时的特性，巡检报告中可以呈现更加具体的内容，加上巡检高度自由的配置方式，用户甚至可以自定义任何关心的指标，并灵活地选择展示在报告中内容。

## 前置条件

* OCP 为 V4.0.3 及以上版本。

* OCP 中存在需要被巡检的对象。

## 技术原理

从技术实现上来说，OCP 巡检模块实现了 **数据查询** > **数据处理** > **结果判断** 三个可配置流程，可灵活地在 OCP 未更新版本的情况下自定义新的巡检项。

巡检脚本是整个配置的核心，脚本中可以通过内置对象查询到被巡检对象的监控（metric）、内部表以及通过 agent 接口提供的宿主机的相关状态数据。同时，巡检脚本也可以对查询到的状态进行分析和处理，并将最终处理结果输入到巡检报告中。

OCP 内置巡检项是在一些通用的场景或者实践下总结而来的通用检查项，基本可以满足用户的通用巡检需求，并且内置巡检项也在持续地积累中。OCP 支持用户根据需要定制个性化巡检项，例如根据自己业务的分区键所定制的分区边界检查，此时也可以通过完成上述流程的配置，来添加自定义巡检项。

<main id="notice" type='explain'>
<h4>说明</h4>
<p>自定义巡检项会涉及到对巡检模块中对象的理解以及脚本的编写，此部分目前暂不支持白屏化配置。若您有自定义巡检项需求，可联系 OCP 技术支持进行协助。</p>
</main>

## 操作步骤

### 手动巡检

1. 巡检功能的使用围绕这巡检对象展开，如果不需要对特别的巡检项挑选，在巡检页面选择相应的对象，发起一次巡检即可：

     ![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1156836/1694689720293-cc51351a-9844-4793-addb-3a556edae890.png#clientId=u0b900500-1520-4&from=paste&height=278&id=u66cd7282&originHeight=695&originWidth=2229&originalType=binary&ratio=1&rotation=0&showTitle=false&size=123842&status=done&style=none&taskId=u545e85d1-843c-430c-9bbb-e1674590b02&title=&width=892)

2. 巡检发起后，等待巡检项全部检查完毕，即可查看相应的报告。

### 定时巡检

定时巡检可以针对不同的对象配置不同的巡检时间，或者针对全局的所有的对象配置统一的巡检时间，具体流程如下：

1. 针对对象选择对象的定时巡检规则：

     ![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1156836/1694690065126-7c6fcea3-ba50-4952-9fb0-ae2c78832a0f.png#clientId=u0b900500-1520-4&from=paste&height=268&id=udc55a556&originHeight=672&originWidth=2224&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115043&status=done&style=none&taskId=u1bea92f1-a614-4422-861d-45ea22d5816&title=&width=888)

     或者选择配置全局的巡检规则：

     ![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1156836/1694690125544-4fa8fab3-dbef-4ffe-8190-5f9bd3c81f27.png#clientId=u0b900500-1520-4&from=paste&height=271&id=uf302fbcb&originHeight=671&originWidth=2228&originalType=binary&ratio=1&rotation=0&showTitle=false&size=110738&status=done&style=none&taskId=u37ffe701-5d66-4031-a27a-6abe4b5e007&title=&width=901)

2. 在如下的具体配置界面，针对不同类型的巡检，可以定义不同的巡检周期，可以选择周期的粒度是月，周，日：

     ![image.png](https://intranetproxy.alipay.com/skylark/lark/0/2023/png/1156836/1694690220040-70a655de-0aa6-4108-87f1-ff137e7216ef.png#clientId=u0b900500-1520-4&from=paste&height=372&id=u44d2e584&originHeight=934&originWidth=2218&originalType=binary&ratio=1&rotation=0&showTitle=false&size=95571&status=done&style=none&taskId=u7724ee40-4c76-4600-9cc6-64c18d949e1&title=&width=883)

3. 设定好巡检周期后，巡检会在指定的时间自动触发，巡检报告的呈现方式与手动触发相同

## 常见问题

1. **巡检报告中的 **`**can not query**`** 是怎么回事**

   答：在技术原理一节中也简单介绍了巡检运行的过程。第一步是需要获取到被检查对的相关状态的，`can not query` 便是发生在这个过程中的异常，导致获取不到被巡检对象的状态，也就不能进行后续的       分析和处理。例如我们想要检查某个集群的参数是否配置的合适，第一步就是要去集群查询该参数的实际值，如果此时集群不可连接，那么参数值不可查，报告中相应的检查项便会显示 `can not query`。
        `can not query` 一般都是不可预期的异常导致，如上述例子，集群不可查询本身就是比较严重的症状，所以一般 `can not query` 的检查项都会有风险提示，而引起 `can not query` 的直接原       因，则需要到巡检历史中找到对应的巡检任务，并在任务界面查看相应的错误信息

## 关键巡检项说明

[Clog 同步检查](https://yuque.antfin-inc.com/ob/platform/swgxnan0gtqbhysy)
[网卡速率检查](https://yuque.antfin-inc.com/ob/platform/qzxyz88s8z3m5fvg)
[自增列可用性检查](https://yuque.antfin-inc.com/ob/platform/gf4sryv1f4oxsz95)
