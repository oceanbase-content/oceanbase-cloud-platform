# 双机房场景 OceanBase 租户级日常切换

本节为您介绍在双机房场景下，如何进行 OceanBase 租户级主备库的日常切换。

## 应用场景

在大多数情况下，用户的业务应用通常是按照租户进行隔离的。在此场景下，若使用集群级主备库，会造成以下影响：

* 当租户所在的 OBServer 故障导致该租户不可用时，需要将整个集群 Failover，其他应用也会受到影响。
* 当仅需要对重要业务做高可用时，系统需要同步所有租户的数据，跨机房流量太大。

OceanBase V4.1 从集群级主备库改为了租户级主备库。租户级主备库提供了租户级别的日志同步、Swichover、Failover 能力，解决了以上问题。

OceanBase 主备租户有两种日志同步模式：基于归档的日志同步和基于网络的日志同步。基于归档的同步模式，需要主租户提供完整的数据备份（基线数据）和日志备份（增量日志）恢复出一个备租户，备租户会持续从主租户的归档地址中拉取归档、解析并回放日志。主备同步延迟取决于网络延迟、主租户的归档延迟等，通常延迟比较大。

双机房场景，分别在两个机房部署租户级主备库的示意图如下。

* 基于网络传输日志的主备租户:

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E7%BD%91%E7%BB%9C%E4%BC%A0%E8%BE%93.png)

* 基于日志归档传输日志的主备租户:

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E6%97%A5%E5%BF%97%E5%BD%92%E6%A1%A3.png)

## 前提条件

租户级主备库在进行日常切换时，需 OceanBase 集群满足如下基本条件。

* 主备租户均处于 NORMAL 状态。
* 主备租户所属的 OceanBase 集群必须处于 **运行中** 状态。
* 主备租户的 Switchover Status 必须处于 NORMAL 状态。您可以使用 `root@sys` 连接集群，使用如下 SQL 进行查询。

    ```sql
    SELECT TENANT_ID, TENANT_NAME, TENANT_TYPE, SWITCHOVER_STATUS FROM oceanbase.CDB_OB_TENANTS WHERE TENANT_NAME = ?;
    ```

* 主备租户的类型（TENANT_TYPE）必须为 USER 类型，查询 SQL 同上。
* 主租户的恢复终点时间（RECOVER UNTIL SCN）必须是无穷大，可以使用如下 SQL 查询，查到的值为 `4611686018427387903` 表示无穷大。

    ```sql
    SELECT RECOVERY_UNTIL_SCN FROM oceanbase.CDB_OB_TENANTS WHERE TENANT_NAME = ?;
    ```

* 主备租户的所有日志流均不能无主。可以使用如下 SQL 查询，查询出的值为 `0` 表示日志流均有主。

    ```sql
    SELECT COUNT(1) FROM CDB_OB_LS A LEFT JOIN GV$OB_LOG_STAT B ON A.LS_ID = B.LS_ID
        AND A.TENANT_ID = B.TENANT_ID
        AND B.ROLE = 'LEADER'
    WHERE B.LS_ID IS NULL
        AND A.STATUS NOT IN ('CREATING', 'CREATED', 'TENANT_DROPPING', 'CREATE_ABORT', 'PRE_TENANT_DROPPING')
        AND A.TENANT_ID IN (?, (? - 1));
    ```

* 主备租户均不能处于锁定状态。
* 备租户所属的 OceanBase 集群中，所有 OBServer 必须处于 ACTIVE 状态。
* 主备租户所属的 OceanBase 集群版本必须保持一致。

## 注意事项

若原主租户用于承载 Binlog Service 的 MetaDB 信息，主备租户切换将会导致 Binlog 服务不可用，请谨慎操作。

## 操作步骤

### 方式一：对指定主备租户进行日常切换

该方式适用于将指定主租户切换为备租户的场景。

1. 登录 OceanBase 云平台。

2. 单击左侧导航栏 **租户** ，在 **租户列表** 中进入主租户。

3. 单击右上角更多图标，选择 **日常切换** 。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/420/%E7%A7%9F%E6%88%B7%E6%97%A5%E5%B8%B8%E5%88%87%E6%8D%A2.png)

4. 在对话框中查看租户切换的信息，单击 **开始切换** 。

    ![11221339](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E6%97%A5%E5%B8%B8%E5%88%87%E6%8D%A2.png)

5. 单击对话框中的任务 ID，查看任务进度。

### 方式二：对集群下的所有主备租户进行日常切换

该方式适用于集群运维操作前，为保证业务连续性，需要用备租户支持业务的场景。您可参考此方式，将集群下的所有主租户切换为备租户。

1. 登录 OceanBase 云平台。

2. 单击左侧导航栏 **集群** ，在 **集群列表** 中进入集群 **概览** 页面。

3. 单击右上角更多图标，选择 **租户日常切换** 。

   ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/420/%E7%A7%9F%E6%88%B7%E6%97%A5%E5%B8%B8%E5%88%87%E6%8D%A2-%E9%9B%86%E7%BE%A4.png)

4. 在对话框中勾选需要切换的租户，单击 **日常切换** 。

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/430/%E7%A7%9F%E6%88%B7%E6%97%A5%E5%B8%B8%E5%88%87%E6%8D%A2.png)

5. 单击对话框中的任务 ID，查看任务进度。

## 常见问题

**OCP V4.2.0 创建备租户时，在 Create standby tenant 子任务报错 “FETCH LOG TIMEOUT”**

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%88%9B%E5%BB%BA%E5%A4%87%E7%A7%9F%E6%88%B7%E5%A4%B1%E8%B4%A5.png)

报错信息如上图所示。报错原因为主租户 CLOG 过多，备租户在 FETCH CLOG 时，发生了 RPC 超时。您可通过在主租户的参数管理中，调大参数 `standby_db_fetch_log_rpc_timeout` 的值进行解决。

**执行日常切换报错 “租户的日志同步延迟 xx ms 大于 xxx ms，不允许该操作”**

* 如果是基于网络的主备租户。

  1. 检查当前主备租户日志同步是否正常，可以在 OCP 上查看租户拓扑图，查看是否有同步异常提示。
  2. 若同步延迟不是很大，并且不是持续增涨的，排查是否由于网络延迟或备租户 CPU 资源不足导致的。
  3. 若上一步排查出具体原因后仍想完成日常切换，可修改 OCP 的系统参数 `ocp.standby.tenant.delay.threshold`，增大主备延迟阈值后继续切换。

* 如果是基于归档的主备租户，查看主租户的的参数 `archive_lag_target` 是否设置的过大，此参数为主租户备份延迟。
