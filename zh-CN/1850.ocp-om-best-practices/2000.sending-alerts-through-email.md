# 通过邮箱发送告警

您可以通过邮箱发送告警，使用邮箱客户端查看告警。

## 前提条件

* 已获取 STMP 服务和端口（25 和 465 为默认值，可根据环境而定），默认使用 25 端口时不启用 TLS，使用 465 端口时启用 TLS。

* 部分系统需提供发送邮箱的用户邮箱和密码。

## 操作步骤

1. 在左侧导航栏中，单击 **监控告警** > **告警**。

2. 在告警详情页中，单击 **告警通道**。

    ![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E9%92%89%E9%92%89%E5%91%8A%E8%AD%A6-1.png)

3. 然后在告警通道页签下，单击 **新建通道**。

4. 配置邮件告警通道。

    1. 基本配置。

        ![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6-1.png)

        | 选择项 | 是否必选 | 描述 |
        |-------|----------|------|
        | 通道类型 | 是 | 下拉选择邮件。 |
        | 通道名 | 是 | 自定义通道名称，方便后续识别。 |
        | 收件人邮件地址 | 是 | 用户接收告警的邮箱地址。 |

    2. 通道配置。

        ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6-2.png)

        | 选择项 | 是否必选 | 描述 |
        |-------|----------|------|
        | SMTP 服务器 | 是 | STMP 服务地址，例如 `stmp.163.com`。 |
        | 端口 | 是 | STMP 服务端口，使用 25 端口并不启用TLS；使用 465 端口并启用 TLS（25 和 465 为默认值，可根据环境而定）。 |
        | 启用 TLS | 是 | 打开开关后启用 TLS 协议。 |
        | 用户名 | 是 | 如有些系统为发送邮件的邮箱地址，也可能是其他账号。 |
        | 密码 | 是 | 用户名对应的密码，有些系统为发送邮件的邮箱密码。 |
        | 发送人邮件地址 | 是 | 一般是邮箱地址，特殊情况可修改。 |

    3. 消息配置。

        ![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/421/%E9%85%8D%E7%BD%AE%E9%82%AE%E7%AE%B1%E5%91%8A%E8%AD%A6-3.png)

        1. 消息格式的默认配置，OB Cloud 4.2.1 之前的版本为文本格式，4.2.1 及之后的版本更改为 markdown 格式。

        2. 消息结构可以更改，默认的消息格式样例：

           设置 **消息格式** 为 `markdown`，可通过输入 `${}` 引入变量。

            ```shell
            ### OCP 告警通知 ${alarm_name}
            - 级别：${alarm_level}
            - 告警对象：${alarm_target}
            - 概述：${alarm_summary}
            - 生成时间：${alarm_active_at}
            - 详情：${alarm_description}
            - OCP 链接：${alarm_url}
            ```

5. 其他功能。

   告警消息聚合：可以开启通道聚合功能，避免一段时间内一条告警发送多次。OCP 告警默认 3 分钟（从 4.1.0 版本开始）产生一次告警，开启告警通道聚合之后，相同告警默认 1 小时仅发送一次。

6. 单击 **提交**，完成配置。

## 常见问题

* OCP 4.2.0 之前不支持发送到多个邮箱地址。
* OCP 4.2.0 之前使用 465 端口并启用 TLS 发送告警会失败，需使用 25 端口并不启用 TLS，或者升级 OCP 版本到 4.2.0 及之后版本。
