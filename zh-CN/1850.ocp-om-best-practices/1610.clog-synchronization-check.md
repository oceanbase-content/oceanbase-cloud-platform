# Clog 同步检查

本节为您介绍如何对 Clog 同步进行检查。

## 应用场景

该巡检项用以检查 OceanBase 集群中是否存在 Clog 不同步的分区。

## 前置条件

OceanBase 版本小于 4.0

## 技术原理

OceanBase Clog 的全称是OceanBase Commit Log, 是OceanBase日志服务的核心。日志服务是OceanBase的基础组件，承担着支持事务的原子性、持久性、隔离性以及数据库高可用等核心功能。在数据库提交的过程中通过Paxos协议保证多数派Clog落盘，而少数派Clog日志内容也会最终会持久化在硬盘上。OceanBase也有自动的日志回收机制来保证日志盘的持续可写入。OceanBase Clog 作为 OceanBase 最重要的基础模块之一，在整个系统架构的重要作用主要有：

- 通过在事务提交时持久化Memstore提交记录的内容以及事务状态信息，保证事务的原子性（Atomic）和持久性(Durability)；
- 通过生成事务版本（trans_version），并通过消息同步到所有Follower副本，保证事务的隔离性（Isolation）；
- 通过实现Paxos协议将日志在多数派副本上实现强同步，为分布式数据库的数据容灾以及高可用提供支持；并进而支持各类副本类型（只读副本、日志副本等）；
- 通过维护权威的副本成员组和Leader信息，为OceanBase中的各个模块所使用。为RootService的负载均衡、轮转合并等复杂策略提供底层机制；
- 提供外部数据服务，为DRC和增量备份等外部工具提供增量数据。

在OceanBase事务提交中，分区的Leader副本和Follower副本组成了Paxos组将Clog日志从Leader副本同步到Follower节点，Follower副本会做周期性的检查，如果发现Follower副本间隔一段时间内最新确认的日志一直没有更新，Follower部分会主动从Clog部分发起Clog Fetch动作，采取主动拉取地方式来将Clog按批同步到Follower副本上。当节点发现Clog同步已经有比较大的延迟时， Follower副本会从Leader副本来做rebuild基线的动作；这是因为Clog 本身是循环复用的结构，当Clog延迟比较大的时候，需要从Leader副本的SSTable中拉取数据。

## 排查步骤

对集群对象发起基础巡检后，如果存在 Clog 不同步的情况，该巡检项会详细列出对应的租户，表名，OBServer 的 IP，分区 index 等信息。导致 Clog 不同步可能由以下原因造成：

1. 节点之间的网络延迟。通过简单的 `ping` 命令即可检查网络的延迟
2. Follower分区的Clog滑动窗口满。Follower分区会暂停接收leader发过来的Clog，并且会在observer.log中打印`"check_can_receive_log, now can not recieve log"`消息，直至有Clog从窗口中滑出。如果长时间的Follower节点滑动窗口满掉且没有自动缓解，如果影响了多数派的Clog提交，会影响事务提交。如影响了少数派的Clog提交，会导致Follower节点的Clog一直落后
