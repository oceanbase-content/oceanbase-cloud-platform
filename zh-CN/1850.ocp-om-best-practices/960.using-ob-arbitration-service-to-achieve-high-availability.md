# 双机房场景使用 OceanBase 仲裁服务实现高可用

## 应用场景

OceanBase 的外部用户在同城中往往只有两个机房可用，为提供机房级容灾能力，OceanBase 提供了两地三中心的解决方案：

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E4%B8%A4%E5%9C%B0%E4%B8%89%E4%B8%AD%E5%BF%83.png)

Region1 的 Zone1、Zone2 两个机房分别部署两个 F 副本，Region2 的 Zone3 机房部署 1 个 L 副本。因此，在 Zone1、Zone2 任意一个机房宕机的场景下，Paxos 的五个副本仍有三个提供服务，保证服务的持续可用。

采用上述两地三中心方案后，在实际的容灾场景中，用户可能会遇到了如下问题：

* **机房故障场景下业务 RT 变高**

  * 在 Zone1、Zone2 均可正常提供服务时，Paxos 的多数派仅需在同城达成，单次日志的同步延时在 1ms 以下。
  * 在 Zone1、Zone2 任意一个机房宕机的场景下，Paxos 的多数派需要跨城达成，单次日志的同步延时往往需要 5~10ms。
  * 同步延时的变化会大大影响业务的体验。

    针对此问题，OceanBase 提供了将 5 副本降级为 3 副本的能力，该变更是一个运维动作，需要用户手动执行，操作详情可参考 [缩减 OceanBase 集群及租户的高可用](400.reduce-the-high-availability-of-ob-clusters-and-tenants.md)。

* **跨城网络带宽资源稀缺**

    两地三中心正常工作的前提是 Region2 和 Region1 的网络带宽充足。若带宽不足，会导致业务高峰期时 Region2 的日志落后，在 Region2 的日志追平之前，若 Region1 的机房发生故障，则会导致集群整体不可用。跨城的网络带宽是一个稀缺且高成本的资源，多数外部用户在评估业务是否可以使用 OceanBase 时，均面临需要多少带宽这样的一个必选问题，而针对该问题，OceanBase 一直未有效的给出一个合理的答案。

    OceanBase 的典型部署模式是 2F+1L。三副本来源于 Paxos 高可用的容灾需求，1L 来源于进一步减少数据存储空间成本的需求。在 2F+1L 的部署模式下，1L 所在节点的日志存储成本和相应的 CPU 资源开销仍需要内部消化，降低了 OceanBase 整体方案的竞争力。

基于上述考虑，仲裁方案需要支持 2F+1A 的能力，替换掉 2F+1L 的部署模式，这可以进一步降低 OceanBase 的总成本。同时相比友商云上 MySQL 类产品的同步模型，OceanBase 仲裁方案能够提供任一节点或机房故障场景下的无损双活能力，这相比其他产品会具备显著的产品优势。

双机房 2F+1A 部署模式示意图如下:

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/%E5%8F%8C%E6%9C%BA%E6%88%BF.png)

## 前置条件

* OceanBase 集群的版本高于 V4.1.0.0。
* 为确保 RPC 格式兼容，A 的版本需要等于或者略高于 F 的版本（尽量保持 A 和 F 的版本一致）。
* OceanBase 租户必须是 2F 或者 4F 部署，目前仅支持 2F+1A 或 4F+1A。

## 操作步骤

**步骤一: 新建仲裁服务**

1. 登录 OCP 。

2. 在左导航栏单击 **集群** ，系统默认进入 **集群列表** 页签。

3. 单击 **仲裁服务** 页签，进入 **仲裁服务列表** 页面。

4. 单击右上角 **新建仲裁服务** 。

5. 在 **新建仲裁服务** 面板中，设置仲裁服务的基础信息。

6. 单击 **确定**，可单击弹窗中的任务 ID 查看任务执行状态。

    系统会对所填信息进行校验。若校验不通过，您可根据页面提示进行排查或修改。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/422/%E6%96%B0%E5%BB%BA%E4%BB%B2%E8%A3%81%E6%9C%8D%E5%8A%A1.png)

**步骤二: 仲裁服务关联 OceanBase 集群**

1. 登录 OCP 。

2. 在左侧导航栏单击 **集群** ，系统默认进入 **集群列表** 页签。

3. 选择待操作的集群并单击其集群名。

4. 在集群 **概览** 页面，您可以通过以下 2 种方式为集群添加仲裁服务。

   * 单击右上角 **...** 图标，选择 **添加仲裁服务** 。
   * 在 **仲裁服务列表** 模块，单击 **添加仲裁服务** 。

5. 在 **添加仲裁服务** 面板中，为集群选择仲裁服务地址。

6. 单击 **提交**。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/410/%E6%B7%BB%E5%8A%A0%E4%BB%B2%E8%A3%81%E6%9C%8D%E5%8A%A1.png)

**步骤三: 开启租户仲裁**

1. 登录 OCP 。

2. 在左导航栏单击 **租户** ，系统默认进入 **租户列表** 页签。

3. 选择待操作的租户并单击其租户名。

4. 在租户 **概览** 页面的 **基本信息** 模块，确认租户副本为 2F 或 4F，并开启 **仲裁服务**。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/422/%E7%A7%9F%E6%88%B7%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF.png)

## 常见问题

**升级 OceanBase 集群时报错 “OceanBase 集群 xx 版本 xx 无法直升到仲裁服务版本 xx，两者版本不保证兼容”**

在如下场景中，OceanBase 集群版本与仲裁服务版本需要保证兼容。因此，在 OceanBase 集群升级时，需要对关联了仲裁服务的集群进行版本兼容性检查。

* 场景 1: 关联 OceanBase 集群和仲裁服务，A 为仲裁服务版本，B 为 OceanBase 集群版本。
* 场景 2: 创建 OceanBase 集群，若创建时选择仲裁服务，A 为仲裁服务版本，B 为 OceanBase 集群版本。
* 场景 3: 替换 OceanBase 仲裁服务，A 为目标仲裁服务版本，B 为 OceanBase 集群版本。
* 场景 4: 升级 OceanBase 集群，A 为仲裁服务版本，B 为目标 OceanBase 版本。
* 场景 5: 升级仲裁服务，A 为目标仲裁服务版本，B 为 OceanBase 版本。

A、B 两者版本兼容的规则如下:

* 当 A 和 B 的一级版本和二级版本号均一致，则保证兼容。例如 A、B 均为 V4.2.x.x。
* 当 A 的一级版本和二级版本小于 B 的一级版本和二级版本，则认为不能兼容。例如 A 为 V4.1.x.x，B 为 V4.2.x.x。
* 当 A 的一级版本和二级版本大于 B 的一级版本和二级版本，若 B 可以直接升级到 A，中间无其他版本，则认为 A 和 B 一定可以兼容；否则认为不能兼容。

**开启租户仲裁时报错 “仲裁服务 CPU 使用率:{0}%、内存使用率:{1}%、Clog 盘可用:{2}MB，不满足 CPU 使用率 < {3}%、内存使用率 < {4}%、Clog 盘可用 > {5}MB，无法开启租户仲裁”**

仲裁服务每开启一个租户仲裁，都会消耗一部分主机资源（CPU、内存）。为确保能提供仲裁高可用服务，OCP 在开启租户仲裁时，会对主机的剩余资源进行检查。您可通过修改以下系统参数绕过此检查:

* `ocp.arbitration.min.remain.disk.size`: 开启租户仲裁时，仲裁服务主机 CLOG 盘剩余最小值，单位为 `MB`。数据格式 `(a,b)` 表示租户副本分别为 2F、4F 时的值。
* `ocp.arbitration.max.cpu.used.percentage`: 开启租户仲裁时，仲裁服务主机最大 CPU 使用率，单位为 `%`。
* `ocp.arbitration.max.memory.used.percentage`: 开启租户仲裁时，仲裁服务主机最大内存可用率，单位为 `%`。
