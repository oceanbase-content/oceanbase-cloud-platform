# 资源隔离概述

本文主要介绍了资源隔离相关的背景、概念、维护元素及资源隔离方式。

## 背景

OceanBase 数据库是多租户的数据库系统，为了确保租户间不出现资源争抢保障业务稳定运行， OceanBase 数据库针对租户间的资源进行了隔离。

OceanBase 数据库中把 Unit 当作给租户分配资源的基本单位，一个 Unit 可以类比于一个 Docker 容器。一个节点上可以创建多个 Unit，在节点上每创建一个 Unit 都会占用一部分该节点的 CPU、内存等物理资源，节点的资源分配情况会记录在内部表中以便 DBA 查看。

一个租户可以在多个节点上放置多个 Unit，但一个特定的租户在某个节点上只能有一个 Unit。一个租户的多个 Unit 相互独立，OceanBase 数据库目前没有汇总多个 Unit 的资源占用进行全局的资源控制, 具体来讲，不会因为一个租户在某个节点上的资源没得到满足，就让它在另一个节点上去抢其它租户的资源。

所谓资源隔离，就是节点控制本地多个 Unit 间的资源分配的行为, 它是节点本地的行为。类似的技术是 Docker 和虚拟机，但 OceanBase 数据库并没有依赖 Docker 或虚拟机技术，而是在数据库内部实现资源隔离。

OceanBase 实现了租户间的资源隔离及管理，如 CPU、内存、IOPS 等，而在同一个租户内不同用户、后台任务也有资源使用的隔离需求，如后台迁移/合并任务尽量避免占用过多资源，影响业务；大查询尽量避免影响 TP 响应时间等。

## 概念

cgroup （Control Groups）是 Linux 内核提供的一种机制，这种机制可以根据特定的行为，将一系列系统任务及其子任务整合（或分隔）到按资源划分等级的不同组内，从而为系统资源管理提供一个统一的框架。

OceanBase 数据库的当前版本中，由于租户工作线程和大部分后台线程均根据租户来区分，网络线程为共享线程，管理员可以在配置 cgroup 目录后，再通过租户中的 **资源隔离** 功能来控制租户 CPU 和 IOPS 的占用。

## 维护元素

OCP 的资源隔离主要用于维护以下元素：

* 资源组：根据资源要求组合在一起的一组会话。系统将资源分配给资源组，而不是单个会话。

* 资源管理计划：资源管理计划内容的容器，指定如何将资源分配给资源组。您可以通过激活特定的资源管理计划来控制资源的分配。一条资源管理计划可以对应多条资源管理计划内容。但一条资源管理计划中不能包含两条相同的资源管理计划内容。

* 资源管理计划内容：用于将资源组与资源管理计划相关联，并指定如何将资源分配给该资源组。

## 资源隔离方式

OCP 的资源隔离从使用粒度，可以分为以下三种类型：

* **用户资源隔离**

    用于指定用户与资源组的映射关系，使该用户执行的所有 SQL 使用的资源即为对应 Group 分配的资源，通过使用该特性，可以让不同用户执行不同类型的任务。

* **后台任务隔离**

    用于指定后台任务与资源组的映射关系，隔离各任务使用的资源。当前支持 8 种后台任务的使用资源。

  * compaction_high： Mini Merge 和 DDL KV Merge 任务。

  * ha_high：复制、Rebuild 和恢复等高优先级高可靠任务。

  * compaction_mid：Minor Merge 任务。

  * ha_mid：中优先级高可靠任务，例如迁移任务。

  * compaction_low：Major Merge 任务。

  * ha_low：备份和备份清理等低优先级高可靠任务。

  * ddl：唯一索引校验、删列补数据等场景的任务。

  * ddl_high：DDL MemTable 的转储任务。

* **SQL 级资源隔离**

    SQL 级的资源隔离是比用户级粒度更细的隔离方式。通常适用的场景是，业务中存在多个账号，处理一个账号的一个订单时，会开启一个事务然后执行一批与该账号相关的 SQL （通常是在 WHERE 条件中指定账号的值）。账号中可能存在大账号（数据量较大）和小账号（数据量较小），为了避免大账号把 CPU 资源用完导致小账号的订单无法得到处理，可以将处理不同订单的 SQL 绑定到不同的资源组，绑定后不同订单的 SQL 就会使用不同资源组的资源。
