# 收集统计信息

本节为您介绍如何收集统计信息，OCP 支持自动收集统计信息和手动收集统计信息两种方式。

## 自动收集统计信息

默认情况下，OceanBase 优化器通过维护窗口来进行每日自动统计信息收集，从而保证统计信息能够迭代更新。其中周一到周五的任务默认开始时间为 22:00，最大收集时长 4 小时，周六周日的默认开始时间为 6:00，最大收集时长为 20 小时，具体如下表。

|    维护窗口名字    |  开始时间  |  频率   |  最大收集时长  |
|--------------------|-----------|---------|------------------|
| MONDAY_WINDOW      |  22:00    | WEEKLY  |  4h   |
| TUESDAY_WINDOW     |  22:00    | WEEKLY  |  4h   |
| WEDNESDAY_WINDOW   |  22:00    | WEEKLY  |  4h   |
| THURSDAY_WINDOW    |  22:00    | WEEKLY  |  4h   |
| FRIDAY_WINDOW      |  22:00    | WEEKLY  |  4h   |
| SATURDAY_WINDOW    |  6:00     | WEEKLY  |  20h   |
| SUNDAY_WINDOW      |  6:00     | WEEKLY  |  20h   |

您可以根据业务的实际情况合理配置维护窗口。例如当维护窗口刚好与业务高峰重合，可以调整维护窗口的开始时间，或者在特定日期不做统计信息收集。当业务环境中表的数量很多，或存在很多超大表的时候，可以调整维护窗口的收集时长。

您可参考如下路径调整自动收集统计信息的相关配置。

1. 登录 OCP。

2. 在左侧导航栏选择 **租户** ，系统默认进入 **租户列表** 页签。

3. 在 **租户列表** 中选择待操作的租户并单击其租户名，进入租户 **概览** 页面。

4. 在显示的页面的左侧导航栏上，单击 **统计信息管理** 。

5. 进入 **统计信息收集** 概览页面，单击页面右上角 **自动统计信息收集** 按钮。

<main id="notice" type='notice'>
<h4>注意</h4>
<p>当租户所属集群为 V4.2.2.1 版本时，调整自动收集统计信息时会重复出现维护窗口。建议您直接使用系统默认配置，避免因调整配置导致系统报错。</p>
</main>

### 关闭/开启自动收集统计信息

OCP 默认所有维护窗口均为开启状态，您可单击维护窗口操作列的 **关闭** 或 **开启** 按钮，来关闭或开启自动收集统计信息。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/202411151514.png)

### 编辑自动收集统计信息配置

当您需要对自动收集统计信息的配置进行修改时，可单击维护窗口操作列的 **编辑** 按钮，调整自动收集统计信息的开始时间及最大收集时长。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/202411151521.png)

### 修改自动统计信息收集的参数信息<a id="parameter"></a>

在进行自动收集统计信息时，OCP 针对收集方式、收集的并行度、收集的粒度等参数信息进行了默认配置。您可直接使用系统现有的配置，也可根据业务实际情况单击参数后的编辑按钮进行修改。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/202411151608.png)

具体参数说明如下：

|      参数名      |           默认值               | 取值范围  |      描述       |
|------------------|--------------------------------|----------|-----------|
| `cascade`          | `DBMS_STATS.AUTO_CASCADE`        | <li>`TURE`</li><li>`FALSE`</li>  | 是否同时收集表的索引统计信息。    |
| `degree`           | `NULL`（即并发度为 1）           | [0,100]  | 统计信息收集时的并行度。       |
| `estimate_percent` | `DBMS_STATS.AUTO_SAMPLE_SIZE`    | [1,100]，若指定为 NULL，则使用所有数据。  | 指定使用多少比例的数据计算其分布特征。     |
| `granularity`      | `AUTO`                           | <li>`GLOBAL`：收集全局级别的统计信息。</li><li>`PARTITION`：收集分区级别的统计信息。</li><li>`SUBPARTITION`：收集子分区级别的统计信息。</li><li>`ALL`：收集所有级别的统计信息，包括 `GLOBAL`、`PARTITION` 和 `SUBPARTITION`。</li><li>`AUTO`：使用默认方式收集所有级别的统计信息，包括 `GLOBAL`、`PARTITION` 和 `SUBPARTITION`。不设置 `granularity` 时，`AUTO` 为默认值。</li><li>`DEFAULT`：收集 `GLOBAL` 和 `PARTITION` 级别的统计信息。 </li><li>`GLOBAL AND PARTITION`：收集 `GLOBAL` 和 `PARTITION` 级别的统计信息。</li><li>`APPROX_GLOBAL AND PARTITION`：收集分区级别的统计信息，并根据分区信息推导出全局级别的统计信息。</li> | 统计信息收集时的分区粒度。      |
| `method_opt`       | `FOR ALL COLUMNS SIZE AUTO`      | <li>`FOR ALL COLUMNS SIZE AUTO`：OceanBase 数据库优化器根据列的使用情况，来决定是否收集列的直方图。直方图桶个数使用默认值 254。</li><li>`FOR ALL COLUMNS SIZE SKEWONLY`：仅收集数据分布不均匀的列的直方图。直方图桶个数使用默认值 254。</li><li>`FOR ALL COLUMNS SIZE REPEAT`：仅收集被收集过直方图的列的直方图。使用之前收集直方图设置的桶个数。</li><li>`FOR ALL COLUMNS SIZE integer`：指定收集列的直方图桶的个数，取值范围为 [1,2048]。</li> | 设置列级别的统计信息收集方式。       |

## 手动收集统计信息

当存在超大表或过多表的场景下，OceanBase 优化器的默认统计信息收集策略可能会导致表的统计信息在一次维护窗口中收集不完，此时可手动收集统计信息。根据收集对象的不同，手动收集分为 **收集 Schema 级别统计信息** 和 **收集表级别统计信息** 两种。

<main id="notice" type='notice'>
<h4>注意</h4>
<p><li>统计信息收集操作会消耗 CPU、IO 等硬件资源，执行本操作时请合理评估业务负载。</li><li>后台异步更新数据库上所有统计信息，请勿频繁提交。</li></p>
</main>

### 收集 Schema 级别统计信息

**收集 Schema 统计信息** 用于对整个租户下的所有表进行统计信息收集。

#### 操作步骤

1. 登录 OCP。

2. 在左侧导航栏选择 **租户** ，系统默认进入 **租户列表** 页签。

3. 在 **租户列表** 中选择待操作的租户并单击其租户名，进入租户 **概览** 页面。

4. 在左侧导航栏上选择 **统计信息管理**，进入 **统计信息管理** 概览页面。

5. 单击页面右上角 **收集 Schema 统计信息** 按钮。

6. （可选）在右侧弹出的面板中选择需要收集统计信息的数据库，并配置统计信息收集的参数信息。

    关于统计信息收集参数的说明，详见 [修改自动统计信息收集的参数信息](#parameter)。

7. 单击 **确定**。

#### 操作示例

以下通过一个简单的示例为您演示手动收集 Schema 级别统计信息的具体流程：

1. 进入 **统计信息收集** 概览页面，单击页面右上角 **收集 Schema 统计信息** 按钮。

2. 页面弹出 **收集 Schema 统计信息** 面板。

3. 选择具体需要收集统计信息的数据库，支持模糊搜索。下拉列表中会罗列出租户下所有的数据库，仅支持选择一个。

4. 对统计信息收集的参数进行修改，以 **仅收集分区级别的统计信息**、**统计信息收集时的并行度为 5**、**不同时收集表的索引统计信息**、**其它参数保持默认配置** 为例：

    1. 修改 `granularity` 的参数值为 `PARTITION`。

    2. 修改 `degree` 的参数值为 5。

    3. 修改 `cascade` 的参数值为 `FALSE`。

    4. 其它参数不做任何改动。

5. 单击 **确定**。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/433/202411151956.png)

### 收集表级别统计信息

除了手动的对 Schema 级别统计信息的收集以外，OCP 还支持在 **统计信息表** 模块对用户下的单表进行统计信息收集。若列表中存在分区表，支持展开分区进行更细粒度地手动收集统计信息。

#### 操作步骤

1. 登录 OCP。

2. 在左侧导航栏选择 **租户** ，系统默认进入 **租户列表** 页签。

3. 在 **租户列表** 中选择待操作的租户并单击其租户名，进入租户 **概览** 页面。

4. 在左侧导航栏上选择 **统计信息管理**，进入 **统计信息管理** 概览页面。

5. 在 **统计信息表** 模块，选择需要收集统计信息的业务表，单击操作列的 **收集**。

6. 在右侧弹出的面板中配置统计信息收集的参数信息（可选）。

    关于统计信息收集参数的说明，详见 [修改自动统计信息收集的参数信息](#parameter)。

7. 单击 **确定**。

#### 相关操作

* 在 **统计信息表** 右上角的搜索框中输入业务表名称，并单击搜索符号，**统计信息表** 中将返回符合条件的业务表。

  * 查询格式为 `schema.table` 或 `table`。
  * 仅表名称支持模糊匹配。

* 当业务表为 **正常** 状态时，除支持执行 **收集** 外，还支持进行 **锁定** 操作。
* 当业务表为 **已锁定** 状态时，仅支持进行 **解锁** 操作。
