# OCP V4.0.1

#RNDate#2022-12-28

## 版本信息

* **版本号：** V4.0.1

* **前置版本：** V4.0.0

* **版本发布日期：** 2022年 12 月 28 日

* **支持的升级路径：** 对于 OCP V2.3.0 之前版本，需要首先升级到 V2.3.x 版本，再将 V2.3.x 版本升级到 V3.3.4 版本，最后再从 V3.3.4 版本升级到当前版本。对于 OCP V2.3.x 及之后、V3.2.4 之前的版本，需先升级到 V3.3.4 版本，再从 V3.3.4 版本升级到当前版本。对于 OCP V3.2.4 及之后的版本，可直接升级到当前版本。

<main id="notice" type='notice'>
    <h4>注意</h4>
    <p>MetaDB 为 1479 版本的 OCP，请暂缓升级到 OCP V4.0.1 版本。如有升级需要，请联系技术支持。</p>
    </main>

## 支持的 OceanBase 数据库版本

OCP V4.0.1 版本支持下表所列版本的 OceanBase 数据库。

* OceanBase V1.4.x

* OceanBase V2.1.x

* OceanBase V2.2.x

* OceanBase V3.1.x

* OceanBase V3.2.x

* OceanBase V4.x

## 新增功能

### 总览

随着 OCP 管理的对象越来越丰富，功能越来越完备，很多高频且重要的信息散落在各个模块中，需要您手动进行汇总整理。为了解决这个问题，OCP 新增全局 **总览** 功能模块，提供了 OCP 管理资源的全局视角。打开 OCP 首页后，资源状态、消耗、性能等信息一触即达。

* **状态类总览**

  * 监控 OceanBase 集群、租户、OBProxy 集群、主机状态，标记异常资源。
  * 监控告警、备份、运维、合并的任务状态，了解全局任务信息。
  * 统计 SQL、会话、事务、安全诊断信息，掌握性能风险。

* **资源类总览**

  * 展示 Top5 集群 CPU、内存、磁盘的分配情况，突出高资源分配集群。
  * 展示 Top5 租户 CPU、内存、数据的使用情况，突出高资源消耗租户。

* **性能类总览**

  * 支持 OceanBase 集群、租户、OBProxy 集群、主机的相关性能监控指标。
  * 支持选择集群维度或租户维度、全部集群或指定集群查看 Top5 性能。

![1](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E6%80%BB%E8%A7%88.png)

### 诊断中心

在 **安全诊断** 模块，新增了 **高危 SQL** 和 **新增 SQL** 两个模块。

* 高危 SQL：帮助客户识别多种规则判断的高危 SQL，包括一些 DDL 操作，及更新、删除、返回过多的记录；或全表更新、删除对数据安全、系统平稳运行有危害的 SQL。
* 新增 SQL：对于一些 7 天内没有运行过的新出现的 SQL 进行汇总统计，提前发现性能风险。

在 **SQL 诊断** 模块，新增了 SQL 对比能力。

OCP 在 SQL 诊断部分已经支持了 TopSQL 的能力，可以从总耗时、执行次数、平均响应时间等各个维度去统计一段时间内 SQL 的信息并进行排序，找出在这一段时间内最耗资源、最需要关注的 SQL。但是在数据的日常运维中，变化的情况有可能是我们需要关注的，比如一周内同一时间点内是否有所不同、前后时间段内是否有所不同。OCP 本次迭代支持不同时间段的 TopSQL 的对比，支持查看对比时间段内的性能走势，并且会按照一定的规则（新的 TopSQL、执行次数、返回行数、执次次数失败比例、执行计划比例等），告知您需要关注的 SQL 运行变化点，提前发现问题并进行优化。

![2](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E6%98%8E%E7%BB%86%E6%95%B0%E6%8D%AE1.png)
![3](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E6%80%A7%E8%83%BD%E8%B6%8B%E5%8A%BF1.png)

同时，在 **发现 > 诊断 > 优化 > 应急** 的链路，OCP 将告警、监控、诊断、日志等模块进行了能力的串接。

1. 接收到告警后打开 OCP，进入首页的告警汇总模块，可单击告警信息进入告警列表页查看具体告警详情。对于告警详情，系统会展示对应时间段的监控信息，同时您可到具体资源的监控页面查看更多的监控信息来排查问题。
2. 租户的监控页面，新增诊断入口 **SQL 诊断** 按钮，单击后可跳转到 SQL 诊断页面，选择时间范围后单击 **查询**，即可查看该时间段的 SQL 执行定位问题。

### 租户备份

支持 V4.0.0 版本的集群按照租户的维度进行备份策略的设定，您可以根据租户的重要等级，对租户设定不同的备份策略，包括周期、备份方式等，同时也支持在集群级别设置备份策略（仅对未设置租户备份策略的租户生效），满足您更多的配置需求。

1. 您可在不设定集群级备份策略的情况下，只对单个或多个租户进行备份策略的设定。
2. 您可在已设定集群备份策略的情况下，对部分租户单独设置备份策略。

![4](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E9%9B%86%E7%BE%A4%E7%BA%A7%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5.png)
![5](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E7%A7%9F%E6%88%B7%E7%BA%A7%E5%A4%87%E4%BB%BD%E7%AD%96%E7%95%A5.png)

### 告警

OCP 的告警能力作为非常核心的企业级功能，为集群及相关对象提供了及时安全预警保障能力。为了提升告警的运维体验，降低告警配置的复杂度，以及更好地支持交付服务人员，V4.0.1 版本全面优化了告警功能，简化原有的告警配置流程，增强了告警能力，让您可以通过平台自助进行告警相关配置。

* **能力提升**
  * 新增多指标告警配置，支持将多个不同指标以 **“AND”** 或 **“OR”** 的方式组合配置告警规则。
  * 新增告警模版功能，支持为告警对象设置批量的告警规则，并提供默认告警模版供您使用。
  * 新增按标签屏蔽告警，支持按照特定标签（如 SQLID、会话 ID）屏蔽告警，告警屏蔽更加精确。
  * 新增钉钉、企业微信、飞书、邮箱告警通道类型，配置简单，最少仅需两个表单即可完成通道配置。
* **配置优化**
  * 告警事件
    * 删除原告警消息模块，支持在告警事件中查看告警发送消息记录。
    * 告警事件中的 SQLID 支持链接到诊断页面。
  * 告警规则
    * 支持对更多的日志类型进行关键字告警，如 OceanBase 日志、OBProxy 日志、主机日志。
    * 默认告警规则配置支持调整告警对象。
  * 告警通道
    * 钉钉 & 企业微信告警通道支持配置提醒（@）群内指定用户。
    * 告警通道配置支持配置不同语言的告警消息模版，推送告警消息时支持选择指定语言推送。
    * 告警通道支持配置 json 类型的告警消息格式。
  * 告警推送
    * 调整原 **告警订阅** 功能为 **告警推送**，支持按告警分组或告警模版推送告警信息，告警分组推送支持指定告警对象。
    * 配置告警推送时选择是否接收告警恢复通知。
  * 其他
    * 告警对象选择支持反向过滤规则，即对全部告警对象中某些具体对象不生效。

### 巡检

为了更加便利地使用巡检功能，对所管理的资源风险有准确的把握，OCP V4.0.1 版本重新设计了巡检功能，将原有健康检查及巡检能力进行合并，并根据调研反馈补充了大量巡检规则。从巡检对象的维度出发，支持不同场景的巡检功能。

* **巡检对象**：巡检操作以对象为第一入口，操作更加简单清晰。
  * 支持为每个 OceanBase 集群、租户、OBProxy 集群对象定义巡检项。
  * 支持指定单个对象发起巡检，也支持对所有对象发起巡检。
* **巡检场景**：预设了三种巡检场景，为不同场景匹配不同的巡检项。
  * 基础巡检：对 OCP 管理的资源基本健康检查，适用于日常巡检工作。
  * 性能巡检：对 OCP 管理的资源性能抖动、异常检查，适用于性能分析工作。
  * 深度巡检：对 OCP 管理的资源进行深度检查，发现隐藏风险，适用于业务洪峰前巡检工作。
* **调度规则**：每个对象及对应巡检场景都支持不同的调度规则。
  * 支持日、周、月三个维度的调度周期配置。
* **巡检报告**：每一次巡检任务都会生成详细巡检报告供您分析。
  * 巡检报告根据巡检项规则设置，检查并突出展示低、中、高风险项。
  * 巡检报告支持在线查看及下载到本地。

![6](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/401/%E5%B7%A1%E6%A3%80.png)

## 功能优化

### 集群管理

* 创建集群时支持自定义 SQL 端口、RPC 端口。
* 创建 V2.2.77 版本集群时新增推荐参数模版。
* 创建集群时增加 io_bench 结果检查（16KB IO 块 IOPS 小于 1000 抛出异常）。
* 集群支持 Zone 级别异构部署，即支持 x86、ARM 混合部署。
* 新增 **重装** OBServer 节点的运维功能，支持原地重装 OBServer 节点。
* **替换** OBServer 节点运维管理功能支持跳过离线主机清理操作。
* **替换**、**添加** OBServer 节点时新增仅可选择相同机房的提示。
* 集群列表支持批量查询集群名称。
* 集群列表主备集群展示方式调整为平铺展示。
* 集群参数管理支持查看 **已修改** 参数，支持筛选 **是否只读** 参数。

### 租户管理

* 创建及管理租户时，选择 Unit 时增加最低可使用资源规格提示。
* 新增创建租户时，Zone 之间 Unit 规格及数量不一致时增加风险提示。
* 去除租户 Unit 管理中的超卖概念，不再需要设置 CPU、内存 min 及 max 值。
* 租户列表支持批量查询租户名称。
* 租户管理列表页新增 **租户 ID** 列。
* 租户参数管理支持查看 **已修改** 参数，并支持筛选 **是否只读** 参数。
* 修复创建 MySQL 租户无法设置 `lower_case_table_names` 参数的问题。

### 主机管理

* 主机列表支持批量查询主机 IP，支持筛选主机类型、机房、所属服务。
* 主机信息支持展示 CPU 芯片名称、CPU 核数、内存总数。
* 添加主机默认开启时钟偏移检查。

### OBProxy

* OBProxy 集群支持指定 Proxyro 密码。
* OBProxy 集群列表新增状态列，展示集群状态。
* 放开 OBProxy 集群硬件架构不一致不允许升级的限制。
* 新增 **请求分析** 菜单，支持统计集群、租户、客户端请求统计次数。
* 部署 OBProxy 时默认配置最佳实践参数。

### 监控

* 调整 OCP 监控默认采集频率，由 1s 调整至 5s。
* 修改租户 **CPU 使用率** 图表文案为 **租户 CPU 消耗**。
* 主机监控新增 IO 使用率和 IO 队列长度图表，CPU 使用率新增 system、user、iowait 维度监控。

### 其他

* OCP 支持 HTTPS 认证协议，满足等保三级要求。
* 任务列表新增 **发起者** 筛选，并支持根据 **任务名称** 进行搜索。
* OCP 系统参数管理列表新增 **是否重启生效** 列。
* 支持自定义 Agent 安装目录（参数：`ocp.agent.home.path.prefix`）。
* 性能报告支持调整 TopN 配置（参数：`ocp.perf.workload.report.tenant-top-sql-limit`）。
* 性能报告支持开启、关闭自动快照能力，支持对指定集群生成快照（参数：`ocp.perf.snapshot.generation.enable`、`ocp.perf.snapshot.generation.white-list`）。

## 修复的问题

OCP V4.0.1 版本修复了以下问题：

1. 修复某些场景下 OCP 从旧版本升级到 V3.3.3 版本时，租户白名单同步失败的问题。

2. 修复 OCP 告警中，io_util 和 io_qusize 指标单位有误的问题。

3. 修复某些情况下 RS 发生变更后，OCP 仍由原来的 RS 执行升级脚本的问题。

4. 修复集群资源管理中，副本视图的手动刷新和自动刷新调用的不是同一个接口的问题。

5. 修复 SlowSQL 的 Trace 详情在绑定 Schema 索引后，报服务器错误 “Error writing JSON output” 的问题。

6. 修复 Antman 部署 OCP 时，密码箱存储的 Meta 集群的 proxyro@sys 密码有误的问题。

7. 修复了通过 ssh 启动的 agent 由于继承的 PATH 目录过少，导致装机模板找不到 `sysctl` 命令的问题。

8. 修复了 OBProxy 集群某些情况下会被永久锁定无法运维的问题。

9. 修复了当 OCP 上传了目标版本的 debuginfo 包时找不到升级路径的问题。

## 已知问题

| 编号 | 已知问题      | 规避方法   |
|----|---------|---------------|
| 1  | 租户被删除后，该租户的备份信息无法展示 | 暂无。 |
| 2  | 在空 OBProxy 集群下，无法添加 4.0.0 版本的 OBProxy server      | 在创建 4.0.0 版本的 OBProxy 集群时，同步添加 OBProxy server。   |

## 版本使用限制

### 硬件要求

OCP-Server 可以安装在物理机上，也支持安装运行在 Docker 容器中。OCP-Server 支持多节点高可用部署模式。

OCP-Server 节点最低硬件要求如下表所示。

| 硬件  | 要求                                 |
|-----|------------------------------------|
| CPU | <li>X86_64，8 核</li><li>ARM aarch 64 架构，8 核</li> |
| 内存  | 可用内存 16 GB                         |
| 网卡  | 万兆网卡                               |

OCP-Agent 自身占用资源很少，对安装节点硬件资源没有特别要求。

### 操作系统要求

安装 OCP 服务端（含 OCP-Agent）的操作系统要求如下表所示。

| 服务器类型       | 操作系统       | 支持版本      |
|-------------|------------|-----------|
| x86_64      | RHEL       | 7.2 及以上版本 |
| x86_64      | CentOS     | 7.2 及以上版本 |
| x86_64      | AliOS      | 7.2 及以上版本 |
| x86_64      | openSUSE   | 12SP3 及以上 |
| ARM aarch64 | AliOS      | 7.2 及以上版本 |
| ARM aarch64 | 中标麒麟       | 7.6       |
| ARM aarch64 | 华为 EulerOS | 2.0 SP8   |
| x86_64 | Debian       |   Debian GNU/Linux 11 (bullseye)    |
| x86_64 | Ubuntu |  Ubuntu 18.04.6 LTS  |

### 客户端要求

一般用户会通过 Web 浏览器来访问 OCP 服务，故对客户端的要求如下所示。

| 浏览器     | 最小版本 |
|---------|------|
| Chrome  | 81   |
| Firefox | 64   |
| Safari  | 10   |
| Edge    | 13   |

如果您需要通过 iOS 操作系统的设备来访问 OCP，版本要求如下表所示。

| 操作系统 | 最小版本 |
|------|------|
| iOS  | 10   |

为了具备最佳的使用体验，推荐使用分辨率大于 1440 x 810 的显示器。
