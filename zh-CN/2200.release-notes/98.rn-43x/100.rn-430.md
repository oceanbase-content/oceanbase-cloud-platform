# OCP V4.3.0

## V4.3.0 BP2

### 版本信息

* **版本号：** V4.3.0 BP2

* **前置版本：** V4.3.0 BP1

* **版本发布日期：** 2024 年 7 月 12 日

### 核心改动

* 优化管控大规模集群场景下（1000+ 台主机）OCP 的性能。

* 对 OBProxy 部分版本间升级失败的问题进行兼容处理，以确保升级成功。但目前仍有遗留风险，用户在升级 OBProxy 前需与技术支持人员确认版本间的兼容性。

### 缺陷修复

* 修复了 OBProxy 升级后热重启失败的问题。

* 修复了多集群模式下的告警问题。

* 优化大规模场景下 OCP 的性能表现。

## V4.3.0 BP1

### 版本信息

* **版本号：** V4.3.0 BP1

* **前置版本：** V4.3.0

* **版本发布日期：** 2024 年 6 月 14 日

### 产品优化

* **集群管理**

  优化单机场景下的提示语：单机（集中式架构）仅有一份数据副本，当发生存储或者硬件故障时可能存在数据丢失风险，建议您对于重要业务系统进行定期备份或者配置高可用方案，如租户主备库，多副本容灾等方式避免单点故障。

* **集群管理**

  当 OceanBase 版本为 V4.2.1.7 及以上版本时（不包含 V4.2.2、V4.2.3、V4.3.0），SLOG 日志与日志盘共用存储空间（建议为 SLOG 保留 4GiB 存储空间）。

* **告警中心**

  租户日志盘使用率告警阈值调整为 85%（原值为：95%）。

### 缺陷修复

* 修复了 OCP V4.3.0 对已开启日志备份状态的 V3.x 集群执行立即备份时会备份失败的问题。

* 修复了使用 OceanBase V1.4.79 版本作为 MetaDB 会导致 OCP 升级失败的问题。

* 修复了 V3.1.x 之前版本的 OCP 升级到 V4.x 后，可能导致自愈告警无法触发的问题。

## V4.3.0

OCP V4.3.0 正式支持 OceanBase V4.3.0 版本。本版本提供 **信息采集** 以及 **预案管理** 两项重磅能力，用于辅助用户进行异常场景的信息收集和自动化处理，在提高用户的故障诊断效率的同时，提升用户业务的连续性和稳定性。

此外，本版本支持 CPU 超卖功能，用户可以根据业务属性进行 CPU 的合理配置，进而最大限度地提升资源利用率。并提供基于 3A Timemodel 更细粒度的等待事件类型的监控指标，可以协助用户更高效地分析与解决系统问题。与此同时，OCP V4.3.0 在基础运维、监控告警、备份恢复、第三方集成等方面进行 20+ 项优化和增强，着重提升产品易用性、稳定性以及开放性，构建完善的全生命周期数据库管理平台，协助用户更简单、高效地管理 OceanBase 数据库。

### 版本信息

* **版本号：** V4.3.0

* **前置版本：** V4.2.2 BP2

* **版本发布日期：** 2024 年 5 月 24 日

* **支持的升级路径：**

  * 目前仅支持从 OCP V3.2.4 及之后版本直接升级到当前版本。

  * 对于 OCP V2.3.x 及之后、V3.2.4 之前的版本，需先升级至 OCP V3.3.4 版本。

  * 对于 OCP V2.3.0 之前版本，需先升级至 OCP V2.3.x 版本，再升级到 OCP V3.3.4 版本。

### 支持的 OceanBase 数据库版本

OCP V4.3.0 版本支持下表所列版本的 OceanBase 数据库。

* OceanBase V1.4.x

* OceanBase V2.1.x

* OceanBase V2.2.x

* OceanBase V3.1.x

* OceanBase V3.2.x

* OceanBase V4.x

### 产品新特性

#### OceanBase V4.x 功能适配

* 实现 OCP 多集群模式支持租户级别主备库，完善 OceanBase 容灾解决方案。
* 适配集群级别及租户级别参数模板 `Complex_OLTP`、`Express_OLTP`、`OLAP`、`HTAP`、`OBKV`，从业务模型角度出发，简化集群及租户参数设置，实现数据库 “开箱即用”，降低用户配置成本。
* 适配 OBProxy Session ID 方案，解决分布式场景下无法定位具体 Session 的问题，实现支持外部应用 Kill Session 能力。
* 实现租户级别主备库支持腾讯云存储类型 `COS` 。

#### CPU 超卖

在通常情况下，如果集群内不同的租户因为业务属性存在错峰现象，如 `业务 A` 在早上 9:00~11:00 期间比较繁忙，`业务 B` 在此期间基本负载较低；而 `业务 A` 在下午 13:00~16:00 期间负载较低，`业务 B` 在此期间业务比较繁忙，因此用户可以通过梳理租户业务类型以及高峰低谷时间，通过合理地配置集群和租户规格，在保障业务稳定运行的同时提升集群资源利用率，进而达到降本增效的目标。

### 功能提升

#### 基础运维

* **仲裁服务管理**

    创建仲裁服务支持设置日志相关参数 `enable_syslog_recycle=true` 以及 `max_syslog_file_count=100`，避免因日志记录造成工作目录打满进而造成仲裁服务异常的问题。

* **OBProxy 管理**

    删除 OBProxy 集群时支持自动跳过不可访问的主机，提升删除集群任务成功率。

#### 告警中心

* 细化告警自动消除逻辑，同时支持用户设置告警是否自动消除，提升用户对于告警的自主处理能力。
* 新增 Memstore 已冻结但未释放的内存的告警能力。
* **告警管理 > 告警通道** 内支持设置告警恢复消息模板。
* 新增 60+ OceanBase 日志告警，帮助用户及时发现系统异常。
* 去除 OCP 内的文档登录鉴权能力，支持用户在外部系统如邮件、钉钉等在无需登录 OCP 的情况下查看告警所对应的处理文档。

#### 性能监控

* 结合 3A Timemodel 新增多个等待事件的监控图表，如 **DB Time**、**前台工作负载**、**后台工作负载**、**SQL 执行事件** 等，帮助用户更细粒度分析系统瓶颈，增强 OceanBase 数据库的可观测性。
* 创建图表时支持图表拆分展示，实现用户批量创建图表的诉求。

#### 软件包管理

OCP 适配具有 `nolse` 标记的 OceanBase RPM 软件包，主要解决 ARM 架构下 Large System Extensions (LSE) 扩展指令功能识别的问题。

#### Open API

* 备份恢复开放 Open API，如支持设置 piece 间隔、预览恢复任务，并支持通过 `add restore source` 方式进行恢复。
* 租户管理开放租户与 OBServer 对应关系的 Open API。

### 产品优化

* **集群管理**

  * **集群** 页面支持展示 **仲裁服务** 页签以及 **参数模板** 页签。
  * 创建集群时增加 CPU、内存、数据盘以及日志盘的参数说明，解决新用户对于磁盘使用率默认使用 90% 的疑惑。
  * Config URL 支持服务缓存能力，解决多云/跨云部署时 MetaDB 服务不可用场景，进一步提升 OCP 服务的可用性。
  * 集群升级时版本提示 OceanBase V4.2.1 以及以上版本与 OCI Lib 的版本对应关系，避免造成集群异常 Crash 问题。
  * 替换 OBServer 时前置展示同地域同机房同机型的主机，节省用户在大规模运维场景下主机查询时间。

* **租户管理**
  
  * **租户** 页面支持展示 **Unit 规格** 页签以及 **参数模板** 页签。
  * 租户扩缩容 & Unit 迁移场景中提示用户修改 `ha_high_thread_score`/`ha_mid_thread_score` 参数或者对于后台任务进行资源隔离，避免由分区副本迁移而引起的突发流量造成业务影响。
  * 优化租户删除提示 “OCP 将删除其所拥有资源池以及租户数据，被删除的租户不会进入回收站”。
  * sys 租户下支持展示监控用户 `ocp_monitor` 且支持对本用户默认开启资源隔离，最大限度降低系统监控对正常业务的影响。

* **主机管理**

  * **主机列表** 页支持展示主机名、机型、机房以及地域等关键信息。
  * 优化添加主机提示语 “支持输入多个 IP 地址”。

* **告警中心**

  * **告警管理 > 告警事件** 中，活跃告警和历史告警的告警说明中增加集群、服务器以及生成时间等关键信息。
  * **告警规则** 页面增加编辑操作，提高用户变更操作效率。
  * 告警消息聚合支持集群和告警项两种维度，解决不同集群的同一告警聚合导致告警联系人不匹配的问题。

* **备份恢复**

  * 停止日志备份时增加提示语 “若已开启备份策略，如需永久关闭日志备份，请同时关闭或者停止备份策略”。
  * OceanBase 集群版本大于等于 V2.2.52 时启用日志归档的时候默认开启 piece 机制（默认值：1 天）。

* **任务管理**

  警告类型子任务支持手动重试。

* **凭据管理**

  在导入凭据和编辑凭据时实现凭据名长度一致性处理。

* OCP 支持对接外部时序库 Prometheus，用于存储监控视图数据。

### 产品行为变更

* **集群管理**

    当 cgroup 目录不存在且 OceanBase 集群版本大于等于 V4.0 时，接管 OBServer 时系统默认创建 cgroup 目录。

* **租户管理**

    **租户 > 资源管理 > 资源使用趋势** 增加 **租户 CPU 消耗** 监控指标项。

### 关键特性解读

#### CPU 超卖

CPU 超卖机制是指 OceanBase 集群允许分配给租户的资源总量超过实际可用的物理资源。当创建集群时，用户可以指定集群的 CPU 超卖比例（最大值：200%），用户在创建 Unit 时指定 CPU 的最大值以及最小值。另外，OCP 支持用户在线关闭超卖、调整超卖比例等功能，帮助用户根据实际业务情况进行集群管理。

CPU 超卖的典型应用场景包括：

1. 业务整合：用户可以将有波峰波谷的业务放入同一集群，比如白天做交易类型的业务以及晚上跑批或者分析的业务进行混合部署，业务混部可以充分利用整个集群的资源。

2. 抗突发流量：如果单个业务存在突发流量且本业务对组织较重要，本租户可以利用超卖机制秒级抢占其他租户的资源，保障业务能够稳定运行。

<main id="notice" type='explain'>
<h4>说明</h4>
仅 OceanBase 4.0 及以上版本且集群开启 cgroup 才可使用 CPU 超卖功能。
</main>

#### 预案管理

预案管理是指对 OceanBase 数据库可能发生的突发事件、危机制定并实施一系列应急预案的过程。预案管理旨在提前建立故障应对方案，用户可以更好地应对突发事件、危机，减少损失并保障数据库稳定运行，以降低潜在风险对用户业务造成的影响，提高 OceanBase 数据库的整体应急能力。

当前预案管理模块包含 2 个模块:

1. 预案：本模块提供 11 个预案，包括自动拉起 OBServer、扩容租户 CPU/内存以及刷新单条 SQL 的 PlanCache 等。支持用户以业务场景以及租户资源使用等实际情况进行模板定制化，如扩容方案以及是否自动执行预案等。

2. 预案执行：本模块提供预案执行信息、回滚方案或对应的 SQL 详情等，同时对关闭自动启用的模板，支持用户手动执行。预案管理可以帮助用户建立 OceanBase 数据库的应急管理机制和运维规范，为业务连续性、稳定性提供更智能化的保障。

### 修复的问题

OCP V4.3.0 版本主要修复了如下问题：

* 修复了执行升级 OceanBase 集群前勾选转储无效的问题。
* 修复了并发事务较多时 OAS 事务数据采集不全的问题。
* 修复了日志盘资源显示比例不正常的问题。
* 修复了自治服务概览页中某些类型的 SQL 总数与实际不符的问题。
* 修复了租户 QPS 监控下钻后数据不准的问题。
* 修复了 agent 的内存泄漏问题，该问题会导致 agent 内存使用超出预期。

### 已知问题

| 编号 | 已知问题   | 规避方法  |
|----|---------|---------------|
| 1 | 主备集群拓扑图中，备集群性能数据始终为 0。| 暂无。 |
| 2 | OCP 多集群模式、非 OCP 多集群模式下，OceanBase 集群上存在基于日志归档而创建的备租户，当从 OCP 上迁出 OceanBase 集群后再重新接管进来，原先的主备租户关系将不存在。 | 此场景较为少见，暂无修复计划。 |
| 3 | 集群 **租户管理 > 容量使用总览** 中，当租户名较长时图表可能会显示异常。 | 暂无。|
| 4 | 部分 SQL 诊断信息可能存在一些缺失。| 将在后续版本完善。 |

## 版本使用限制

### 硬件要求

OCP-Server 可以安装在物理机上，也支持安装运行在 Docker 容器中。OCP-Server 支持多节点高可用部署模式。

OCP-Server 节点最低硬件要求如下表所示。

| 硬件 | 要求                 |
|-------|------------------------------------|
| CPU  | <li>X86_64，8 核</li><li>ARM aarch 64 架构，8 核</li> |
| 内存 | 可用内存 16 GiB             |
| 网卡 | 万兆网卡                |

OCP-Agent 自身占用资源很少，对安装节点硬件资源没有特别要求。

### 操作系统要求

安装 OCP 服务端（含 OCP-Agent）的操作系统要求如下表所示。

| 服务器类型    | 操作系统    | 支持版本   |
|-------------|------------|-----------|
| x86_64   | RHEL    | 7.2 及以上版本 |
| x86_64   | CentOS   | 7.2 及以上版本 |
| x86_64   | AliOS   | 7.2 及以上版本 |
| x86_64   | openSUSE  | 12SP3 及以上 |
| ARM aarch64 | AliOS   | 7.2 及以上版本 |
| ARM aarch64 | 中标麒麟    | 7.6    |
| ARM aarch64 | 华为 EulerOS | 2.0 SP8  |
| x86_64 | Debian    |  Debian GNU/Linux 11 (bullseye)  |
| x86_64 | Ubuntu | Ubuntu 18.04.6 LTS |

### 客户端要求

一般用户会通过 Web 浏览器来访问 OCP 服务，故对客户端的要求如下所示。

| 浏览器   | 最小版本 |
|---------|------|
| Chrome | 88  |
| Firefox | 78  |
| Safari | 14  |
| Edge  | 88  |

如果您需要通过 iOS 操作系统的设备来访问 OCP，版本要求如下表所示。

| 操作系统 | 最小版本 |
|------|------|
| iOS | 10  |

为了具备最佳的使用体验，推荐使用分辨率大于 1440 x 810 的显示器。
