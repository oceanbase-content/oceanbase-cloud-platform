# OCP V4.0.2

#RNDate#2023-02-06

OCP V4.0.2 版本结合了负载均衡产品，支持业务更好地利用 OceanBase 分布式集群能力，实现连接均衡分布、故障自动切换。

## 版本信息

* **版本号：** V4.0.2

* **前置版本：** V4.0.1

* **版本发布日期：** 2023 年 02 月 06 日

* **支持的升级路径：**

    * 当前仅支持从 OCP V3.2.4 及之后版本直接升级到当前版本。

    * 对于 OCP V2.3.x 及之后、V3.2.4 之前的版本，需先升级至 OCP V3.3.4 版本。

    * 对于 OCP V2.3.0 之前版本，需先升级至 OCP V2.3.x 版本，再升级到 OCP V3.3.4 版本。
    
    <main id="notice" type='notice'>
    <h4>注意</h4>
    <p>MetaDB 为 1479 版本的 OCP，升级至 V4.0.2 版本时可能存在部分表字段无法升级的情况。如您有升级需要，建议先联系技术支持人员。</p>
    </main>

## 支持的 OceanBase 数据库版本

OCP V4.0.2 版本支持下表所列版本的 OceanBase 数据库。

* OceanBase V1.4.x

* OceanBase V2.1.x

* OceanBase V2.2.x

* OceanBase V3.1.x

* OceanBase V3.2.x

* OceanBase V4.x

## 新增功能

* OBProxy 集群支持对接负载均衡产品 OBLB、SLB（仅阿里专有云），实现配置自动同步、自动更新。

* 支持客户端（如 JDBC）获取 OBProxy 集群及相关配置，以 **应用** 的维度实现负载均衡能力。

* 实现 AK/SK 管理，用户可以选择通过 AccessKey 认证方式调用 OCP API 接口。

## 功能优化

* 优化 OBProxy 集群管理，避免集群下出现 OBProxy 节点端口不一致的问题。

* 新增内置告警项：

  * `ocp_meta_db_disconnected`：支持对 OCP 的 MetaDB、MonitorDB 进行断连检测及告警。

  * `ocp_http_request_timeout`：支持对 OCP 接口请求超时进行检测及告警。

  * `ocp_http_request_too_many_errors_occur`：支持对 OCP 接口请求出错进行检测及告警。

  * `ocp_alarm_detect_timeout`：支持对 OCP 告警规则的检测超时进行检测及告警。

  * `ob_server_stopped`：支持对 OceanBase 服务器停止服务进行检测及告警。

* 优化告警导出功能，告警规则支持导出详情字段，同时支持导出告警模版。

* 支持事件类告警添加到告警模板。

* 增加系统参数 `ocp.alarm.event.resend-interval-seconds`，调整告警发送间隔，默认 1 分钟产生一次告警，通过调大参数来降低告警发送频率。

* 告警恢复策略优化：

  * 阈值检测类告警：如 `xxx_count > 1` 的告警，需要明确检测到  `xxx_count <=1` 时且时长超过其恢复周期才自动恢复告警；如果是监控丢失，告警不会自动恢复。

  * 非阈值检测类告警：其恢复仍遵循恢复周期。

* 告警检测逻辑优化：

  * 优化告警检测，降低告警延迟。告警的默认检测周期与其数据的采集周期相匹配，对于 1 min 采集一次的监控，告警最大延迟范围约为 70 s ~ 130 s；对于 1 s 采集一次的监控，告警最大延迟范围约为 20 s。

  * 支持用户自主调整告警检测周期，周期越小告警延迟越低，理论延迟为 **检测周期 + 数据采集周期 + 10 s**（实时监控的偏移量，为避免实时数据不准，可以通过系统参数 `ocp.alarm.query.metric-offset-seconds` 调整）。

* 优化备份逻辑，备份前检查集群是否处于升级状态，避免发生备份失败。

* 优化备份恢复功能，**数据备份任务** 和 **恢复任务** 新增进度展示条。

* 优化诊断结果展示，信息滚动时固定关键信息列（SQL 文本、诊断结果）。

## 修复的问题

OCP V4.0.2 版本修复了以下问题：

1. 修复了某些情况下 OceanBase 集群添加 OBServer 节点可能失败的问题。

2. 修复删除集群后进入 **总览** 页面，页面会有错误提示的问题。

3. 修复 **诊断中心 > 高危 SQL** 中漏诊断 **影响行数过大** SQL 的问题。

4. 修复了 **全链路诊断** 中查不到数据的问题。

5. 修复 **诊断中心** 中集群存储使用率前端展示有误的问题。

6. 修复 OCP V3.x 升级到 OCP V4.x 后自定义告警无法触发的问题。

7. 修复 OCP agent 进程不存在时无法产生 **主机不可用** 告警的问题。

8. 优化若干前端信息展示不全的问题。

## 已知问题

| 编号 | 已知问题      | 规避方法   |
|----|---------|---------------|
| 1  | OCP 多集群模式下，主 OceanBase 集群（ocp1）修改了租户密码或 proxyro 密码后，备 OceanBase 集群（ocp2） 的密码箱未进行同步，导致重启集群后集群无法连接。 | 暂无。 |
| 2  | 多集群模式下，初始化时未设置多 AZ 参数，后续设置多 AZ 启动参数无效。      | 暂无。   |
| 3  | OBProxy 集群在关联了多个 OBLB 后，无法继续增加 OBProxy 节点。      | 若一套 OBLB 服务存在多个节点，当添加 OBLB 类型的负载均衡时，请选择其中一个 OBLB 节点作为访问入口，不可重复添加同一套 OBLB 服务的不同节点。   |

## 版本使用限制

### 硬件要求

OCP-Server 可以安装在物理机上，也支持安装运行在 Docker 容器中。OCP-Server 支持多节点高可用部署模式。

OCP-Server 节点最低硬件要求如下表所示。

| 硬件  | 要求                                 |
|-----|------------------------------------|
| CPU | <li>X86_64，8 核</li><li>ARM aarch 64 架构，8 核</li> |
| 内存  | 可用内存 16 GB                         |
| 网卡  | 万兆网卡                               |

OCP-Agent 自身占用资源很少，对安装节点硬件资源没有特别要求。

### 操作系统要求

安装 OCP 服务端（含 OCP-Agent）的操作系统要求如下表所示。

| 服务器类型       | 操作系统       | 支持版本      |
|-------------|------------|-----------|
| x86_64      | RHEL       | 7.2 及以上版本 |
| x86_64      | CentOS     | 7.2 及以上版本 |
| x86_64      | AliOS      | 7.2 及以上版本 |
| x86_64      | openSUSE   | 12SP3 及以上 |
| ARM aarch64 | AliOS      | 7.2 及以上版本 |
| ARM aarch64 | 中标麒麟       | 7.6       |
| ARM aarch64 | 华为 EulerOS | 2.0 SP8   |
| x86_64 | Debian       |   Debian GNU/Linux 11 (bullseye)    |
| x86_64 | Ubuntu |  Ubuntu 18.04.6 LTS  |

### 客户端要求

一般用户会通过 Web 浏览器来访问 OCP 服务，故对客户端的要求如下所示。

| 浏览器     | 最小版本 |
|---------|------|
| Chrome  | 81   |
| Firefox | 64   |
| Safari  | 10   |
| Edge    | 13   |

如果您需要通过 iOS 操作系统的设备来访问 OCP，版本要求如下表所示。

| 操作系统 | 最小版本 |
|------|------|
| iOS  | 10   |

为了具备最佳的使用体验，推荐使用分辨率大于 1440 x 810 的显示器。
