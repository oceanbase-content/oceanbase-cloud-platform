# 监控查询对接外部时序系统

从 OCP V4.3.0 开始，监控查询支持对接到用户已有的时序系统，如 Prometheus、SLS metricStore，释放 ocp-server 采集计算监控数据的压力，提高查询接口吞吐量。通过简单配置目标地址、鉴权等信息后即可快速使用。

## 前提条件

* 您已通过 Agent Remote push 或者 Pushgateway 等方案采集到 Agent 监控时序数据。

* 从 OCP 容器到对应时序系统的网络已打通。

## 对接 Prometheus

Prometheus 相关配置都在 `meta` 租户的 `config_properties` 表中，相关配置说明如下：

| key  |  是否内置  |  是否必填  |  是否重启生效  |  说明  |
|------|------------|------------|---------------|--------|
|  `ocp.monitor.metric.service.type`  |  是  |  是  |  是   |  监控查询数据源类型，默认为 `LOCAL`，代表 MonitorDB，此处需要配置为 PROMETHEUS（大小写均可）。  |
|  `ocp.monitor.metric.collect.service.type`  |  是  |  是  |  是   |  监控采集类型，默认为 `LOCAL`，代表会单独往 MonitorDB 写一份数据用于灰度。若不希望往 MonitorDB 写数据，此处需要配置为 PROMETHEUS（大小写均可）。  |
|  `ocp.monitor.query.prometheus.address`  |  否  |  是  |  是   |  Prometheus 服务部署地址，如：`127.0.0.1`。 |
|  `ocp.monitor.query.prometheus.port`  |  否  |  是  |  是  |  Prometheus 服务端口，如：`9090`。  |
|  `ocp.monitor.query.prometheus.authentication.username`  |  否  |  否  |  是  |  Http 请求 Prometheus query API 的鉴权用户名，若未设置可以不填。  |
|  `ocp.monitor.query.prometheus.authentication.password`  |  否  |  否  |  是  |  Http 请求 Prometheus query API 的鉴权密码，若未设置可以不填。  |
|  `ocp.monitor.query.prometheus.connect.timeout`  |  否  |  否  |  是  |  Http 请求 Prometheus query API 建立 Socket 连接超时时间，单位为 ms，默认值为 3000ms。  |
|  `ocp.monitor.query.prometheus.read.timeout`  |  否  |  否  |  是  |  Http 请求 Prometheus query API 等待响应超时时间，单位为 ms，默认值为 3000ms。  |

由于上述的非内置指标未配置在 `config_properties` 表中，您在系统参数中将无法对其进行查看和设置，此时需要您在初次使用时通过如下 SQL 黑屏插入一条记录。

以 `ocp.monitor.query.prometheus.address` 为例：

```sql
INSERT INTO `config_properties` (`key`, `value`, `need_restart`, `description`) VALUES ('ocp.monitor.query.prometheus.address1', '127.0.0.1', 1, 'prometheus 服务部署地址');
```

确保所有配置更新后，重启 OCP，可以看到 OCP 的白屏监控、告警等使用监控查询的数据源均已被替换为对应的 Prometheus 服务。

## 对接 SLS

SLS 相关配置和 Prometheus 相似，说明如下：

|  key  |  是否内置  |  是否必填  |  是否重启生效  |  说明  |
|-------|------------|-----------|---------------|----------|
|  `ocp.monitor.metric.service.type`  |  是  |  是  |  是  |  监控查询数据源类型，默认为 `LOCAL`，代表 MonitorDB，此处需要配置为 SLS（大小写均可）。  |
|  `ocp.monitor.metric.collect.service.type`  |  是  |  是  |  是   |  监控采集类型，默认为 `LOCAL`，代表会单独往 MonitorDB 写一份数据用于灰度。若不希望往 MonitorDB 写数据，此处需要配置为 SLS（大小写均可）。  |
|  `ocp.monitor.query.sls.end-point`  |  否  |  是  |  是  |  SLS 服务接入点。  |
|  `ocp.monitor.query.sls.sls-project` |  否  |  是  |  是  |  SLS 项目空间。  |
|  `ocp.monitor.query.sls.sls-metricstore`  |  否  |  是  |  是  |  SLS 的 MetricStore。  |
|  `ocp.monitor.query.sls.access-key`  |  否  |  是  |  是  |  SLS 的 AccessKey ID。  |
|  `ocp.monitor.query.sls.access-secret`  |  否  |  是  |  是  |  SLS 的 AccessKey Secret。  |
|  `ocp.monitor.query.sls.connect.timeout`  |  否  |  否  |  是  |  Http 请求 SLS query API 建立 Socket 连接超时时间，单位为 ms，默认值为 3000ms。  |
|  `ocp.monitor.query.sls.read.timeout`  |  否  |  否  |  是  |  Http 请求 SLS query API 等待响应超时时间，单位为 ms，默认值为 3000ms。  |

和 Prometheus 配置一样，由于非内置指标默认未配置在 `config_properties` 表中，因此在系统参数中无法查看和设置这些指标，此时需要在初次使用时通过如下 SQL 黑屏插入一条记录。

以 `ocp.monitor.query.sls.sls-metricstore` 为例：

```sql
INSERT INTO `config_properties` (`key`, `value`, `need_restart`, `description`) VALUES ('ocp.monitor.query.sls.sls-metricstore', 'ob_metricstore', 1, 'SLS metricStore');
```

确保所有配置更新后，重启 OCP，可以看到 OCP 的白屏监控、告警等使用监控查询的数据源均已被替换为对应的 SLS 服务。
