# 概述

Binlog 服务是用于收集 OceanBase 的事务日志并转换为 MySQL Binlog 的服务，主要用于实时数据订阅等场景。OCP 支持白屏化单机部署或集群模式部署 Binlog Service，并可对 Binlog 集群及实例进行基础的运维操作。同时，OCP 支持 Binlog Service 的监控告警能力，为您提供 Binlog 集群的资源使用视图，并支持关联至告警，帮助您快速定位并解决问题。

<main id="notice" type='notice'>
<h4>功能适用性</h4>
<p>该内容仅适用于 OCP 企业版，OCP 社区版不支持此功能。</p>
</main>

## 背景信息

在 MySQL 中，Binlog 作为实现数据订阅的起点，用户可以以较低的性能硬性和消耗来开启 Binlog 日志，从而实现诸多的下游业务场景。

OceanBase Binlog Service 是为兼容 MySQL Binlog 能力而推出的功能，支持客户复用现有的 MySQL Binlog 增量解析系统来同步 OceanBase MySQL 模式的增量数据，无需做二次开发或搭建一套新环境。Binlog Service 与 MySQL Binlog V4 版本协议保持对齐，具备同样的功能（如支持多个订阅连接）、特性（如支持 GTID 拉取模式），以及保障 Binlog 日志中数据的唯一性。您可以无缝使用原本基于 MySQL 的增量数据订阅方案，并切换到 OceanBase 上来。

<main id="notice" type='notice'>
<h4>注意</h4>
<p>OceanBase 提供的 Binlog 服务暂不适用于主备搭建和增量恢复等场景。</p>
</main>

## 架构介绍

架构图-相石

**Binlog 集群**

Binlog 集群是由一个或多个 Binlog Sever 组成的统一的对外服务，当 Binlog 集群如果有多台 Binlog Server 时，租户 Binlog 服务启动时，将根据负载均衡的逻辑选择合适的 Binlog Server，任意一台 Binlog Server 故障时，将由其他正常的 Binlog Server 接管其 Binlog 服务。。

**Binlog Server**

负责管理节点上的若干 Binlog 实例，并处理 SQL 请求；多个 Binlog Server 间经由 MataDB 实现信息共享。Binlog Server 支持处理多定义的 SQL API，主要对 Binlog 实例进行管理操作。

**OceanBase Binlog 实例**

是租户粒度的 Binlog 实例，负责生成 binlog 日志以及发送 binlog 日志，同时根据 MySQL 协议开启 TCP 监控处理 SQL 请求。一个 OceanBase Binlog 实例可类比于一个 MySQL 实例，同一租户的多个 OceanBase Binlog 实例可类别于 MySQL 主备实例，支持处理 MySQL Binlog 相关的 SQL、协议和变量，例如 `SHOW MASTER STATUS` 等。

## Binlog Service 特性说明

OceanBase MySQL 模式的 Binlog 协议与 MySQL Binlog V4 版本协议基本保持一致，因此其基础特性与 MySQL Binlog 协议相差无几，具体说明如下：

* 仅支持生成 Row-based Replication（RBR）格式的 Binlog 日志。
* 根据 OceanBase MySQL 的租户级别来生成 Binlog 日志。
* 仅支持生成转换记录变更的事件类型而非所有类型，即 Format_desc、Previous_gtids、Rotate、Gtid、Query、Table_map、Write_rows、Update_rows、Delete_rows 事件类型。
* 支持 GTID 模式。
* 支持 Binlog 事件断点续传，保证无重复无丢失。
* 支持将 OceanBase 增量 DDL 转换为 MySQL 原生语法。

## 限制说明

### 性能限制

Binlog 的转换服务的性能受资源配置和 Clog 解析能力的限制。目前，Binlog 支持的 Clog 日志解析最大性能为 25MiB/s。Binlog 每秒转换率（RPS）的上限约为 50,000。如果源业务流量超过这些限制，可能会导致 Binlog 转换服务的延迟增加。

在业务压力可控的情况下，Binlog 转换服务的延迟通常可以维持在 1 秒以内。然而，在特殊情况下，如数据库存在频繁的数据定义语言（DDL）操作或大型事务，无法保证绝对的秒级转换延迟。

### 版本要求

接入 Binlog Service 对各服务版本及租户模式具有以下要求：

* OBServer V3.x 版本要求不低于 V3.2.4.4，V4.x 版本要求不低于 V4.1.0.1。
* OBProxy 版本要求不低于 V4.2.1。
* Binlog Service 版本要求不低于 V4.0.0。
* 仅支持 MySQL 模式的租户。

### SQL 兼容性

由于 OB MySQL 的 DDL 语法与 MySQL DDL 语法存在一定的差异性，即 OB MySQL 有部分特有的拓展语法，这部分 DDL 语法可能无法解析。

### 数据类型

由于 OB MySQL 与 MySQL 对数据类型在精度、实现方式存在一些差异，因此并非完全地兼容所有数据类型。不兼容的数据类型性说明如下：

* 不支持 OB MySQL 内部对 ENUM、SET 类型的拓展语义实现。例如，SET 类型定义数超过 64 个、支持重复、ENUM 支持插入未定义数据（比如 ''）等。

* 不支持 VARCHAR（n > 65535）类型。

* 对 LONGBLOB 和 LONGTXT 类型最大支持 48 MiB。

* MEDIUMBLOB、LONGBLOB、BLOB、MEDIUMTEXT、LONGTEXT、TEXT、JSON 和 GIS 数据类型底层均有 LOB 类型进行存储，默认大于 4KiB 时会在行外存储，存在与 MySQL 不兼容：

  * 行外存储 UPDATE 为行内存储的数据，前镜像输出为 NULL，后镜像输出更新后的数据。
  * 对带行外存储 LOB 列的表，更新非 LOB 列，前后镜像均输出为 NULL。
  * DELETE 行外存储 LOB 列，前镜像输出为 NULL。

    <main id="notice" type='explain'>
    <h4>说明</h4>
    <p>小于 4KiB 的 LOB 列按普通列处理，即实际列数据记录在主表的列上；大于 4KiB 的列值实际存储在 LOB 辅助表内，主表记录该 LOB 列对应的辅助表信息。其中，4KiB 属于默认大小。</p>
    </main>

* OceanBase V4.x 版本后不支持虚拟生成列的输出。

* 不支持 CTAS 场景。

    OceanBase V4.x 在 CTAS 场景下数据无法输出准确的表名，比如 `create table t2 as select * from t1`，包括创建 `t2` 表以及把 `t1` 数据写入 `t2` 表，OceanBase V4.x 目前只能输出 `__ctas_xxxx` 作为临时表名，而不是 `t2` 表名）。

## 下游生态对接现状

### 存量数据同步说明

Binlog Service 只提供增量数据同步服务，但 OB MySQL 的数据同步到下游，可能也会涉及到存量数据的同步。下述对存量同步阶段的一些常见项进行说明：

* 只支持增量快照读的方式。
* 不支持锁表快照表、FLUSH TABLES WITH READ LOCK。
* 支持设置 MySQL 类型 interactive_timeout、warning_count 超时时间参数。
* 支持设置 heart.interval 心跳超时参数。
* 支持并行拉取存量数据，若 MySQL 同步组件具备该能力。

### 下游生态对接工具说明

支持主流的 MySQL Binlog 解析生态工具（例如，flinkcdc、Canal、MaxWell）对接 Binlog Service 服务。
