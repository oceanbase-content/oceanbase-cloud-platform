# 清理主机 Binlog 实例

删除 Binlog Server 后，您可参考本节内容彻底清理主机上的 Binlog 实例。

## 前提条件

* 主机上的 Binlog Server 已经通过 OCP 白屏删除，且该删除任务已经正常执行完毕。
* 主机后续计划下线不再使用，或希望彻底清理主机上的 Binlog 相关内容。
* 主机上存在 Binlog 实例副本，且该 Binlog 实例在后续仍然需要正常使用。您可通过如下两种方式，确认主机上是否存在 Binlog 实例：
  * 方式一：登录 OCP，在 **Binlog 集群概览** > **Binlog 实例列表** 中查看实例信息。
  * 方式二：登录主机并执行 `ps -ef | grep binlog_instance` ，一个 Binlog 实例副本在主机上对应一个 binlog_instance 进程。

## 操作步骤

为更好地帮您理解，下文中称被删除 Binlog Server 所在的主机为 **主机**。

### 步骤一：确认 Binlog 实例副本数

**通过白屏查看**

1. 登录 OCP 。

2. 在左侧导航栏单击 **Binlog 服务** ，系统默认进入 Binlog 的 **集群列表** 页面。

3. 在 **集群列表** 中选择待查看的 Binlog 集群并单击其集群名，进入 **Binlog 集群概览** 页面。

4. 在 **Binlog 实例列表** 区域，查看 Binlog 实例副本数，**节点 IP** 个数即为副本个数。

![副本数](https://obbusiness-private.oss-cn-shanghai.aliyuncs.com/doc/img/ocp/431/%E8%8A%82%E7%82%B9ip.png)

**通过黑屏查看**

登录任意一台主机，执行如下 SQL，确认当前待操作的 Binlog 实例的副本数是否大于 1。如下方所示，租户 `tenant1` 共有 2 个 Binlog 实例记录，说明此时副本数为 2。

```sql
MySQL [(none)]> show binlog instances;
+------------+------------+-----------+----------------+------+------+--------+-------+---------+---------+---------------+-------------+--------------+-----------------+---------------+-------------+-------------+--------------+----------+
| name       | ob_cluster | ob_tenant | ip             | port | zone | region | group | running | state   | obcdc_running | obcdc_state | service_mode | convert_running | convert_delay | convert_rps | convert_eps | convert_iops | odp_addr |
+------------+------------+-----------+----------------+------+------+--------+-------+---------+---------+---------------+-------------+--------------+-----------------+---------------+-------------+-------------+--------------+----------+
| ad6tev7wc6 | ob0709     | tenant1   | xxx.xxx.xxx.xxx  | 8100 |      |        |       | Yes     | Running | Yes           | Running     | enabled      | Yes             |           804 |           1 |           0 |            0 | NULL     |
| c5410cbup4 | ob0709     | tenant1   | xxx.xxx.xxx.xxx | 8100 |      |        |       | Yes     | Running | Yes           | Running     | enabled      | Yes             |           607 |           1 |           0 |            0 | NULL     |
+------------+------------+-----------+----------------+------+------+--------+-------+---------+---------+---------------+-------------+--------------+-----------------+---------------+-------------+-------------+--------------+----------+
2 rows in set (0.12 sec)
```

### 步骤二：创建 Binlog 实例新副本（仅副本数为 1 需要执行此操作）

执行如下 SQL 在其他主机上创建一个新的 Binlog 实例副本：

```sql
CREATE BINLOG INSTANCE `binlog_instance_name` FOR `ob_cluster_name`.`ob_tenant_name` CLUSTER_URL = ?, CLUSTER_USER = ?, CLUSTER_PASSWORD = ?, IP = ?;
```

其中：

* `binlog_instance_name` ：新 Binlog 实例的实例名，需要保证在 Binlog 集群内唯一。
* `ob_cluster_name` ：OceanBase 集群名。
* `ob_tenant_name` ：OceanBase 租户名。
* `CLUSTER_URL` ：填写开通 Binlog 服务的租户所属集群的 config_url，可以在集群概览中进行查看，详情可参考 [查看集群详情](../../../600.cluster-functions/300.manage-a-cluster/200.overview-of-the-cluster-details-page.md)。
* `CLUSTER_USER` ：建议使用 OCP 为租户开通 binlog 服务时创建的 sys 租户下的 cdcro 用户，或其它具备 cdcro 相同权限的用户。
* `CLUSTER_PASSWORD` ：`CLUSTER_USER` 用户的密码。
* `IP` ：新增实例副本的 Binlog Server 地址。

### 步骤三：若主机上的 Binlog 实例为主实例，则进行切主

判断当前主机上的 Binlog 实例是否是主实例：

1. 登录任意一台主机，执行如下 SQL，展示的信息即为主实例信息，实例名在 status 列的 `binlog_instance` 中。可根据实例名称判断当前主机上的 Binlog 实例是否是主实例，主机上的 Binlog 实例名可通过 **步骤一** 的进行查看。

    ```sql
    MySQL [(none)]> SHOW BINLOG STATUS \G
    *************************** 1. row ***************************
    cluster: ob0709
    tenant: tenant1
    status: {"binlog_instance":"ad6tev7wc6","resources_metrics":{"client_id":"/home/admin/binlogservice/run/ad6tev7wc6","fd_count":83,"pid":370592,"cpu_status":{"cpu_count":22,"cpu_used_ratio":0.0009103322518058121},"disk_status":{"disk_total_size_mb":500923,"disk_usage_size_process_mb":0,"disk_used_ratio":0.0,"disk_used_size_mb":32945},"memory_status":{"mem_total_size_mb":178796,"mem_used_ratio":0.005386026576161385,"mem_used_size_mb":963},"network_status":{"network_rx_bytes":25383,"network_wx_bytes":25026}},"binlog_files":[{"binlog_name":"mysql-bin.000001","binlog_size":155}]}
    1 row in set (0.01 sec)
    ```

2. 若当前主机上的 Binlog 实例为主实例，需要执行 `SWITCH MASTER INSTANCE TO new_master_instance_name FOR TENANT cluster_name.tenant_name` 进行切主操作，其中：
  
   * `new_master_instance_name` ：计划切换到新的主实例的实例名。
   * `cluster_name` ：OceanBase 集群名。
   * `tenant_name` ：租户名。

    ```sql
    MySQL [(none)]> SWITCH MASTER INSTANCE TO c5410cbup4 FOR TENANT ob0709.tenant1;
    Query OK, 0 rows affected (0.01 sec)
    ```

### 步骤四：删除主机上的 Binlog 实例副本

执行 `DROP BINLOG INSTANCE instance_name FORCE` 删除主机上的 Binlog 实例副本。

```sql
MySQL [(none)]> DROP BINLOG INSTANCE c5410cbup4 FORCE;
Query OK, 0 rows affected (0.00 sec)
```
