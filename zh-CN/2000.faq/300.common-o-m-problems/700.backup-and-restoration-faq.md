备份恢复常见问题
=============================

本节介绍 OCP 系统备份恢复功能的常见问题。

功能支持
-------------------------

**Q1: OCP 是否适配了 OSS 的备份恢复？**

A: OCP 从 V2.2.x 版本支持基于 OSS 的逻辑备份恢复，从 V2.5.1 支持基于 OSS 的物理备份恢复。

存储配置
-------------------------

**Q1: 备份恢复报存储地址测试失败，什么原因？**

A: admin 用户无 NFS 目录的写权限。

**Q2: OCP 和 3 台 OceanBase 服务器上都已挂载 NFS 文件系统，但 3 台 OceanBase 服务器的存储配置检测失败，可能是什么原因？**

A: 可能这 3 台 OceanBase 服务器上的 `/obbackup` 目录没有写权限。

**Q3: 在全局视图发起恢复，系统提示存储地址测试失败，如何解决？**

A：OCP V2.5.3 及之后版本，在全局视图发起恢复时，会测试存储地址在所选主机上是否有读写权限。建议在所选主机上使用 `ls -l` 命令检查存储目录的读写权限是否有问题，其中：

* rwx 表示文件所属用户可以读，写，执行。

* r-x 表示文件所属用户组可以读，不可以写，可执行。

* r-x 表示其他用户可以读，不可以写，可执行。

备份
-----------------------

**Q1: 使用 OCP 执行全量备份在 `pre-check` 步骤报错 `Cluster compaction needed before full data backup` ，什么原因？**

A: 执行全量备份前必须先执行集群的合并，详见 [执行合并](../../600.cluster-functions/1100.manage-cluster-merge/200.cluster-perform-merge.md) 。

**Q2: 备份任务执行到 `Pre-check before data backup` 时失败，报错 `data backup pre-check failed, full data backup needed before incremental data backup` ，怎么解决？**

A: 增量备份之前必须有一次全量备份。

**Q3: 使用 OCP 发起一次全量数据备份后，结束时间列显示了结束时间，是否就意味着备份已经结束？**

A: 请以该任务 **状态** 列的结果为实际参考。

恢复
-----------------------

**Q1: 可以把全量备份中某个租户数据恢复到同集群中一个已有租户吗？**

A: 可以恢复到同集群，但不可恢复到已存在的租户，恢复过程中会自动新建租户。

**Q2: 恢复任务发起成功，查看到后端资源池已创建，但是租户未创建，为什么？**

A: 因为目标集群没有挂载 NFS 。

**Q3: 物理恢复时，提示 `restore_concurrency 未设置` ，什么原因？**

A: 正常，OceanBase 的参数 restore_concurrency 生效可能延迟，所以 OCP 会报错。如果 **发起恢复** 能提交成功则可忽略该报错。

**Q4: 把 OCP 和 OceanBase 集群都清理后进行恢复，是否需要提前备份 MetaDB 库？**

A: 不需要，直接在新安装的 OCP 上选择备份文件进行恢复。NFS 场景下，需先将备份目录挂载在恢复的目标集群上。

**Q5: 恢复 OceanBase 时，日志报错 `error code [9023]; cannot start log archive backup；` 什么原因？**

A: 针对 9023 错误，应避免重复调度开启日志备份的命令。

巡检
-----------------------

**Q1: V2.2.7x 版本的 OceanBase 集群使用黑屏操作进行备份恢复，使用备份恢复巡检时报错，是为什么？**

A：备份恢复的异常情况没有处理。可以把 ocp_inspect_task 表中备份恢复相关的巡检的 `valid` 字段设置为 `0` 来关闭巡检。
